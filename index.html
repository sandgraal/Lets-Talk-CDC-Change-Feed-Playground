<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="shortcut icon" href="./CDC_logo.png" type="image/x-icon" />
    <title>Lets Talk CDC – Change Feed Playground</title>
    <link rel="stylesheet" href="assets/styles.css" />
  </head>

  <body data-theme="dark">
    <header class="topbar">
      <div class="brand">
        <span class="brand-pill">Lets Talk CDC</span>
        <span class="brand-title">Change Feed Playground</span>
      </div>
      <div class="topbar-actions">
        <button
          id="themeToggle"
          class="theme-toggle"
          type="button"
          aria-pressed="false"
          aria-label="Switch to light theme"
          data-mode="dark"
        >
          <span class="theme-toggle__icon theme-toggle__icon--sun" aria-hidden="true">
            <svg viewBox="0 0 24 24" role="presentation" focusable="false">
              <circle cx="12" cy="12" r="5" />
              <g class="theme-toggle__rays">
                <line x1="12" y1="1.5" x2="12" y2="4" />
                <line x1="12" y1="20" x2="12" y2="22.5" />
                <line x1="4.2" y1="4.2" x2="5.9" y2="5.9" />
                <line x1="18.1" y1="18.1" x2="19.8" y2="19.8" />
                <line x1="1.5" y1="12" x2="4" y2="12" />
                <line x1="20" y1="12" x2="22.5" y2="12" />
                <line x1="4.2" y1="19.8" x2="5.9" y2="18.1" />
                <line x1="18.1" y1="5.9" x2="19.8" y2="4.2" />
              </g>
            </svg>
          </span>
          <span class="theme-toggle__icon theme-toggle__icon--moon" aria-hidden="true">
            <svg viewBox="0 0 24 24" role="presentation" focusable="false">
              <path
                d="M20.2 14.6A8.4 8.4 0 0 1 9.4 3.8 7 7 0 1 0 20.2 14.6Z"
                fill="currentColor"
              />
            </svg>
          </span>
        </button>
        <button id="btnExport" type="button">Export Scenario</button>
        <label class="file">
          <input type="file" id="importFile" accept="application/json" />
          <span>Import Scenario</span>
        </label>
        <div class="topbar-buttons">
          <button id="btnShareLink" type="button" disabled>
            Copy Share Link
          </button>
          <button id="btnReset" class="danger" type="button">Reset</button>
        </div>
      </div>
    </header>

    <main class="layout">
      <section class="hero" id="overview">
        <div class="hero-ambient" aria-hidden="true">
          <span class="orb orb-one"></span>
          <span class="orb orb-two"></span>
          <span class="orb orb-three"></span>
        </div>
        <div class="hero-copy">
          <span class="eyebrow">Plan · Practice · Share</span>
          <h1>Prototype change data capture without leaving the browser.</h1>
          <p class="hero-lead">
            Create a lightweight schema, act on rows, and watch the resulting
            change feed update in real time.
          </p>
        </div>
        <div class="hero-templates" aria-labelledby="pathwaysTitle">
          <div class="hero-pathways">
            <div class="hero-pathways-copy">
              <span class="hero-pathways-eyebrow">Choose your path</span>
              <h3 id="pathwaysTitle">Guided walkthrough or real-world scenarios</h3>
              <p class="hero-pathways-sub">
                Start with the guided walkthrough to experience the full flow, or
                jump straight into curated CDC blueprints.
              </p>
              <p class="hero-pathways-tip">
                Want presets instead? Pick any scenario below to load schema,
                rows, and starting operations instantly.
              </p>
            </div>
            <div class="hero-pathways-card" aria-label="Overview of guided walkthrough steps">
              <span class="hero-pathways-chip">Guided walkthrough</span>
              <p class="hero-pathways-card-lead">We’ll help you:</p>
              <ul class="hero-pathways-list">
                <li>Model a table with clear primary keys.</li>
                <li>Seed realistic rows to operate on.</li>
                <li>
                  Trigger inserts, updates, and deletes to watch the change feed
                  react in real time.
                </li>
              </ul>
              <div class="hero-pathways-note">Takes about a minute end-to-end.</div>
            </div>
          </div>
          <header class="hero-templates-header">
            <div>
              <h3 id="templateTitle">Explore real-world scenarios</h3>
              <p class="hero-templates-sub">
                Load curated CDC blueprints to jumpstart your experiments.
              </p>
            </div>
            <div class="template-filter">
              <input
                type="search"
                id="scenarioFilter"
                placeholder="Filter scenarios"
                aria-label="Filter scenarios"
              />
            </div>
          </header>
          <div class="template-grid" id="templateGallery"></div>
        </div>
      </section>

      <section class="workspace" id="playground">
        <aside class="sidebar" aria-labelledby="learningTitle">
          <h2 id="learningTitle">Learning path</h2>
          <p class="sidebar-intro">
            Work through each step to understand how change data capture
            scenarios are assembled.
          </p>
          <ol class="learning-steps" id="learningSteps">
            <li>
              <button
                type="button"
                class="learning-step"
                data-step="schema"
                data-target="#schema"
              >
                <span class="step-index">1</span>
                <span class="step-body">
                  <span class="step-title">Model your schema</span>
                  <span class="step-detail"
                    >Define columns plus primary keys.</span
                  >
                </span>
                <span class="step-status" aria-live="polite">Pending</span>
              </button>
            </li>
            <li>
              <button
                type="button"
                class="learning-step"
                data-step="rows"
                data-target="#table-state"
              >
                <span class="step-index">2</span>
                <span class="step-body">
                  <span class="step-title">Populate rows</span>
                  <span class="step-detail"
                    >Seed or insert data to operate on.</span
                  >
                </span>
                <span class="step-status" aria-live="polite">Pending</span>
              </button>
            </li>
            <li>
              <button
                type="button"
                class="learning-step"
                data-step="events"
                data-target="#change-feed"
              >
                <span class="step-index">3</span>
                <span class="step-body">
                  <span class="step-title">Inspect events</span>
                  <span class="step-detail"
                    >Trigger operations and review the log.</span
                  >
                </span>
                <span class="step-status" aria-live="polite">Pending</span>
              </button>
            </li>
          </ol>
          <div class="learning-tip" id="learningTip">
            Add at least one column to begin building your scenario.
          </div>
        </aside>

        <div class="workspace-panels">
          <!-- Schema + Row editor -->
          <section class="card step-card" data-step="schema" id="schema">
            <header class="step-card-header">
              <span class="step-badge">Step 1</span>
              <div>
                <h2>Model your schema</h2>
                <p class="card-intro">
                  Add columns, choose types, and mark primary keys so downstream
                  operations know how to locate rows.
                </p>
              </div>
            </header>
            <div class="schema">
              <input id="colName" placeholder="column name (e.g., id)" />
              <select id="colType">
                <option value="string">string</option>
                <option value="number">number</option>
                <option value="boolean">boolean</option>
              </select>
              <label class="checkbox"
                ><input type="checkbox" id="colPK" /> PK</label
              >
              <button id="addCol" type="button">Add Column</button>
            </div>

            <p class="schema-status" id="schemaStatus" aria-live="polite"></p>

            <div class="pill-row" id="schemaPills"></div>

            <div class="step-card-divider"></div>

            <header class="step-card-header">
              <span class="step-badge step-badge-sub">Operate</span>
              <div>
                <h3>Edit row values</h3>
                <p class="card-intro">
                  Provide values for your columns, then choose an operation to
                  emit events.
                </p>
              </div>
            </header>
            <div class="row-editor" id="rowEditor"></div>
            <div class="ops">
              <button id="btnAutofillRow" type="button">
                Autofill sample row
              </button>
              <button id="opInsert" type="button">Insert</button>
              <button id="opUpdate" type="button">Update by PK</button>
              <button id="opDelete" type="button">Delete by PK</button>
            </div>
            <div class="schema-demo-actions" aria-label="Schema walkthrough">
              <h4>Schema walkthrough</h4>
              <p>
                Add and drop a column to see how capture methods react during
                the stream.
              </p>
              <div class="schema-demo-buttons">
                <button id="btnSchemaAdd" type="button">
                  Add priority_flag column
                </button>
                <button id="btnSchemaDrop" type="button">
                  Drop priority_flag column
                </button>
              </div>
            </div>
          </section>

          <!-- Table state -->
          <section class="card step-card" data-step="rows" id="table-state">
            <header class="step-card-header">
              <span class="step-badge">Step 2</span>
              <div>
                <h2>Populate the table</h2>
                <p class="card-intro">
                  Review current rows, seed realistic data, or clear the table
                  to reset.
                </p>
              </div>
            </header>
            <div class="table-shell">
              <div
                class="table-scroll"
                role="region"
                aria-label="Current rows"
                tabindex="0"
              >
                <table id="tbl" class="data-table">
                  <thead></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
            <div class="table-actions">
              <button id="seedRows" type="button">Seed sample rows</button>
              <button id="clearRows" type="button">Clear rows</button>
            </div>
          </section>

          <!-- Change feed -->
          <section class="card step-card" data-step="events" id="change-feed">
            <header class="step-card-header">
              <span class="step-badge">Step 3</span>
              <div>
                <h2>Inspect change events</h2>
                <p class="card-intro">
                  Filter operations, include before-images, and export NDJSON to
                  share scenarios.
                </p>
              </div>
            </header>
            <div class="stream-actions">
              <button id="emitSnapshot" type="button">Emit Snapshot</button>
              <button id="clearEvents" type="button">Clear events</button>
              <label class="checkbox"
                ><input type="checkbox" id="debzWrap" checked /> Debezium-style
                envelope</label
              >
              <label class="checkbox"
                ><input type="checkbox" id="includeBefore" checked /> include
                <code>before</code> on updates/deletes</label
              >
            </div>
            <div class="filter-actions">
              <label class="checkbox"
                ><input type="checkbox" id="filterC" checked /> Inserts</label
              >
              <label class="checkbox"
                ><input type="checkbox" id="filterU" checked /> Updates</label
              >
              <label class="checkbox"
                ><input type="checkbox" id="filterD" checked /> Deletes</label
              >
              <label class="checkbox"
                ><input type="checkbox" id="filterR" checked /> Snapshots</label
              >
              <label class="checkbox"
                ><input type="checkbox" id="filterS" checked /> Schema
                changes</label
              >
            </div>
            <div class="export-actions">
              <button id="btnCopyNdjson" type="button">Copy NDJSON</button>
              <button id="btnDownloadNdjson" type="button">
                Download NDJSON
              </button>
            </div>
            <div
              id="comparatorFeedback"
              class="comparator-feedback"
              hidden
              aria-live="polite"
            ></div>
            <pre id="eventLog" class="log"></pre>
            <section
              class="inspector"
              id="eventInspector"
              aria-labelledby="inspectorTitle"
            >
              <div class="inspector-header">
                <div>
                  <h3 id="inspectorTitle">Event inspector</h3>
                  <p class="inspector-lead">
                    Peek at before/after payloads, diff fields, and replay to
                    the table.
                  </p>
                </div>
                <div
                  class="inspector-controls"
                  role="group"
                  aria-label="Event navigation"
                >
                  <button type="button" id="eventPrev" class="btn-ghost">
                    Previous
                  </button>
                  <button type="button" id="eventNext" class="btn-ghost">
                    Next
                  </button>
                  <button type="button" id="eventReplay">
                    Replay to table
                  </button>
                </div>
              </div>
              <div class="inspector-body">
                <ul
                  class="inspector-list"
                  id="eventList"
                  role="listbox"
                  aria-label="Filtered change events"
                ></ul>
                <div
                  class="inspector-detail"
                  id="eventDetail"
                  aria-live="polite"
                ></div>
              </div>
            </section>
          </section>
        </div>
      </section>

      <section
        class="workspace-panel"
        id="sim-shell-preview"
        aria-labelledby="simShellTitle"
      >
        <div class="section-title-row">
          <div>
            <h2 id="simShellTitle" class="section-title">
              CDC Method Preview (beta)
            </h2>
            <p class="section-lead">
              Load the CDC Method Comparator to see how polling, trigger, and
              log-based capture respond as you run the same operations.
            </p>
          </div>
        </div>
        <div id="simShellRoot">
          <p>Preparing simulator preview…</p>
        </div>
        <div
          id="methodGuidance"
          class="method-guidance"
          aria-live="polite"
        ></div>
      </section>
    </main>

    <footer class="footer">
      <span
        >Built for Appwrite Hacktoberfest · Deployed on
        <strong>Sites</strong></span
      >
    </footer>

    <div
      id="onboardingOverlay"
      class="onboarding"
      role="dialog"
      aria-modal="true"
      aria-labelledby="onboardingTitle"
      hidden
    >
      <div class="onboarding-dialog" tabindex="-1">
        <button
          type="button"
          class="onboarding-close"
          id="onboardingClose"
          aria-label="Close onboarding"
        >
          x
        </button>
        <h2 id="onboardingTitle">Welcome to the CDC Change Feed Playground</h2>
        <p class="onboarding-lead">
          Prototype change stream scenarios from your browser and share them
          with collaborators.
        </p>
        <ol class="onboarding-steps">
          <li>
            <strong>Model</strong> your table: define columns and choose primary
            keys.
          </li>
          <li>
            <strong>Populate</strong> rows: seed realistic data or insert your
            own samples.
          </li>
          <li>
            <strong>Stream</strong> events: fire operations, inspect the
            envelopes, and export NDJSON.
          </li>
        </ol>
        <div class="onboarding-actions">
          <button type="button" id="onboardingStart" class="btn-primary">
            Load the orders template
          </button>
          <div class="onboarding-start">
            <button type="button" id="onboardingDismiss" class="btn-ghost">
              Start from scratch
            </button>
            <label class="checkbox onboarding-secret" for="onboardingEasterEgg">
              <input
                type="checkbox"
                id="onboardingEasterEgg"
                autocomplete="off"
              />
              <span>Include the Scranton schema (shh)</span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <div
      id="scenarioPreviewModal"
      class="preview-modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="scenarioPreviewTitle"
      hidden
    >
      <div class="preview-modal__dialog">
        <button
          type="button"
          class="preview-modal__close"
          id="scenarioPreviewClose"
          aria-label="Close scenario preview"
        >
          ×
        </button>
        <h3 id="scenarioPreviewTitle"></h3>
        <p
          id="scenarioPreviewDescription"
          class="preview-modal__description"
        ></p>
        <div
          id="scenarioPreviewTags"
          class="preview-modal__tags"
          aria-label="Scenario tags"
        ></div>
        <section>
          <h4>Seed rows</h4>
          <table class="preview-table" id="scenarioPreviewRows"></table>
        </section>
        <section>
          <h4>Change operations</h4>
          <ol class="preview-ops" id="scenarioPreviewOps"></ol>
        </section>
        <div class="preview-modal__actions">
          <button type="button" id="scenarioPreviewLoad" class="btn-primary">
            Load in workspace
          </button>
          <button type="button" id="scenarioPreviewDownload" class="btn-ghost">
            Download JSON
          </button>
        </div>
      </div>
    </div>

    <!-- Appwrite SDK + config -->
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
    <script>
      window.APPWRITE_CFG = {
        endpoint: "https://cloud.appwrite.io/v1",
        projectId: "68e009780030a983a57d",
        databaseId: "68e028d90039fa4588f5",
        collectionId: "events",
        scenarioCollectionId: "scenarios",
        shareBaseUrl:
          "https://girhun.github.io/Lets-Talk-CDC-Change-Feed-Playground/",
        channel: (db, col) => `databases.${db}.collections.${col}.documents`,
        assetHeaders: {
          "X-Appwrite-Project": "68e009780030a983a57d",
        },
        featureFlags: [
          "comparator_v2",
          "ff_event_bus",
          "ff_pause_resume",
          "ff_query_slider",
          "ff_crud_fix",
          "ff_event_log",
          "ff_metrics",
          "ff_schema_demo",
          "ff_multitable",
          "ff_trigger_mode",
          "ff_walkthrough",
        ],
      };
    </script>
    <script>
      window.CDC_FEATURE_FLAGS = Array.isArray(window.CDC_FEATURE_FLAGS)
        ? window.CDC_FEATURE_FLAGS.slice()
        : [
            "comparator_v2",
            "ff_crud_fix",
            "ff_event_log",
            "ff_event_bus",
            "ff_pause_resume",
            "ff_query_slider",
            "ff_schema_demo",
            "ff_multitable",
            "ff_metrics",
            "ff_trigger_mode",
            "ff_walkthrough",
          ];
    </script>
    <script src="./assets/feature-flags.js"></script>
    <script src="./assets/ui-shell-loader.js"></script>
    <script>
      (() => {
        const DEFAULT_STATUS_TEXT = "Add a column to begin";

        const overlay = document.getElementById("onboardingOverlay");
        const status = document.getElementById("schemaStatus");
        const pills = document.getElementById("schemaPills");
        const start = document.getElementById("onboardingStart");

        const defaultState = {
          schema: [],
          rows: [],
          events: [],
          schemaVersion: 1,
          scenarioId: null,
          remoteId: null,
        };

        function seedBlankWorkspace() {
          try {
            window.localStorage.setItem(
              "cdc_playground",
              JSON.stringify(defaultState)
            );
            window.localStorage.setItem(
              "cdc_playground_office_opt_in_v1",
              "false"
            );
          } catch {
            /* ignore storage errors */
          }
          if (status) status.textContent = DEFAULT_STATUS_TEXT;
          if (pills) pills.replaceChildren();
          if (overlay) overlay.style.display = "none";
        }

        start?.addEventListener("click", (event) => {
          event.preventDefault();
          seedBlankWorkspace();
        });

        function initializeOverlay() {
          if (status && !status.textContent) {
            status.textContent = DEFAULT_STATUS_TEXT;
          }
          if (overlay) overlay.style.display = "";
        }

        window.seedBlankWorkspace = seedBlankWorkspace;
      })();
    </script>
    <script type="module" src="assets/method-copy.js"></script>
    <script type="module" src="assets/shared-scenarios.js"></script>
    <script src="assets/sim-loader.js"></script>
    <script src="assets/event-log-loader.js"></script>
    <script src="assets/telemetry.js"></script>
    <script type="module" src="assets/app.js"></script>
    <script src="assets/tooltips.js"></script>
  </body>
</html>
