import{r as u,j as n,T as cn,S as la,R as ca}from"./event-log-widget.js";class da{constructor(){this.topics=new Map}publish(e,a){if(a.length===0)return[];const r=this.ensure(e);return a.map(c=>{const m=++r.offset,f={...c,offset:m};return r.queue.push(f),f})}consume(e,a=1){const r=this.ensure(e);return a<=0?[]:r.queue.splice(0,a)}size(e){return this.ensure(e).queue.length}reset(e){if(e){this.topics.delete(e);return}this.topics.clear()}ensure(e){let a=this.topics.get(e);return a||(a={offset:-1,queue:[]},this.topics.set(e,a)),a}}class ua{constructor(){this.produced=0,this.consumed=0,this.backlog=0,this.lagSamples=[],this.missedDeletes=0,this.writeAmplification=0,this.snapshotRows=0,this.errors=0,this.lagAggregators=new Set}onProduced(e){this.produced+=e.length,this.backlog+=e.length}onConsumed(e){this.consumed+=e.length,this.backlog=Math.max(this.backlog-e.length,0);const a=Date.now();e.forEach(r=>{const c=typeof r.commitTs=="number"?r.commitTs:typeof r.ts_ms=="number"?r.ts_ms:a,m=Math.max(a-c,0);this.lagSamples.push(m)}),this.lagSamples.length>2e3&&this.lagSamples.splice(0,this.lagSamples.length-2e3),this.notifyLagAggregators()}registerLagAggregator(e){return this.lagAggregators.add(e),this.safeInvokeAggregator(e),()=>{this.lagAggregators.delete(e)}}recordMissedDelete(e=1){this.missedDeletes+=e}recordWriteAmplification(e=1){this.writeAmplification+=e}recordSnapshotRows(e){this.snapshotRows=e}recordError(){this.errors+=1}reset(){this.produced=0,this.consumed=0,this.backlog=0,this.lagSamples=[],this.missedDeletes=0,this.writeAmplification=0,this.snapshotRows=0,this.errors=0,this.notifyLagAggregators()}snapshot(){const e=[...this.lagSamples].sort((c,m)=>c-m),a=this.percentile(e,.5),r=this.percentile(e,.95);return{produced:this.produced,consumed:this.consumed,backlog:this.backlog,lagMsP50:a,lagMsP95:r,missedDeletes:this.missedDeletes,writeAmplification:this.writeAmplification,snapshotRows:this.snapshotRows,errors:this.errors}}safeInvokeAggregator(e,a){try{const r=a?[...a]:[...this.lagSamples];e(r)}catch{}}notifyLagAggregators(){if(this.lagAggregators.size===0)return;const e=[...this.lagSamples];this.lagAggregators.forEach(a=>{this.safeInvokeAggregator(a,e)})}percentile(e,a){if(!e.length)return 0;const r=Math.max(e.length-1,0)*a,c=Math.floor(r),m=Math.min(c+1,e.length-1);if(c===m)return e[c];const f=r-c;return e[c]+(e[m]-e[c])*f}}class pa{constructor(){this.tasks=new Map,this.nextId=1}every(e,a){const r=this.nextId++,c={id:r,interval:e,handler:a};this.tasks.set(r,c);const m=setInterval(()=>a(),e);return c.timerId=m,r}clear(e){if(e!=null){const a=this.tasks.get(e);a&&a.timerId&&clearInterval(a.timerId),this.tasks.delete(e);return}this.tasks.forEach(a=>{const r=a.timerId;r&&clearInterval(r)}),this.tasks.clear()}}class ha{constructor(e,a,r,c,m,f={}){this.mode=e,this.bus=a,this.scheduler=r,this.metrics=c,this.handlers=f,this.state="IDLE",this.topic=m??`cdc.${e.toLowerCase()}`}get currentState(){return this.state}get topicName(){return this.topic}startSnapshot(e){this.state==="IDLE"&&(this.state="SNAPSHOTTING",this.handlers.startSnapshot?.(e,a=>this.emit(a)))}startTailing(){this.state!=="TAILING"&&(this.state="TAILING",this.handlers.startTailing?.(e=>this.emit(e)))}pause(){this.state==="TAILING"&&(this.state="PAUSED")}resume(){this.state==="PAUSED"&&(this.state="TAILING")}stop(){this.state="IDLE",this.scheduler.clear(),this.handlers.stop?.(),this.bus.reset(this.topic),this.metrics.reset()}emit(e){if(e.length===0)return[];const a=this.bus.publish(this.topic,e);return this.metrics.onProduced(a),a}}let ma=0;const zt=()=>`evt-${Date.now()}-${++ma}`,vt=t=>t?JSON.parse(JSON.stringify(t)):null,Os=(t,e)=>`${t}::${e}`,Ns=(t,e)=>({id:t.name,type:t.type,nullable:t.nullable??!1,__ts:e}),Ds=(t,e,a=`tx-${e}`)=>{const r=t?.id??a,c=typeof t?.index=="number",m=c?t.index:void 0,f=typeof t?.total=="number"?t.total:void 0;let _;return typeof t?.last=="boolean"?_=t.last:c&&typeof f=="number"?_=m>=f-1:_=!t,{id:r,index:m,total:f,last:_}};function ga(){let t=null,e=null,a=100,r=0;const c=new Map,m=[];let f=0;const _=new Map,T=g=>{const w=_.get(g);return typeof w=="number"&&w>=1?w:(_.set(g,1),1)},I=g=>{const w=T(g),i=w+1;return _.set(g,i),{previous:w,next:i}},C=(g,w,i,p,l)=>{const y=Ds(g.txn,l);return{id:zt(),kind:w,table:g.table,before:i?{id:g.pk.id,...i,__ts:l}:void 0,after:p?{id:g.pk.id,...p,__ts:l}:void 0,txnId:y.id,txnIndex:y.index,txnTotal:y.total,txnLast:y.last,commitTs:l,schemaVersion:T(g.table),topic:t?.topic??`cdc.${g.table}`,partition:0}},x=(g,w,i,p)=>{if(!e||!t)return;const{previous:l,next:y}=I(g),M=Ds(void 0,p,`schema-${p}`),L={id:zt(),kind:w==="ADD_COLUMN"?"SCHEMA_ADD_COL":"SCHEMA_DROP_COL",table:g,before:w==="DROP_COLUMN"?Ns(i,p):void 0,after:w==="ADD_COLUMN"?Ns(i,p):void 0,txnId:M.id,txnIndex:M.index,txnTotal:M.total,txnLast:M.last,commitTs:p,schemaVersion:y,topic:t.topic??`cdc.${g}`,partition:0,schemaChange:{action:w,column:i,previousVersion:l,nextVersion:y}};e([L])};return{id:"LOG_BASED",initialise(g){t=g},configure(g){const w=Number(g.fetch_interval_ms??g.fetchIntervalMs);Number.isFinite(w)&&w>0&&(a=w)},startSnapshot(g=[],w){if(e=w,!g.length||(g.forEach(p=>{const l=p.schema?.version??1;_.set(p.name,l),p.rows.forEach(y=>{const M=Os(p.name,y.id);c.set(M,{id:y.id,table:p.name,data:{...y},version:1,updatedAt:y.__ts??0,deleted:!1})})}),t?.metrics.recordSnapshotRows(c.size),!c.size))return;const i=[];c.forEach(p=>{i.push({id:zt(),kind:"INSERT",table:p.table,before:void 0,after:{id:p.id,...p.data,__ts:p.updatedAt},txnId:`snapshot-${p.updatedAt}`,txnIndex:0,txnTotal:1,txnLast:!0,commitTs:p.updatedAt,schemaVersion:T(p.table),topic:t?.topic??`cdc.${p.table}`,partition:0})}),e(i),f=m.length},startTailing(g){e=g},applySource(g){if(!t)return;const w=g.t,i=Os(g.table,g.pk.id);if(T(g.table),g.op==="insert")c.set(i,{id:g.pk.id,table:g.table,data:{...g.after},version:1,updatedAt:w,deleted:!1}),m.push(C(g,"INSERT",null,vt(g.after),w));else if(g.op==="update"){const p=c.get(i),l=p?vt(p.data):null,y=p?{...p.data,...g.after}:{...g.after};c.set(i,{id:g.pk.id,table:g.table,data:y,version:(p?.version??0)+1,updatedAt:w,deleted:!1}),m.push(C(g,"UPDATE",l,vt(y),w))}else if(g.op==="delete"){const p=c.get(i);c.set(i,{id:g.pk.id,table:g.table,data:p?{...p.data}:{},version:(p?.version??0)+1,updatedAt:w,deleted:!0}),m.push(C(g,"DELETE",p?vt(p.data):null,null,w))}},applySchemaChange(g,w,i,p){t&&(T(g),w==="ADD_COLUMN"?c.forEach((l,y)=>{l.table===g&&(i.name in l.data||(l.data[i.name]=null,c.set(y,{...l,data:{...l.data}})))}):w==="DROP_COLUMN"&&c.forEach((l,y)=>{if(l.table===g&&i.name in l.data){const M={...l.data};delete M[i.name],c.set(y,{...l,data:M})}}),x(g,w,i,p))},tick(g){if(!e||g-r<a)return;const w=m.slice(f);w.length&&(e(w),f=m.length),r=g},pause(){},resume(){},stop(){c.clear(),m.length=0,f=0,e=null,t=null,_.clear(),r=0}}}let fa=0;const Qt=()=>`evt-${Date.now()}-${++fa}`,Rs=t=>t?JSON.parse(JSON.stringify(t)):null,$s=(t,e)=>`${t}::${e}`,Ps=(t,e)=>({id:t.name,type:t.type,nullable:t.nullable??!1,__ts:e}),Fs=(t,e,a=`tx-${e}`)=>{const r=t?.id??a,m=!1?t.index:void 0,f=void 0;let _;return _=!0,{id:r,index:m,total:f,last:_}};function ba(){let t=null,e=null,a=1e3,r=!1,c=0;const m=new Map,f=new Map,_=new Map,T=[],I=i=>{const p=_.get(i);return typeof p=="number"&&p>=1?p:(_.set(i,1),1)},C=i=>{const p=I(i),l=p+1;return _.set(i,l),{previous:p,next:l}},x=(i,p,l,y,M,L,D,V)=>{const K=Fs(V,L,D);return{id:Qt(),kind:l,table:i,before:y?{id:p,...y,__ts:L}:void 0,after:M?{id:p,...M,__ts:L}:void 0,txnId:K.id,txnIndex:K.index,txnTotal:K.total,txnLast:K.last,commitTs:L,schemaVersion:I(i),topic:t?.topic??`cdc.${i}`,partition:0}},g=(i,p,l,y)=>{const{previous:M,next:L}=C(i),D=Fs(void 0,y,`schema-${y}`);T.push({id:Qt(),kind:p==="ADD_COLUMN"?"SCHEMA_ADD_COL":"SCHEMA_DROP_COL",table:i,before:p==="DROP_COLUMN"?Ps(l,y):void 0,after:p==="ADD_COLUMN"?Ps(l,y):void 0,txnId:D.id,txnIndex:D.index,txnTotal:D.total,txnLast:D.last,commitTs:y,schemaVersion:L,topic:t?.topic??`cdc.${i}`,partition:0,schemaChange:{action:p,column:l,previousVersion:M,nextVersion:L}})},w=i=>{!i.length||!e||e(i)};return{id:"QUERY_BASED",initialise(i){t=i},configure(i){const p=Number(i.poll_interval_ms??i.pollIntervalMs);Number.isFinite(p)&&p>0&&(a=p),i.include_soft_deletes!=null&&(r=!!i.include_soft_deletes),i.includeSoftDeletes!=null&&(r=!!i.includeSoftDeletes)},startSnapshot(i=[],p){e=p;const l=[];i.forEach(y=>{const M=y.schema?.version??1;_.set(y.name,M),y.rows.forEach(L=>{const D=$s(y.name,L.id);m.set(D,{id:L.id,table:y.name,data:{...L},version:1,updatedAt:L.__ts??0,deleted:!1}),f.set(D,1);const{id:V,__ts:K,...ke}=L;l.push({id:Qt(),kind:"INSERT",table:y.name,before:void 0,after:{id:V,...ke,__ts:K??0},txnId:`snapshot-${L.__ts??0}`,txnIndex:0,txnTotal:1,txnLast:!0,commitTs:L.__ts??0,schemaVersion:I(y.name),topic:t?.topic??`cdc.${y.name}`,partition:0})})}),t?.metrics.recordSnapshotRows(l.length),w(l)},startTailing(i){e=i},applySource(i){const p=$s(i.table,i.pk.id),l=i.t;if(I(i.table),i.op==="insert")m.set(p,{id:i.pk.id,table:i.table,data:{...i.after},version:1,updatedAt:l,deleted:!1});else if(i.op==="update"){const y=m.get(p),M=y?{...y.data,...i.after}:{...i.after};m.set(p,{id:i.pk.id,table:i.table,data:M,version:(y?.version??0)+1,updatedAt:l,deleted:!1})}else if(i.op==="delete"){const y=m.get(p);m.set(p,{id:i.pk.id,table:i.table,data:y?{...y.data}:{},version:(y?.version??0)+1,updatedAt:l,deleted:!0})}},applySchemaChange(i,p,l,y){I(i),p==="DROP_COLUMN"&&m.forEach((M,L)=>{if(M.table===i&&l.name in M.data){const D={...M.data};delete D[l.name],m.set(L,{...M,data:D})}}),g(i,p,l,y)},tick(i){if(!e||i-c<a)return;const p=[];T.length&&p.push(...T.splice(0,T.length)),m.forEach((l,y)=>{if(l.updatedAt<=c)return;const M=f.get(y)??0;if(l.deleted){r?(p.push(x(l.table,l.id,"DELETE",Rs(l.data),null,l.updatedAt,`tx-${l.updatedAt}`)),f.set(y,l.version)):(t?.metrics.recordMissedDelete(),f.set(y,l.version));return}if(l.version<=M)return;const L=M===0?"INSERT":"UPDATE";p.push(x(l.table,l.id,L,null,Rs(l.data),l.updatedAt,`tx-${l.updatedAt}`)),f.set(y,l.version)}),w(p),c=i},stop(){m.clear(),f.clear(),_.clear(),T.length=0,e=null,t=null,c=0}}}let xa=0;const Us=()=>`evt-${Date.now()}-${++xa}`,_t=t=>t?JSON.parse(JSON.stringify(t)):null,ya=(t,e)=>`${t}::${e}`,Bs=(t,e)=>({id:t.name,type:t.type,nullable:t.nullable??!1,__ts:e}),qs=(t,e,a=`tx-${e}`)=>{const r=t?.id??a,c=typeof t?.index=="number",m=c?t.index:void 0,f=typeof t?.total=="number"?t.total:void 0;let _;return typeof t?.last=="boolean"?_=t.last:c&&typeof f=="number"?_=m>=f-1:_=!t,{id:r,index:m,total:f,last:_}};function va(){let t=null,e=null,a=250,r=8,c=0,m=0;const f=new Map,_=[],T=new Map,I=i=>{const p=T.get(i);return typeof p=="number"&&p>=1?p:(T.set(i,1),1)},C=i=>{const p=I(i),l=p+1;return T.set(i,l),{previous:p,next:l}},x=(i,p,l,y,M)=>{const L=qs(i.txn,M);return{id:Us(),kind:p,table:i.table,before:l?{id:i.pk.id,...l,__ts:M}:void 0,after:y?{id:i.pk.id,...y,__ts:M}:void 0,txnId:L.id,txnIndex:L.index,txnTotal:L.total,txnLast:L.last,commitTs:M,schemaVersion:I(i.table),topic:t?.topic??`cdc.${i.table}`,partition:0}},g=(i,p,l,y)=>{const{previous:M,next:L}=C(i),D=qs(void 0,y,`schema-${y}`),V={id:Us(),kind:p==="ADD_COLUMN"?"SCHEMA_ADD_COL":"SCHEMA_DROP_COL",table:i,before:p==="DROP_COLUMN"?Bs(l,y):void 0,after:p==="ADD_COLUMN"?Bs(l,y):void 0,txnId:D.id,txnIndex:D.index,txnTotal:D.total,txnLast:D.last,commitTs:y,schemaVersion:L,topic:t?.topic??`cdc.${i}`,partition:0,schemaChange:{action:p,column:l,previousVersion:M,nextVersion:L}};_.push({event:V})},w=i=>{!i.length||!e||e(i)};return{id:"TRIGGER_BASED",initialise(i){t=i},configure(i){const p=Number(i.extract_interval_ms??i.extractIntervalMs);Number.isFinite(p)&&p>0&&(a=p);const l=Number(i.trigger_overhead_ms??i.triggerOverheadMs);Number.isFinite(l)&&l>=0&&(r=l)},startSnapshot(i=[],p){e=p,t?.metrics.recordSnapshotRows(0)},startTailing(i){e=i},applySource(i){if(!t)return;const p=ya(i.table,i.pk.id),l=i.t+r;let y=null,M=null,L;if(I(i.table),i.op==="insert")L="INSERT",M=_t(i.after),f.set(p,{id:i.pk.id,table:i.table,data:{...i.after},version:1,updatedAt:l,deleted:!1});else if(i.op==="update"){const D=f.get(p);y=D?_t(D.data):null;const V=D?{...D.data,...i.after}:{...i.after};M=_t(V),L="UPDATE",f.set(p,{id:i.pk.id,table:i.table,data:V,version:(D?.version??0)+1,updatedAt:l,deleted:!1})}else if(i.op==="delete"){const D=f.get(p);y=D?_t(D.data):null,M=null,L="DELETE",f.set(p,{id:i.pk.id,table:i.table,data:D?{...D.data}:{},version:(D?.version??0)+1,updatedAt:l,deleted:!0})}else return;_.push({event:x(i,L,y,M,l)}),t.metrics.recordWriteAmplification(1)},applySchemaChange(i,p,l,y){if(!t)return;const M=y+r;I(i),p==="ADD_COLUMN"?f.forEach((L,D)=>{if(L.table===i&&!(l.name in L.data)){const V={...L.data,[l.name]:null};f.set(D,{...L,data:V,version:L.version+1,updatedAt:M})}}):p==="DROP_COLUMN"&&f.forEach((L,D)=>{if(L.table===i&&l.name in L.data){const V={...L.data};delete V[l.name],f.set(D,{...L,data:V,version:L.version+1,updatedAt:M})}}),g(i,p,l,M)},tick(i){if(!e||i-c<a)return;const p=_.slice(m).map(l=>l.event);w(p),m=_.length,c=i},stop(){_.length=0,f.clear(),e=null,t=null,m=0,c=0,T.clear()}}}const jt={MYSQL_DEBEZIUM:{id:"MYSQL_DEBEZIUM",label:"MySQL · Debezium · Kafka",description:"Debezium tails the MySQL binlog and pushes commits to Kafka for downstream consumers.",docsHint:"https://debezium.io/documentation/reference/stable/connectors/mysql.html",sourceLabel:"MySQL primary",sourceTooltip:"InnoDB workload emitting row-level changes for capture.",logLabel:"MySQL binlog (Debezium)",logTooltip:"Debezium connector streams row-format binlog entries in commit order.",busLabel:"Kafka topic",busTooltip:"Kafka transports Debezium change events (e.g. db.orders) to consumers.",destinationLabel:"Warehouse / downstream sink",destinationTooltip:"Analytics warehouse, service, or cache subscribing to the Kafka topic.",topicFormat:t=>`db.${t}`,methodCopyOverrides:{polling:{label:"Polling (scheduled SQL)",laneDescription:"Batch jobs diff the MySQL table on an interval to detect divergence.",callout:"Misses hard deletes and rapid updates without custom tracking tables.",whenToUse:"Fallback when binlog access is blocked. Accepts lag and data loss for small tables only.",tooltip:"ETL-style SELECT polling against the MySQL primary."},trigger:{label:"Triggers (audit table)",laneDescription:"AFTER triggers write every mutation into an audit table for downstream extract.",callout:"Adds synchronous latency on the write path and increases operational overhead.",whenToUse:"When connectors are unavailable but you still need complete change history.",tooltip:"MySQL triggers populate audit tables that an extractor drains."},log:{label:"Debezium binlog tail",laneDescription:"Debezium streams row-based binlog events into Kafka with schema evolution support.",callout:"Preferred default: low-impact, ordered, near real-time change capture.",whenToUse:"Standard choice for production MySQL workloads when Kafka + Debezium are available.",tooltip:"Debezium connector tailing the MySQL binlog."}}},POSTGRES_LOGICAL:{id:"POSTGRES_LOGICAL",label:"Postgres · Logical decoding · Kafka",description:"Logical decoding streams Postgres WAL changes (pgoutput/wal2json) into Kafka.",docsHint:"https://www.postgresql.org/docs/current/logicaldecoding.html",sourceLabel:"Postgres primary",sourceTooltip:"OLTP Postgres emitting WAL entries for publications.",logLabel:"Logical replication slot",logTooltip:"Logical decoding slot materialises committed WAL changes via pgoutput or wal2json.",busLabel:"Kafka topic",busTooltip:"Kafka topics per publication (e.g. public.orders) fan out change events.",destinationLabel:"Warehouse / downstream sink",destinationTooltip:"Consumers applying logical changes into warehouses or services.",topicFormat:t=>`public.${t}`,methodCopyOverrides:{polling:{label:"Polling (snapshot queries)",laneDescription:"Incremental SELECT queries compare current rows to previous snapshots.",callout:"Can't observe deletes or mid-transaction updates without tombstone columns.",whenToUse:"Stopgap for small tables when logical replication isn't permitted.",tooltip:"Periodic comparison queries against Postgres source tables."},trigger:{label:"Triggers (audit schema)",laneDescription:"Triggers populate audit tables that an extractor tails outside the WAL.",callout:"Higher write amplification and maintenance across replicas.",whenToUse:"When WAL access is off-limits yet complete history is required.",tooltip:"AFTER triggers write into audit tables for downstream capture."},log:{label:"Logical decoding stream",laneDescription:"Slot-based logical decoding streams ordered WAL changes through Kafka.",callout:"Best balance: ordered, low-impact capture with schema evolution support.",whenToUse:"Primary choice when you can run wal2json/pgoutput connectors.",tooltip:"Logical replication slot feeding Kafka via connectors."}}},SQLSERVER_CDC:{id:"SQLSERVER_CDC",label:"SQL Server · CDC tables · ETL",description:"SQL Server CDC populates change tables that ETL tools ship downstream.",docsHint:"https://learn.microsoft.com/sql/relational-databases/track-changes/about-change-data-capture-sql-server",sourceLabel:"SQL Server OLTP",sourceTooltip:"Source database with CDC enabled on tracked tables.",logLabel:"CDC change tables",logTooltip:"Log reader agent populates [cdc].[schema_table_CT] from the transaction log.",busLabel:"ETL pipeline",busTooltip:"ADF/SSIS or similar ETL pipelines move captured rows to consumers.",destinationLabel:"Warehouse / downstream sink",destinationTooltip:"Lakehouse, staging DB, or microservice applying captured rows.",topicFormat:t=>`cdc.${t}_ct`,methodCopyOverrides:{polling:{label:"Polling (T-SQL jobs)",laneDescription:"Scheduled queries compare source tables against a shadow copy.",callout:"Hard deletes vanish and rapid updates collapse to last-write wins.",whenToUse:"Only when CDC can't be enabled. Expect drift and operational overhead.",tooltip:"Agent jobs issuing SELECT deltas against the primary."},trigger:{label:"DB triggers (audit tables)",laneDescription:"DDL-driven triggers write into audit tables that ETL picks up.",callout:"Adds synchronous writes and complicates deployments.",whenToUse:"Fallback for editions without CDC but needing full fidelity.",tooltip:"FOR INSERT/UPDATE/DELETE triggers persisting rows into audit tables."},log:{label:"CDC change table stream",laneDescription:"Native CDC surfaces ordered change rows ready for downstream ETL.",callout:"Balanced approach: leverages log reader agent with minimal code.",whenToUse:"Default when SQL Server Enterprise/Standard CDC is available.",tooltip:"Change Data Capture tables populated by the log reader agent."}}},ORACLE_GG:{id:"ORACLE_GG",label:"Oracle · GoldenGate",description:"GoldenGate extracts Oracle redo into trails that replicat apply downstream.",docsHint:"https://docs.oracle.com/en/middleware/goldengate/",sourceLabel:"Oracle primary",sourceTooltip:"Oracle Database generating redo entries for tracked schemas.",logLabel:"Redo / GoldenGate trail",logTooltip:"Extract captures redo logs into GoldenGate trail files.",busLabel:"GoldenGate distribution",busTooltip:"GoldenGate distribution path replicates changes to targets or Kafka.",destinationLabel:"Replica / downstream sink",destinationTooltip:"Target database, cache, or Kafka topic consuming GoldenGate trails.",topicFormat:t=>`ogg.${t}`,methodCopyOverrides:{polling:{label:"Polling (custom jobs)",laneDescription:"Scripts query Oracle tables for deltas outside of GoldenGate.",callout:"Expensive and incomplete without change tracking columns.",whenToUse:"Rare stopgap for small tables when GoldenGate access is unavailable.",tooltip:"Ad-hoc jobs diffing source tables over DB links or snapshots."},trigger:{label:"Triggers (shadow tables)",laneDescription:"Row-level triggers populate shadow tables for downstream capture.",callout:"Adds redo volume and requires meticulous deployment management.",whenToUse:"Fallback when GoldenGate licensing or access is restricted.",tooltip:"Oracle triggers mirroring mutations into custom staging tables."},log:{label:"GoldenGate redo tail",laneDescription:"GoldenGate Extract/Replicat stream redo into ordered trail files.",callout:"Enterprise-grade: minimal source impact with robust replication semantics.",whenToUse:"Primary approach for Oracle sources requiring guaranteed replication.",tooltip:"GoldenGate Extract reading redo logs into trail files."}}},MONGODB_STREAMS:{id:"MONGODB_STREAMS",label:"MongoDB · Change Streams",description:"Change Streams tail the MongoDB oplog and push updates to subscribers.",docsHint:"https://www.mongodb.com/docs/manual/changeStreams/",sourceLabel:"MongoDB replica set",sourceTooltip:"Replica set primary emitting operations into the oplog.",logLabel:"Change stream (oplog)",logTooltip:"Change Stream cursor streams oplog events filtered per namespace.",busLabel:"Driver subscriber",busTooltip:"Driver / connector pushes stream events to downstream sinks (Kafka/Atlas).",destinationLabel:"Streaming sink",destinationTooltip:"Analytical store or service consuming the stream.",topicFormat:t=>`mongo.${t}`,methodCopyOverrides:{polling:{label:"Polling (find queries)",laneDescription:"Scheduled queries diff collections by last-updated timestamps.",callout:"No delete visibility and heavy load for high-churn collections.",whenToUse:"Only for prototypes without Change Stream or oplog access.",tooltip:"find() queries scanning for updated documents on an interval."},trigger:{label:"Hooks (side-write)",laneDescription:"Application-layer hooks write audit documents alongside originals.",callout:"Requires app changes and doubles write throughput.",whenToUse:"When database triggers/log access is unavailable and app control exists.",tooltip:"Custom middleware duplicating writes into audit collections."},log:{label:"Change Stream tail",laneDescription:"Native Change Stream cursor fans out oplog events in order.",callout:"Recommended: low-latency stream with resume tokens and schema support.",whenToUse:"Default for MongoDB replicas when you can open a Change Stream cursor.",tooltip:"MongoDB Change Stream subscription on the oplog."}}}},kt="cdc_playground_template_filter_v1",Lt="cdc_playground_template_filter_tags_v1",At={query:"",tags:[]},_a=t=>typeof t=="string"?t:"",dn=t=>{if(!Array.isArray(t))return[];const e=new Set,a=[];return t.forEach(r=>{if(r==null)return;const c=String(r).trim();!c||e.has(c)||(e.add(c),a.push(c))}),a},es=t=>{if(!t||typeof t!="object")return{...At};const e=_a(typeof t.query=="string"?t.query:""),a=t.tags;if(Array.isArray(a))return{query:e,tags:dn(a)};if(typeof a=="string"){const r=a.trim();return{query:e,tags:r?[r]:[]}}return{query:e,tags:[]}},wa=(t,e)=>{if(t===e)return!0;if(t.length!==e.length)return!1;for(let a=0;a<t.length;a+=1)if(t[a]!==e[a])return!1;return!0},Sa=t=>typeof t!="string"?"":t,Ea=t=>{if(typeof t!="string"||t.trim().length===0)return[];try{const e=JSON.parse(t);if(Array.isArray(e))return dn(e)}catch{}return[]},Ca=t=>{if(!t)return{...At};try{const e=Sa(t.getItem(kt)),a=Ea(t.getItem(Lt));return{query:e,tags:a}}catch{return{...At}}},ja=(t,e)=>{if(!e)return;const a=es(t);try{a.query?e.setItem(kt,a.query):typeof e.removeItem=="function"?e.removeItem(kt):e.setItem(kt,"")}catch{}try{a.tags.length>0?e.setItem(Lt,JSON.stringify(a.tags)):typeof e.removeItem=="function"?e.removeItem(Lt):e.setItem(Lt,"")}catch{}},ka=t=>typeof t=="string"?t.trim().toLowerCase():"",Vs=t=>Array.isArray(t)?t.map(e=>typeof e=="string"?e.trim():"").filter(e=>e.length>0):[],La=t=>{const e=[];return t.label&&e.push(t.label),t.description&&e.push(t.description),t.highlight&&e.push(t.highlight),t.name&&e.push(t.name),Array.isArray(t.tags)&&t.tags.length>0&&e.push(t.tags.join(" ")),e.join(" ").toLowerCase()};function Ta(t,e={}){const a=Array.from(t),{liveScenario:r,liveScenarioName:c,tags:m,query:f}=e;if(r){const C=a.findIndex(x=>x.name===r.name);C>=0?a.splice(C,1,r):a.unshift(r)}const _=Vs(m),I=ka(f).split(/\s+/).map(C=>C.trim()).filter(C=>C.length>0);return a.filter(C=>{if(c&&C.name===c)return!0;if(_.length>0){const g=Vs(C.tags??[]);if(!_.every(i=>g.includes(i)))return!1}if(I.length===0)return!0;const x=La(C);return x?I.every(g=>x.includes(g)):!1})}const Kt=(t,e)=>{Array.isArray(e)&&e.forEach(a=>{if(typeof a!="string")return;const r=a.trim();r.length>0&&t.add(r)})};function Ma(t,e={}){const a=new Set;return t.forEach(r=>Kt(a,r.tags)),e.liveScenario&&Kt(a,e.liveScenario.tags),e.additionalTags?.forEach(r=>Kt(a,r)),Array.from(a).sort((r,c)=>r.localeCompare(c))}const ts=t=>{if(Array.isArray(t))return t.map(e=>ts(e));if(t&&typeof t=="object"){const e={};return Object.entries(t).forEach(([a,r])=>{e[a]=ts(r)}),e}return t},Tt=t=>ts(t),un=t=>({...t}),Gs=t=>({name:t.name,version:t.version,columns:t.columns.map(un)}),Aa=(t,e)=>typeof e=="boolean"?"bool":typeof e=="number"?/_ts$|timestamp$/i.test(t)?"timestamp":"number":e instanceof Date?"timestamp":"string",Ia=(t,e=1)=>({name:t,version:e,columns:[{name:"id",type:"string",nullable:!1}]}),Ws=t=>{t.columns.some(a=>a.name==="id")||t.columns.unshift({name:"id",type:"string",nullable:!1})},Hs=t=>{const e=Tt(t);return e.id=String(e.id),e};class Jt{constructor(e=[]){this.tables=new Map,e.forEach(a=>this.upsertTable(a))}upsertTable(e){const a=Gs(e.schema);Ws(a);const r=new Map;e.rows.forEach(c=>{const m=Hs(Tt(c));r.set(m.id,m)}),this.tables.set(e.name,{schema:a,rows:r})}replaceAll(e){this.tables.clear(),e.forEach(a=>this.upsertTable(a))}getTable(e){const a=this.tables.get(e);if(a)return{name:e,schema:Gs(a.schema),rows:Array.from(a.rows.values()).map(r=>Tt(r))}}listTables(){return Array.from(this.tables.keys()).map(e=>this.getTable(e)).filter(e=>!!e)}clear(){this.tables.clear()}applyEvents(e){e.forEach(a=>this.applyEvent(a))}applyEvent(e){if(!e?.table)return;if(e.kind==="SCHEMA_ADD_COL"||e.kind==="SCHEMA_DROP_COL"){this.applySchemaChange(e);return}const a=this.ensureTableState(e.table,e.schemaVersion);if(e.schemaVersion&&e.schemaVersion>a.schema.version&&(a.schema.version=e.schemaVersion),e.kind==="DELETE"){const T=e.before?.id??e.after?.id;T!=null&&a.rows.delete(String(T));return}const r=e.after??void 0;if(!r)return;const c=Hs(r),m=a.rows.get(c.id),f=m?{...m,...c}:c,_=Tt(f);this.syncSchemaColumns(a,_),a.rows.set(_.id,_)}snapshot(){return this.listTables()}ensureTableState(e,a){let r=this.tables.get(e);return r||(r={schema:Ia(e,a??1),rows:new Map},this.tables.set(e,r)),a&&a>r.schema.version&&(r.schema.version=a),Ws(r.schema),r}applySchemaChange(e){const a=e.schemaChange;if(!a)return;const r=this.ensureTableState(e.table,a.nextVersion??e.schemaVersion);r.schema.version=Math.max(r.schema.version,a.nextVersion??e.schemaVersion??r.schema.version),e.kind==="SCHEMA_ADD_COL"?this.addColumn(r,a.column):e.kind==="SCHEMA_DROP_COL"&&this.dropColumn(r,a.column.name)}addColumn(e,a){const r=e.schema.columns.find(c=>c.name===a.name);r?(r.type=a.type,a.nullable&&(r.nullable=!0)):e.schema.columns.push(un(a)),e.rows.forEach(c=>{a.name in c||(c[a.name]=null)})}dropColumn(e,a){a!=="id"&&(e.schema.columns=e.schema.columns.filter(r=>r.name!==a),e.rows.forEach(r=>{a in r&&delete r[a]}))}syncSchemaColumns(e,a){const r=e.schema.columns;Object.entries(a).forEach(([c,m])=>{if(c==="id"||c.startsWith("__"))return;let f=r.find(_=>_.name===c);f||(f={name:c,type:Aa(c,m)},r.push(f)),m==null&&(f.nullable=!0)})}}const Oa=2e3,wt={methods:[],ops:[],tables:[],txns:[]},zs={empty:"No events yet.",noMatch:"No events match the current filters."},Qs=t=>{if(!t)return"";try{const e=JSON.stringify(t);return e?e.length>160?`${e.slice(0,160)}…`:e:""}catch{return""}},Na=t=>{if(!t)return"—";const e=t.trim();return e?(e.length===1,e.toUpperCase()):"—"},Da=({events:t,stats:e,totalCount:a,filters:r={},filterOptions:c,onFiltersChange:m,onDownload:f,onClear:_,onCopyEvent:T,onReplayEvent:I,maxVisibleEvents:C=Oa,emptyMessage:x,noMatchMessage:g,className:w})=>{const i={methods:c?.methods??wt.methods,ops:c?.ops??wt.ops,tables:c?.tables??wt.tables,txns:c?.txns??wt.txns},p=u.useMemo(()=>typeof C!="number"||C<=0?t.length:Math.min(C,t.length),[t.length,C]),[l,y]=u.useState(p);u.useEffect(()=>{y(j=>j<p?p:j>t.length?t.length:j)},[p,t.length]);const M=u.useMemo(()=>{const j=Math.max(l,0),G=Math.max(t.length-j,0);return t.slice(G)},[t,l]),L=M.length<t.length,D=l>p,V=()=>{if(!L)return;const j=p>0?p:t.length;y(G=>Math.min(G+j,t.length))},K=()=>{y(p)},ke=typeof a=="number"?a:t.length,Le=!!r.methodId||!!r.op||!!r.table||!!r.txnId,He={empty:x??zs.empty,noMatch:g??zs.noMatch},z=j=>{if(!m)return;const G={methodId:j.methodId===void 0?r.methodId:j.methodId,op:j.op===void 0?r.op:j.op,table:j.table===void 0?r.table:j.table,txnId:j.txnId===void 0?r.txnId:j.txnId},W={methodId:G.methodId||void 0,op:G.op||void 0,table:G.table||void 0,txnId:G.txnId||void 0};m(W)},ze=j=>{const G=Qs(j.before),W=Qs(j.after);return!G&&!W?null:n.jsxs("details",{className:"cdc-event-log__details",children:[n.jsx("summary",{children:"Row image"}),G&&n.jsxs("div",{className:"cdc-event-log__details-row",children:[n.jsx("span",{children:"before"}),n.jsx("code",{children:G})]}),W&&n.jsxs("div",{className:"cdc-event-log__details-row",children:[n.jsx("span",{children:"after"}),n.jsx("code",{children:W})]})]})};return n.jsxs("section",{className:`cdc-event-log${w?` ${w}`:""}`,"aria-label":"Event log",role:"region",children:[n.jsxs("header",{className:"cdc-event-log__header",children:[n.jsxs("div",{className:"cdc-event-log__headline",children:[n.jsx("h3",{children:"Event Log"}),e&&n.jsxs("p",{className:"cdc-event-log__stats",children:[n.jsxs("span",{children:["Produced ",e.produced]})," · ",n.jsxs("span",{children:["Consumed ",e.consumed]})," · ",n.jsxs("span",{children:["Backlog ",e.backlog]}),typeof e.snapshotRows=="number"&&n.jsxs(n.Fragment,{children:[" · ",n.jsxs("span",{children:["Snapshot rows ",e.snapshotRows]})]})]})]}),n.jsxs("div",{className:"cdc-event-log__actions",children:[n.jsxs("span",{children:[t.length," events"]}),n.jsx("button",{type:"button",onClick:f,disabled:!f||t.length===0,children:"Download NDJSON"}),n.jsx("button",{type:"button",onClick:_,disabled:!_||ke===0,children:"Clear"})]})]}),n.jsxs("div",{className:"cdc-event-log__filters",role:"group","aria-label":"Event log filters",children:[n.jsxs("label",{children:[n.jsx("span",{children:"Method"}),n.jsxs("select",{value:r.methodId??"",onChange:j=>z({methodId:j.target.value||void 0}),disabled:!m||i.methods.length===0,children:[n.jsx("option",{value:"",children:"All methods"}),i.methods.map(j=>n.jsx("option",{value:j.id,children:j.label},j.id))]})]}),n.jsxs("label",{children:[n.jsx("span",{children:"Operation"}),n.jsxs("select",{value:r.op??"",onChange:j=>z({op:j.target.value||void 0}),disabled:!m||i.ops.length===0,children:[n.jsx("option",{value:"",children:"All ops"}),i.ops.map(j=>n.jsx("option",{value:j,children:j.toUpperCase()},j))]})]}),n.jsxs("label",{children:[n.jsx("span",{children:"Table"}),n.jsxs("select",{value:r.table??"",onChange:j=>z({table:j.target.value||void 0}),disabled:!m||i.tables.length===0,children:[n.jsx("option",{value:"",children:"All tables"}),i.tables.map(j=>n.jsx("option",{value:j,children:j},j))]})]}),n.jsxs("label",{children:[n.jsx("span",{children:"Txn"}),n.jsxs("select",{value:r.txnId??"",onChange:j=>z({txnId:j.target.value||void 0}),disabled:!m||i.txns.length===0,children:[n.jsx("option",{value:"",children:"All txns"}),i.txns.map(j=>n.jsx("option",{value:j,children:j},j))]})]})]}),t.length===0?n.jsx("p",{className:"cdc-event-log__empty",children:ke>0||Le?He.noMatch:He.empty}):n.jsxs("ul",{className:"cdc-event-log__list",children:[t.length>M.length&&n.jsxs("li",{className:"cdc-event-log__notice",children:[n.jsxs("span",{children:["Showing latest ",M.length," of ",t.length," events."]}),n.jsxs("div",{className:"cdc-event-log__notice-actions",children:[n.jsx("button",{type:"button",onClick:V,disabled:!L,children:"Load more"}),D&&n.jsx("button",{type:"button",onClick:K,children:"Show latest"})]})]}),M.map(j=>{const G=Na(j.op),W=typeof j.offset=="number"?j.offset:j.offset==null?"—":j.offset,Ot=j.topic??"—",Q=j.table??"—",it=j.pk??"—",be=j.txnId??"",Te=typeof j.tsMs=="number"?j.tsMs:"—",Y=typeof j.op=="string"?j.op.trim().toLowerCase():"",Qe=Y==="c"||Y==="u"||Y==="d";return n.jsxs("li",{className:"cdc-event-log__item",children:[n.jsx("span",{className:"cdc-event-log__method",children:j.methodLabel??j.methodId??"—"}),n.jsx("span",{className:"cdc-event-log__op","data-op":G,children:G}),n.jsxs("span",{className:"cdc-event-log__offset",children:["offset ",W]}),n.jsx("span",{className:"cdc-event-log__topic",children:Ot}),n.jsxs("span",{className:"cdc-event-log__table",children:["table ",Q]}),n.jsxs("span",{className:"cdc-event-log__meta",children:["ts=",Te,"ms · pk=",it,be?` · txn=${be}`:""]}),j.meta?n.jsx("span",{className:"cdc-event-log__extra",children:j.meta}):null,I?n.jsx("button",{type:"button",className:"cdc-event-log__replay",onClick:()=>I?.(j),disabled:!Qe,children:"Replay"}):null,n.jsx("button",{type:"button",className:"cdc-event-log__copy",onClick:()=>T?.(j),disabled:!T,children:"Copy"}),ze(j)]},j.id)})]})]})};function Ra(t){const e=t.op?.toUpperCase?.()??"?",a=t.pk??"∅",r=t.expectedIndex!=null?`#${t.expectedIndex}`:void 0,c=t.actualIndex!=null?`#${t.actualIndex}`:void 0;return t.type==="missing"?`Missing ${e} for pk=${a} (${r??"expected"} @ ${t.expectedTime??"?"}ms)`:t.type==="extra"?`Unexpected ${e} for pk=${a} (${c??"emitted"} @ ${t.actualTime??"?"}ms)`:`Out-of-order ${e} pk=${a} (expected ${r??"?"} before actual ${c??"?"})`}const $a=({diff:t,scenarioName:e,laneId:a,schemaStatus:r,onDiffDetailsOpened:c})=>{if(!t)return null;const{totals:m,issues:f,lag:_}=t,T=m.missing>0||m.extra>0||m.ordering>0,I=f.slice(0,6);let C=null;return r&&(r.hasColumn?r.version<r.expectedVersion&&(C=`Schema behind: v${r.version} (expected v${r.expectedVersion})`):C=`${r.columnName} column missing in destination`),!T&&_.max<=0&&!C?null:n.jsxs("div",{className:"sim-shell__lane-diff","data-has-issues":T?"true":"false",role:"note",children:[n.jsxs("div",{className:"sim-shell__lane-diff-summary",children:[T?n.jsxs(n.Fragment,{children:[m.missing>0&&n.jsxs("span",{className:"sim-shell__lane-diff-chip sim-shell__lane-diff-chip--missing",children:[m.missing," missing"]}),m.extra>0&&n.jsxs("span",{className:"sim-shell__lane-diff-chip sim-shell__lane-diff-chip--extra",children:[m.extra," extra"]}),m.ordering>0&&n.jsxs("span",{className:"sim-shell__lane-diff-chip sim-shell__lane-diff-chip--ordering",children:[m.ordering," ordering"]})]}):n.jsx("span",{className:"sim-shell__lane-diff-chip sim-shell__lane-diff-chip--ok",children:"Operations aligned"}),_.max>0&&n.jsxs("span",{className:"sim-shell__lane-diff-chip sim-shell__lane-diff-chip--lag",children:["Max lag ",Math.round(_.max),"ms"]})]}),C&&n.jsx("p",{className:"sim-shell__lane-diff-schema",children:C}),(I.length>0||_.samples.length>0)&&n.jsxs("details",{id:a?`lane-diff-${a}`:void 0,className:"sim-shell__lane-diff-details",onToggle:x=>{x.target.open&&c?.({method:t.method,issueCount:t.issues.length,maxLag:t.lag.max,scenario:e})},children:[n.jsx("summary",{children:"Diff details"}),I.length>0&&n.jsx("ul",{className:"sim-shell__lane-diff-list",children:I.map((x,g)=>n.jsx("li",{children:Ra(x)},`${x.type}-${x.op}-${x.pk??"∅"}-${g}`))}),f.length>I.length&&n.jsxs("p",{className:"sim-shell__lane-diff-more",children:["+",f.length-I.length," additional difference(s)"]}),_.samples.length>0&&n.jsxs("div",{className:"sim-shell__lane-diff-lag",children:[n.jsx("h4",{children:"Lag hotspots"}),n.jsx("ul",{children:_.samples.map(x=>n.jsxs("li",{children:[Math.round(x.lagMs),"ms on ",x.op.toUpperCase()," pk=",x.pk??"∅"]},`${x.op}-${x.pk??"∅"}-${x.actualTime??"?"}`))})]})]})]})},Ve=cn,Z=t=>Number.isFinite(t)?t.toLocaleString():"—",Ks=t=>Number.isFinite(t)?`${Math.round(t)}ms`:"—",Pa=({lanes:t,renderSchemaWalkthrough:e})=>{const a=t.reduce((r,c)=>(r.produced+=c.produced,r.consumed+=c.consumed,r.backlog+=c.backlog,r),{produced:0,consumed:0,backlog:0});return n.jsxs("section",{className:"sim-shell__metrics-dashboard","aria-label":"Runtime metrics",children:[n.jsx("header",{className:"sim-shell__metrics-dashboard-header",children:n.jsxs("div",{children:[n.jsx("h3",{children:"Runtime metrics"}),n.jsxs("p",{children:["Produced ",Z(a.produced)," · Consumed ",Z(a.consumed)," · Backlog ",Z(a.backlog)]})]})}),n.jsx("div",{className:"sim-shell__metrics-dashboard-grid",children:t.map(r=>n.jsxs("article",{className:"sim-shell__metrics-dashboard-card",children:[n.jsx("header",{children:n.jsx("h4",{"data-tooltip":r.tooltip||void 0,children:r.label})}),e&&n.jsx("div",{className:"sim-shell__schema-demo-inline",children:e(r.id)}),n.jsxs("dl",{children:[n.jsxs("div",{children:[n.jsx("dt",{children:"Produced"}),n.jsx("dd",{children:Z(r.produced)})]}),n.jsxs("div",{children:[n.jsx("dt",{children:"Consumed"}),n.jsx("dd",{children:Z(r.consumed)})]}),n.jsxs("div",{children:[n.jsx("dt",{children:"Backlog"}),n.jsx("dd",{"data-tooltip":Ve.backlog,children:Z(r.backlog)})]}),n.jsxs("div",{children:[n.jsx("dt",{children:"Lag p50"}),n.jsx("dd",{"data-tooltip":Ve.lagPercentile,children:Ks(r.lagP50)})]}),n.jsxs("div",{children:[n.jsx("dt",{children:"Lag p95"}),n.jsx("dd",{"data-tooltip":Ve.lagPercentile,children:Ks(r.lagP95)})]}),typeof r.snapshotRows=="number"&&n.jsxs("div",{children:[n.jsx("dt",{children:"Snapshot rows"}),n.jsx("dd",{"data-tooltip":Ve.snapshot,children:Z(r.snapshotRows)})]}),(typeof r.inserts=="number"||typeof r.updates=="number"||typeof r.deletes=="number")&&n.jsxs("div",{children:[n.jsx("dt",{children:"Change mix"}),n.jsxs("dd",{children:["C ",Z(r.inserts??0)," · U ",Z(r.updates??0)," · D ",Z(r.deletes??0),typeof r.schemaChanges=="number"&&r.schemaChanges>0?` · Schema ${Z(r.schemaChanges)}`:""]})]}),typeof r.missedDeletes=="number"&&n.jsxs("div",{children:[n.jsx("dt",{children:"Missed deletes"}),n.jsx("dd",{"data-tooltip":Ve.deleteCapture,children:Z(r.missedDeletes)})]}),typeof r.writeAmplification=="number"&&n.jsxs("div",{children:[n.jsx("dt",{children:"Write amplification"}),n.jsxs("dd",{"data-tooltip":Ve.triggerWriteAmplification,children:[r.writeAmplification.toFixed(1),"x"]})]})]})]},r.id))})]})},Fa=({lagMs:t,throughput:e,deletesPct:a,orderingOk:r,consistent:c,writeAmplification:m,insertCount:f,updateCount:_,deleteCount:T,schemaChangeCount:I})=>n.jsxs("div",{role:"status","aria-live":"polite",children:[n.jsxs("span",{children:["Lag: ",t,"ms"]})," ·",n.jsxs("span",{children:["TPS: ",e.toFixed(1)]})," ·",n.jsxs("span",{children:["Deletes: ",Math.round(a),"%"]})," ·",n.jsxs("span",{children:["Ordering: ",r?"OK":"KO"]})," ·",n.jsxs("span",{children:["Consistency: ",c?"OK":"Drift"]})," ","·",n.jsxs("span",{children:["Ops C/U/D: ",f,"/",_,"/",T]}),I>0&&n.jsxs(n.Fragment,{children:[" ","·",n.jsxs("span",{children:["Schema: ",I]})]}),typeof m=="number"&&n.jsxs(n.Fragment,{children:[" ","·",n.jsxs("span",{children:["Trigger WA: ",m.toFixed(1),"x"]})]})]}),Ua=({onAdd:t,onDrop:e,columnName:a,disabled:r,disableAdd:c,disableDrop:m,status:f})=>n.jsxs("section",{className:"sim-shell__schema-demo","aria-label":"Schema walkthrough",children:[n.jsxs("header",{children:[n.jsx("h4",{children:"Schema walkthrough"}),n.jsxs("p",{children:["Add or drop ",n.jsx("code",{children:a})," while events stream to compare capture behaviour."]})]}),f?n.jsx("p",{className:"sim-shell__schema-demo-status",children:f}):null,n.jsxs("div",{className:"sim-shell__schema-demo-buttons",children:[n.jsxs("button",{type:"button",onClick:t,disabled:r||c,"data-tour-target":"schema-add",children:["Add ",a]}),n.jsxs("button",{type:"button",onClick:e,disabled:r||m,"data-tour-target":"schema-drop",children:["Drop ",a]})]})]}),Ba="cdc_telemetry_buffer_v1",qa=200,pn={activation:{key:"activation",label:"Activation",description:"Do new users reach their first comparator insight?"},funnel_drop:{key:"funnel_drop",label:"Funnel drop",description:"Where do users abandon the guided comparator walkthrough?"},adoption:{key:"adoption",label:"Adoption",description:"Which comparator features become part of regular usage?"},quality_gate:{key:"quality_gate",label:"Quality gate",description:"Do reliability issues or errors block comparator adoption?"},scenario_completeness:{key:"scenario_completeness",label:"Scenario completeness",description:"Which templates lead to full replay, export, and comparator review?"},collaboration:{key:"collaboration",label:"Collaboration",description:"How often do teams share scenarios or comparator snapshots?"}},Js={"comparator.scenario.select":"activation","comparator.scenario.preview":"activation","comparator.preset.select":"activation","comparator.scenario.filter":"activation","comparator.scenario.tag_toggle":"funnel_drop","comparator.scenario.tag_clear":"funnel_drop","comparator.summary.copied":"activation","comparator.diff.opened":"funnel_drop","comparator.overlay.inspect":"activation","comparator.schema.change":"activation","comparator.clock.control":"funnel_drop","comparator.consumer.toggle":"funnel_drop","comparator.consumer.rate_toggle":"funnel_drop","comparator.consumer.rate_adjust":"activation","comparator.consumer.rate_reset":"activation","comparator.event.search":"activation","comparator.event.filter":"activation","comparator.panel.layout":"adoption","comparator.event.download":"adoption","comparator.event.clear":"adoption","comparator.event.copy":"activation","comparator.event.copy.error":"quality_gate","comparator.event.replay":"activation","comparator.destination.download":"adoption","comparator.generator.toggle":"adoption","comparator.generator.rate_adjust":"adoption","comparator.generator.burst":"activation","tour.started":"funnel_drop","tour.completed":"activation","tour.dismissed":"funnel_drop","workspace.share.generated":"collaboration","workspace.scenario.imported":"scenario_completeness","workspace.scenario.template_loaded":"activation","workspace.scenario.exported":"scenario_completeness","telemetry.flush":"activation"},hn=t=>!!t&&typeof t=="object"&&!Array.isArray(t),It=t=>{if(!hn(t))return{};const e={};return Object.keys(t).forEach(a=>{e[a]=t[a]}),e},Va=()=>({getItem:()=>null,setItem:()=>{}}),Ga=t=>{try{return t.toISOString()}catch{return new Date().toISOString()}},Wa=t=>{if(!hn(t))return null;const e=typeof t.event=="string"?t.event:null;if(!e)return null;const a=It(t.payload),r=It(t.context),c=typeof t.recordedAt=="string"?t.recordedAt:typeof t.recorded_at=="string"?t.recorded_at:null,m=c&&!Number.isNaN(Date.parse(c))?c:new Date().toISOString(),f=t.question,_=typeof f=="string"&&f in pn?f:null;return{event:e,payload:a,context:r,question:_,recordedAt:m}},Ha=t=>({event:t.event,payload:t.payload,context:t.context,question:t.question,recordedAt:t.recordedAt}),za=(t={})=>{const e=t.storage??(typeof window<"u"&&window.localStorage?window.localStorage:Va()),a=t.storageKey??Ba,r=Math.max(1,t.maxEntries??qa),c=t.now??(()=>new Date),m=t.console??(typeof console<"u"?{warn:console.warn.bind(console),debug:console.debug.bind(console)}:{warn:()=>{},debug:()=>{}}),_=(()=>{try{const w=e.getItem(a);if(!w)return[];const i=JSON.parse(w);return Array.isArray(i)?i.map(Wa).filter(l=>!!l).slice(-r):[]}catch(w){return m.warn("Telemetry buffer load failed",w),[]}})(),T=()=>{try{const w=_.slice(-r).map(Ha);e.setItem(a,JSON.stringify(w))}catch(w){m.warn("Telemetry buffer save failed",w)}};return{buffer:_,track:(w,i={},p={})=>{if(typeof w!="string"||!w.trim())return;const l=w.trim(),y={event:l,payload:It(i),context:It(p),question:Js[l]??null,recordedAt:Ga(c())};_.push(y),_.length>r&&_.splice(0,_.length-r),T(),y.context.debug&&m.debug("[telemetry]",y)},flush:()=>{if(_.length===0)return[];const w=_.slice();return _.length=0,T(),w},questions:()=>Object.values(pn).map(w=>({...w})),taxonomy:()=>({...Js})}};class Qa{constructor(){this.scenario=null,this.engines=[],this.idx=0,this.now=0,this.playing=!1}attach(e){this.engines=e}load(e){this.scenario=e,this.idx=0,this.now=0,this.playing=!1}reset(e){this.engines.forEach(a=>a.reset(e)),this.idx=0,this.now=0}onTick(e){this.onTickCb=e}start(){this.playing=!0}pause(){this.playing=!1}tick(e){if(!this.playing||!this.scenario)return;this.now+=e;const{ops:a}=this.scenario;for(;this.idx<a.length&&a[this.idx].t<=this.now;){const r=a[this.idx++];this.engines.forEach(c=>c.applySourceOp(r))}this.engines.forEach(r=>r.tick(this.now)),this.onTickCb?.(this.now)}}const Ka=new Set(["c","u","d"]);function Ja(t){switch(t.op){case"insert":return"c";case"update":return"u";case"delete":return"d";default:return null}}function Ya(t){return t.map((e,a)=>{const r=Ja(e);if(!r)return null;const c=e.pk?.id!=null?String(e.pk.id):"";return{key:`${r}::${c}`,op:r,pk:c,index:a,time:e.t}}).filter(e=>!!e)}function Xa(t){return t.map((e,a)=>{if(!Ka.has(e.op))return null;const r=e.pk?.id!=null?String(e.pk.id):"",c=e.op;return{key:`${c}::${r}`,op:c,pk:r,index:a,time:e.ts_ms}}).filter(e=>!!e)}function Ys(t){const e=new Map;for(const a of t){const r=e.get(a.key);r?r.push(a):e.set(a.key,[a])}return e}function Za(t,e){const a=[],r=[],c=[],m=Ys(t),f=Ys(e),_=new Set([...m.keys(),...f.keys()]);for(const T of _){const I=m.get(T)??[],C=f.get(T)??[],x=Math.min(I.length,C.length);for(let g=0;g<x;g++){const w=I[g],i=C[g];a.push({expected:w,actual:i,lagMs:Math.max(0,i.time-w.time)})}for(let g=x;g<I.length;g++)r.push(I[g]);for(let g=x;g<C.length;g++)c.push(C[g])}return{matched:a,missing:r,extra:c}}function er(t){const e=[],a=[...t].sort((c,m)=>c.actual.index-m.actual.index);let r=-1/0;for(const c of a)c.expected.index<r?e.push({type:"ordering",op:c.expected.op,pk:c.expected.pk,expectedIndex:c.expected.index,actualIndex:c.actual.index,expectedTime:c.expected.time,actualTime:c.actual.time}):r=c.expected.index;return e}function tr(t){return t.filter(e=>e.lagMs>0).sort((e,a)=>a.lagMs-e.lagMs).slice(0,5).map(e=>({op:e.expected.op,pk:e.expected.pk,expectedTime:e.expected.time,actualTime:e.actual.time,lagMs:e.lagMs}))}function sr(t,e,a){const r=Ya(e),c=Xa(a),{matched:m,missing:f,extra:_}=Za(r,c),T=[];for(const x of f)T.push({type:"missing",op:x.op,pk:x.pk,expectedIndex:x.index,expectedTime:x.time});for(const x of _)T.push({type:"extra",op:x.op,pk:x.pk,actualIndex:x.index,actualTime:x.time});T.push(...er(m));const I=tr(m),C=I.reduce((x,g)=>Math.max(x,g.lagMs),0);return{method:t,totals:{missing:T.filter(x=>x.type==="missing").length,extra:T.filter(x=>x.type==="extra").length,ordering:T.filter(x=>x.type==="ordering").length},issues:T,lag:{max:C,samples:I}}}const nr=`# Harness Nightly History

Run \`GITHUB_TOKEN=... npm run harness:history\` to refresh this summary. The script aggregates the latest Harness Nightly artifacts and records table-level parity results here so the app can surface them inline.

| Run | Date | Conclusion | Events | Missing | Extra | Max Lag (ms) | Tables | Mismatches |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| _No runs captured yet._ |   |   |   |   |   |   |   |   |

`,ar="workspace",rr=t=>({...t}),or=t=>!Array.isArray(t)||t.length===0?[{name:"id",type:"string",pk:!0}]:t.filter(e=>e&&typeof e.name=="string").map(e=>{const a={name:e.name,type:"string",pk:!!e.pk},r=e.type;if(typeof r=="string"){const c=r.toLowerCase();c==="number"||c==="bool"||c==="timestamp"?a.type=c:c==="string"&&(a.type="string")}return typeof e.nullable=="boolean"&&(a.nullable=e.nullable),a}),ir=t=>t.type?String(t.type).toLowerCase():"string",lr=t=>{const e=t.find(a=>a.pk);return e?.name?e.name:"id"},Xs=(t,e,a)=>Array.isArray(a)&&a.length>0?a.reduce((r,c)=>(c===e||Object.prototype.hasOwnProperty.call(t,c)&&(r[c]=t[c]),r),{}):Object.entries(t).reduce((r,[c,m])=>(c===e||(r[c]=m),r),{}),Zs=(t,e,a,r)=>{const c=ir(t);if(c==="number"){const f=e.seq*10+a;return typeof r=="number"?r+1:f}if(c==="bool"||c==="boolean")return typeof r=="boolean"?!r:a%2===0;if(c==="timestamp")return e.logicalTime+a+1;const m=`${e.seq}_${a}_${e.opCounter}`;return`${t.name}_${m}`},cr=(t,e={})=>{const a=or(t.schema),r=lr(a),c=new Map;(Array.isArray(t.rows)?t.rows:[]).forEach(T=>{if(!T||typeof T!="object")return;const I=T,C=I[r]??I.id;if(C==null)return;const x=String(C),g={};Object.entries(I).forEach(([w,i])=>{if(w===r){g[w]=String(i);return}w==="id"&&r!=="id"||(g[w]=i)}),Object.prototype.hasOwnProperty.call(g,r)||(g[r]=x),c.set(x,g)});const f=Array.isArray(t.ops)?t.ops.reduce((T,I)=>Math.max(T,I?.t??0),0):0;return{table:typeof t.table=="string"&&t.table.trim().length?t.table:e.fallbackTable??ar,columns:a,pkField:r,rows:c,logicalTime:f,seq:c.size+1,opCounter:0}},dr=(t,e,a)=>{const r=Math.max(1,Math.floor(e)||1),c=Array.from(t.rows.keys()),m=t.columns.filter(C=>C.name!==t.pkField);let f="insert";if(c.length>0&&m.length>0){const C=t.opCounter%6;(C===0||C===4)&&c.length>1?f="delete":C===1||C===2||C===3?f="update":f="insert"}else c.length>1&&m.length===0&&(f=t.opCounter%3===0?"delete":"insert");const _=t.opCounter;t.opCounter+=1;const T=Math.max(t.logicalTime,a);t.logicalTime=T+r;const I=t.logicalTime;if(f==="insert"){const C=`gen-${t.seq++}`,x={[t.pkField]:C};m.forEach((i,p)=>{x[i.name]=Zs(i,t,p)}),t.rows.set(C,x);const g=Xs(x,t.pkField);return{op:{t:I,op:"insert",table:t.table,pk:{id:C},after:g},kind:f}}if(f==="update"&&c.length>0&&m.length>0){const C=_%c.length,x=c[C],g=t.rows.get(x);if(!g)return null;const w=m[_%m.length],i=Zs(w,t,_,g[w.name]),p=rr(g);p[w.name]=i,t.rows.set(x,p);const l=Xs(p,t.pkField,[w.name]);return{op:{t:I,op:"update",table:t.table,pk:{id:x},after:l},kind:f}}if(f==="delete"&&c.length>0){const C=_%c.length,x=c[C];return t.rows.delete(x),{op:{t:I,op:"delete",table:t.table,pk:{id:x}},kind:f}}return null};function q(t,e={},a={}){if(typeof window>"u")return;const r=window.telemetry;!r||typeof r.track!="function"||r.track(t,e,a)}function ot(t,e={}){q("comparator.clock.control",{action:t,...e})}function ur({onDiffDetailsOpened:t,...e}){const a=r=>{t?.(r),q("comparator.diff.opened",{method:r.method,issues:r.issueCount,maxLag:r.maxLag,scenario:r.scenario})};return n.jsx($a,{...e,onDiffDetailsOpened:a})}function pr(t){const e={...t};return t.pk&&(e.pk={...t.pk}),t.after&&(e.after={...t.after}),t.txn&&(e.txn={...t.txn}),e}function hr(t){return{id:t.id,name:t.id||t.name,label:t.label,description:t.description,highlight:t.highlight,stats:{rows:t.rows.length,ops:t.ops.length},table:t.table,tags:[...t.tags],schema:t.schema.length?t.schema.map(e=>({...e})):void 0,rows:t.rows.length?t.rows.map(e=>({...e})):void 0,events:t.events.length?t.events.map(e=>({...e})):void 0,schemaVersion:t.schemaVersion,seed:t.seed,ops:t.ops.map(pr)}}const mn=la;mn.length===0&&typeof console<"u"&&console.warn("No scenario templates were loaded from assets/shared-scenarios.js; the comparator scenario gallery will be empty.");const St=mn.map(hr),gn={polling:{label:"Polling (Query)",laneDescription:"Simple, but lossy. Periodic scans read current state only; hard deletes and mid-poll updates can disappear.",callout:"Polling reads current state only. Hard deletes and intermediate updates are not captured.",whenToUse:"Simple, but lossy. Periodic scans read current state only. Hard deletes and intermediate updates between polls are not observable. Good for small, non-critical syncs where some lag and loss is acceptable."},trigger:{label:"Trigger (Audit)",laneDescription:"Complete, but intrusive. Database triggers write to an audit table and add synchronous source overhead.",callout:"Triggers add write overhead to source transactions.",whenToUse:"Complete, but intrusive. Triggers capture every change into an audit table, but add write latency and operational overhead on the source. Use when log access isn’t available."},log:{label:"Log (WAL)",laneDescription:"Default choice. Streams the transaction log post-commit for ordered, low-latency change events.",callout:"Log-based CDC is the preferred default when available.",whenToUse:"Default choice. Reads the database’s transaction log post-commit. Lowest source impact, complete and ordered changes, near-real-time. Requires connector setup and ops discipline."}};typeof window<"u"&&(window.CDC_METHOD_COPY=gn);const Ge="workspace-live",fn="cdc_comparator_prefs_v1",Ce={name:"priority_flag",type:"bool"};function mr(t,e,a,r){if(a.length===0)return 0;const c=t[e]?.metrics.writeAmplification;if(typeof c=="number"&&c>=0)return c;const m=r.ops.filter(f=>f.table===a[0]?.table);return m.length?a.length/m.length:a.length}const he=["polling","trigger","log"],bn=2,ve=100,xn=10,yn=300,ss=120,gr=10,vn=10,_n=600,wn=120,ns=10,Yt=40,fr=5,je=["c","u","d","s"],en="MYSQL_DEBEZIUM";function Mt(t){return typeof t=="string"&&Object.prototype.hasOwnProperty.call(jt,t)}const br=gn,H=cn,Xt=200,xr=2e3,yr=6;function vr(){if(typeof window>"u")return new Set;const e=window.cdcFeatureFlags?.all?.();if(Array.isArray(e)&&e.length)return new Set(e.map(String));const a=window.APPWRITE_CFG?.featureFlags;return Array.isArray(a)&&a.length?new Set(a.map(String)):new Set}const _r={polling:{pollIntervalMs:500,includeSoftDeletes:!1},trigger:{extractIntervalMs:250,triggerOverheadMs:8},log:{fetchIntervalMs:50}},wr={polling:"QUERY_BASED",trigger:"TRIGGER_BASED",log:"LOG_BASED"},Sr={polling:"polling",trigger:"trigger",log:"log"},tn=t=>{switch(t){case"polling":return ba();case"trigger":return va();case"log":default:return ga()}},sn=t=>{if(!t)return null;const e={...t};return delete e.__ts,e},Er=t=>{if(t==null)return"—";if(typeof t=="boolean")return t?"true":"false";if(typeof t=="number")return Number.isFinite(t)?t.toString():"—";if(t instanceof Date)return t.toISOString();if(typeof t=="object")try{return JSON.stringify(t)}catch{return"[object]"}return String(t)},Sn=(t,e,a)=>{const r=e.kind==="INSERT"?"c":e.kind==="UPDATE"?"u":e.kind==="DELETE"?"d":"s",c=e.schemaChange?{action:e.schemaChange.action,column:{name:e.schemaChange.column.name,type:e.schemaChange.column.type,nullable:e.schemaChange.column.nullable},previousVersion:e.schemaChange.previousVersion,nextVersion:e.schemaChange.nextVersion}:null,m=e.after?.id??e.before?.id??c?.column?.name??null,f=m!=null?String(m):"";return{source:"demo-db",table:e.table,op:r,pk:{id:f},before:sn(e.before),after:sn(e.after),ts_ms:e.commitTs,tx:{id:e.txnId??`tx-${e.commitTs}`,lsn:typeof e.offset=="number"?e.offset:null,index:typeof e.txnIndex=="number"?e.txnIndex:void 0,total:typeof e.txnTotal=="number"?e.txnTotal:void 0,last:typeof e.txnLast=="boolean"?e.txnLast:typeof e.txnTotal=="number"&&typeof e.txnIndex=="number"?e.txnIndex>=e.txnTotal-1:!0},seq:a,meta:{method:Sr[t]},schemaChange:c}};function Cr(t,e){const a=new da,r=new ua,c=new pa,m=`cdc.${t}`;let f=tn(t),_,T={bus:a,metrics:r,scheduler:c,topic:m},I={},C=0;const x=new Set,g=l=>{const y=l.__seq,M=typeof y=="number"&&y>0?y:++C;return l.__seq=M,{...Sn(t,l,M),offset:l.offset,topic:l.topic??m}},w=l=>y=>{const M=l(y);if(M.length){const L=M.map(D=>g(D));e(L),L.forEach(D=>x.forEach(V=>V(D)))}return M},i=()=>{f.initialise?.(T),f.configure?.(I),_=new ha(wr[t],a,c,r,m,{startSnapshot:(l,y)=>f.startSnapshot?.(l,M=>w(y)(M)),startTailing:l=>f.startTailing?.(y=>w(l)(y)),stop:()=>f.stop?.()}),_.startSnapshot([]),_.startTailing()};return i(),{name:t,configure(l){I={...l},f.configure?.(l)},reset(l){_.stop(),c.clear(),r.reset(),a.reset(m),C=0,f=tn(t),T={bus:a,metrics:r,scheduler:c,topic:m},i()},applySourceOp(l){f.applySource?.(l)},applySchemaChange(l,y,M,L){const D=y==="add"?"ADD_COLUMN":"DROP_COLUMN";f.applySchemaChange?.(l,D,M,L)},tick(l){f.tick?.(l)},onEvent(l){return x.add(l),()=>x.delete(l)},bus:a,metrics:r,topic:m}}function jr(t,e){return Cr(t,e)}function We(t){return t.reduce((e,a)=>(e[a]=[],e),{})}function kr(t){return{polling:{...t.polling},trigger:{...t.trigger},log:{...t.log}}}function Et(t,e,a){let r=typeof t=="number"?t:Number(t);return Number.isFinite(r)?(typeof a=="number"&&(r=Math.max(a,r)),r):e}function Ct(t,e=ss){if(typeof t!="number"||!Number.isFinite(t))return e;const a=Math.round(t);return Number.isFinite(a)?Math.min(yn,Math.max(xn,a)):e}function Zt(t,e=wn){if(typeof t!="number"||!Number.isFinite(t))return e;const a=Math.round(t/ns)*ns;return Number.isFinite(a)?Math.min(_n,Math.max(vn,a)):e}function nn(t){if(!Array.isArray(t))return[...he];const e=[];return he.forEach(a=>{t.includes(a)&&!e.includes(a)&&e.push(a)}),e.length>=bn?e:[...he]}function Lr(t){const e=Array.from(je);if(!Array.isArray(t)||t.length===0)return new Set(e);const a=[];return t.forEach(r=>{if(je.includes(r)){const c=r;a.includes(c)||a.push(c)}}),a.length?new Set(a):new Set(e)}function an(t){return typeof t=="string"&&he.includes(t)}function rn(t){const e=kr(_r);return t&&(t.polling&&(t.polling.pollIntervalMs!=null&&(e.polling.pollIntervalMs=Et(t.polling.pollIntervalMs,e.polling.pollIntervalMs,50)),t.polling.includeSoftDeletes!=null&&(e.polling.includeSoftDeletes=!!t.polling.includeSoftDeletes)),t.trigger&&(t.trigger.extractIntervalMs!=null&&(e.trigger.extractIntervalMs=Et(t.trigger.extractIntervalMs,e.trigger.extractIntervalMs,50)),t.trigger.triggerOverheadMs!=null&&(e.trigger.triggerOverheadMs=Et(t.trigger.triggerOverheadMs,e.trigger.triggerOverheadMs,0))),t.log&&t.log.fetchIntervalMs!=null&&(e.log.fetchIntervalMs=Et(t.log.fetchIntervalMs,e.log.fetchIntervalMs,10))),e}function Tr(){if(typeof window>"u")return null;try{const t=window.localStorage.getItem(fn);if(!t)return null;const e=JSON.parse(t);return{scenarioId:typeof e.scenarioId=="string"?e.scenarioId:void 0,presetId:Mt(e.presetId)?e.presetId:void 0,activeMethods:Array.isArray(e.activeMethods)?e.activeMethods:void 0,methodConfig:e.methodConfig??void 0,userPinnedScenario:typeof e.userPinnedScenario=="boolean"?e.userPinnedScenario:void 0,showEventList:typeof e.showEventList=="boolean"?e.showEventList:void 0,eventOps:Array.isArray(e.eventOps)?e.eventOps:void 0,eventSearch:typeof e.eventSearch=="string"?e.eventSearch:void 0,eventLogTable:typeof e.eventLogTable=="string"?e.eventLogTable:void 0,eventLogTxn:typeof e.eventLogTxn=="string"?e.eventLogTxn:void 0,eventLogMethod:typeof e.eventLogMethod=="string"?e.eventLogMethod:void 0,eventLogOp:typeof e.eventLogOp=="string"?e.eventLogOp:void 0,applyOnCommit:typeof e.applyOnCommit=="boolean"?e.applyOnCommit:void 0,consumerRateEnabled:typeof e.consumerRateEnabled=="boolean"?e.consumerRateEnabled:void 0,consumerRateLimit:typeof e.consumerRateLimit=="number"?e.consumerRateLimit:void 0,generatorEnabled:typeof e.generatorEnabled=="boolean"?e.generatorEnabled:void 0,generatorRate:typeof e.generatorRate=="number"?e.generatorRate:void 0}}catch(t){return console.warn("Comparator prefs load failed",t),null}}function Mr(t){if(!(typeof window>"u"))try{window.localStorage.setItem(fn,JSON.stringify(t))}catch(e){console.warn("Comparator prefs save failed",e)}}function Ar(t,e,a,r,c,m){const f=t.length?t[t.length-1]:null,_=f?Math.max(e-f.ts_ms,0):e,T=e>0?t.length/(e/1e3):0;let I=0,C=0,x=0,g=0;t.forEach(L=>{L.op==="c"?I+=1:L.op==="u"?C+=1:L.op==="d"&&(x+=1),L.schemaChange&&(g+=1)});const w=a.ops.filter(L=>L.op==="delete").length,i=m?.deletes??0,p=w+i,l=p===0?100:x/p*100,y=t.every((L,D)=>{if(D===0)return!0;const V=t[D-1];return L.ts_ms>=V.ts_ms});return{lagMs:_,throughput:T,deletesPct:l,orderingOk:y,consistent:y&&(r==="polling"?x===p:!0),writeAmplification:r==="trigger"?mr(c,r,t,a)??0:void 0,insertCount:I,updateCount:C,deleteCount:x,schemaChangeCount:g}}function Ir(t){if(t.length===0)return null;const e=[...t].sort((x,g)=>x.metrics.lagMs-g.metrics.lagMs),a=e[0],r=e[e.length-1],c=r.metrics.lagMs-a.metrics.lagMs,m=[...t].sort((x,g)=>x.metrics.deletesPct-g.metrics.deletesPct),f=m[0],_=m[m.length-1],T=t.filter(x=>!x.metrics.orderingOk).map(x=>x.method),I=t.filter(x=>x.method==="trigger"&&typeof x.metrics.writeAmplification=="number"),C=I.length?I.reduce((x,g)=>x.metrics.writeAmplification?g.metrics.writeAmplification&&g.metrics.writeAmplification>x.metrics.writeAmplification?g:x:g):null;return{bestLag:a,worstLag:r,lagSpread:c,lowestDeletes:f,highestDeletes:_,orderingIssues:T,triggerWriteAmplification:C}}function Or(){const t=u.useRef(null);t.current===null&&(t.current=Tr());const e=t.current||void 0,a=nn(e?.activeMethods),r=rn(e?.methodConfig),c=e?.presetId&&Mt(e.presetId)?e.presetId:en,m=an(e?.eventLogMethod)?e?.eventLogMethod:null,f=typeof e?.eventLogOp=="string"&&e.eventLogOp.trim()?e.eventLogOp.trim().toLowerCase():null,_=u.useMemo(()=>typeof window>"u"?{...At}:Ca(window.localStorage),[]),[T,I]=u.useState(null),[C,x]=u.useState(()=>e?.scenarioId??St[0].name),[g,w]=u.useState(()=>_.query),[i,p]=u.useState(()=>_.tags),[l,y]=u.useState(()=>a),[M,L]=u.useState(()=>We(a)),[D,V]=u.useState(()=>We(a)),[K,ke]=u.useState(()=>({})),[Le,He]=u.useState(c),[z,ze]=u.useState(0),[j,G]=u.useState(!1),[W,Ot]=u.useState(!1),[Q,it]=u.useState(()=>r),[be,Te]=u.useState(!1),[Y,Qe]=u.useState(()=>e?.eventSearch??""),[as,En]=u.useState(()=>Lr(e?.eventOps)),[Me,Cn]=u.useState(e?.showEventList??!0),[ae,Ke]=u.useState(e?.eventLogTable??null),[ee,Je]=u.useState(e?.eventLogTxn??""),[re,Ae]=u.useState(m),[oe,Ye]=u.useState(f),[_e,rs]=u.useState(e?.applyOnCommit??!1),[ie,os]=u.useState(e?.consumerRateEnabled??!1),[me,is]=u.useState(()=>Ct(e?.consumerRateLimit,ss)),[le,ls]=u.useState(e?.generatorEnabled??!1),[te,cs]=u.useState(()=>Zt(e?.generatorRate,wn)),[Nt,jn]=u.useState(()=>vr()),xe=u.useRef({}),ce=u.useRef({}),Ie=u.useRef({}),ds=u.useRef(e?.consumerRateEnabled??!1?Ct(e?.consumerRateLimit,ss):null),Xe=u.useRef(0),Dt=u.useRef(null),Ze=u.useRef(0),us=u.useRef(te),ps=u.useRef(le),et=u.useRef({inserts:0,updates:0,deletes:0}),Rt=u.useRef({}),hs=u.useRef(l),ms=u.useRef(z),F=jt[Le]??jt[en],kn=u.useMemo(()=>Object.values(jt).map(s=>({id:s.id,label:s.label})),[]),R=u.useMemo(()=>{const s=F.methodCopyOverrides??{};return he.reduce((o,d)=>{const h=br[d],k=s[d];return o[d]={label:k?.label??h.label,laneDescription:k?.laneDescription??h.laneDescription,callout:k?.callout??h.callout,whenToUse:k?.whenToUse??h.whenToUse,tooltip:k?.tooltip??h.tooltip},o},{})},[F]),gs=u.useMemo(()=>new Set(i),[i]),fs=u.useMemo(()=>Ma(St,{liveScenario:T??void 0,additionalTags:[i]}),[T,i]);u.useEffect(()=>{typeof window>"u"||ja({query:g,tags:i},window.localStorage)},[g,i]);const ye=u.useCallback((s,o)=>{if(typeof window>"u")return;const d=es({query:s,tags:o});window.dispatchEvent(new CustomEvent("cdc:scenario-filter",{detail:d}))},[]);u.useEffect(()=>{if(typeof window>"u")return;const s=()=>{ye(g,i)};return window.addEventListener("cdc:scenario-filter-request",s),()=>{window.removeEventListener("cdc:scenario-filter-request",s)}},[ye,g,i]);const bs=u.useMemo(()=>nr.trim(),[]),lt=u.useCallback(s=>{let o=Ie.current[s];return o||(o=new Jt,Ie.current[s]=o),o},[]),Oe=u.useCallback(s=>{Dt.current=cr(s),Ze.current=0,et.current={inserts:0,updates:0,deletes:0}},[]),ct=u.useCallback((s,o)=>{const d=Dt.current;if(!d||s<=0)return;const h=hs.current;if(!h.length)return;const k=Rt.current;for(let E=0;E<s;E+=1){const S=dr(d,o,ms.current);S&&(h.forEach(v=>{k[v]?.applySourceOp(S.op)}),S.kind==="insert"?et.current.inserts+=1:S.kind==="update"?et.current.updates+=1:S.kind==="delete"&&(et.current.deletes+=1))}},[]),dt=u.useCallback(s=>{if(!ps.current||!Dt.current)return;const o=us.current;if(!Number.isFinite(o)||o<=0)return;Ze.current+=o*s/1e3;const d=Math.floor(Ze.current);if(d<=0)return;Ze.current-=d;const h=d>0?s/d:s;ct(d,h)},[ct]),de=u.useCallback((s,o)=>{const d=xe.current[s];if(!d)return;const h=d.metrics.snapshot(),k=d.bus.size(d.topic);ke(E=>({...E,[s]:{metrics:h,backlog:k,lastOffset:o?.lastOffset??E[s]?.lastOffset??-1}}))},[]),xs=u.useCallback((s,o)=>{o.length&&(V(d=>{const h={...d},k=h[s]??[];return h[s]=[...k,...o],h}),de(s,{lastOffset:o[o.length-1]?.offset??-1}))},[de]);u.useEffect(()=>{if(typeof window>"u")return;const s=o=>{if(!(o instanceof CustomEvent))return;const d=o.detail,h=Array.isArray(d)?d:[];jn(new Set(h.map(String)))};return window.addEventListener("cdc:feature-flags",s),()=>{window.removeEventListener("cdc:feature-flags",s)}},[]);const ut=u.useCallback(s=>Nt.size===0?!0:Nt.has(s),[Nt]),pt=ut("ff_event_bus"),$t=ut("ff_pause_resume"),Ln=ut("ff_query_slider"),Tn=ut("ff_event_log"),Ne=u.useMemo(()=>Array.from(as).sort(),[as]),ys=u.useMemo(()=>new Set(Ne),[Ne]),De=u.useMemo(()=>Y.trim().toLowerCase().split(/\s+/).filter(Boolean),[Y]),vs=u.useMemo(()=>De.join("|"),[De]),_s=u.useRef(new WeakMap),ht=u.useCallback(s=>{const o=new Set(Ne),d=o.size<je.length,h=De.length>0,k=_s.current,E=new Map,S=v=>{const A=k.get(v);if(A)return A;const O=[String(v.seq??""),v.op,v.pk?.id??"",v.table??""];v.after&&O.push(...Object.values(v.after).map($=>String($??""))),v.before&&O.push(...Object.values(v.before).map($=>String($??"")));const P=O.join(" ").toLowerCase();return k.set(v,P),P};return l.forEach(v=>{const A=s[v]??[];if(!d&&!h){E.set(v,A);return}const O=A.filter(P=>{if(!o.has(P.op))return!1;if(!h)return!0;const $=S(P);return De.every(B=>$.includes(B))});E.set(v,O)}),E},[l,Ne,De]),Mn=u.useMemo(()=>ht(M),[ht,M,vs]),ws=u.useMemo(()=>ht(D),[ht,D,vs]),tt=u.useMemo(()=>{const s=[],o=new Set,d=new Set,h=new Set;return l.forEach(k=>{(ws.get(k)??[]).forEach(S=>{const v=S.table??"";v&&o.add(v);const A=S.tx?.id??null;A&&d.add(A);const O=typeof S.op=="string"?S.op.trim().toLowerCase():"";O&&h.add(O),s.push({method:k,event:S})})}),s.sort((k,E)=>{const S=k.event.offset??k.event.seq??0,v=E.event.offset??E.event.seq??0;return S!==v?S-v:(k.event.ts_ms??0)-(E.event.ts_ms??0)}),{events:s,tables:Array.from(o).sort(),txns:Array.from(d).sort(),ops:Array.from(h)}},[l,ws]),Pt=tt.events,mt=tt.tables,gt=tt.txns,Ft=u.useMemo(()=>{const s=new Set(tt.ops),o=je.filter(h=>s.has(h)),d=Array.from(s).filter(h=>!je.includes(h));return d.sort(),[...o,...d]},[tt.ops]),Re=u.useMemo(()=>Pt.filter(({method:s,event:o})=>{if(re&&s!==re||ae&&(o.table??"")!==ae||ee&&(o.tx?.id??"")!==ee)return!1;const d=typeof o.op=="string"?o.op.trim().toLowerCase():"";return!(oe&&d!==oe)}),[Pt,re,oe,ae,ee]),An=u.useMemo(()=>Re.map(({method:s,event:o},d)=>{const h=typeof o.offset=="number"?o.offset:null,k=typeof o.seq=="number"?o.seq:null,E=typeof o.ts_ms=="number"?o.ts_ms:null,S=[s,h!=null?`offset-${h}`:null,k!=null?`seq-${k}`:null,E!=null?`ts-${E}`:null,d].filter(Boolean),v=o.pk?.id!=null?String(o.pk.id):null,A=o.schemaChange?n.jsxs("span",{className:"sim-shell__event-log-schema",children:[o.schemaChange.action==="ADD_COLUMN"?"Added":"Dropped"," column ",o.schemaChange.column.name,` · v${o.schemaChange.previousVersion}→v${o.schemaChange.nextVersion}`]}):void 0;return{id:S.length?S.join("|"):`${s}-${d}`,methodId:s,methodLabel:R[s].label,op:o.op??"",offset:h,topic:o.topic??null,table:o.table??null,tsMs:E,pk:v,txnId:o.tx?.id??null,before:o.before??null,after:o.after??null,meta:A}}),[Re,R]),In=u.useMemo(()=>({methodId:re??void 0,op:oe??void 0,table:ae??void 0,txnId:ee||void 0}),[re,oe,ae,ee]),On=u.useMemo(()=>({methods:he.map(s=>({id:s,label:R[s].label})),ops:Ft,tables:mt,txns:gt}),[mt,gt,R]),st=u.useMemo(()=>{const s=new Map;return l.forEach(o=>{const h=lt(o).snapshot(),k=["table","id"],E=new Set(k);let S=1;h.forEach(O=>{S=Math.max(S,O.schema?.version??1),O.schema?.columns.forEach(P=>{if(!P)return;const $=P.name;!$||$==="id"||$.startsWith("__")||E.has($)||(E.add($),k.push($))})}),h.forEach(O=>{O.rows.forEach(P=>{Object.keys(P).forEach($=>{$==="id"||$.startsWith("__")||E.has($)||(E.add($),k.push($))})})});const v=h.flatMap(O=>O.rows.map(P=>{const $=String(P.id),B={};return k.forEach(J=>{if(J==="table"||J==="id"||J.startsWith("__"))return;const ue=P[J];B[J]=ue??null}),{id:`${O.name}::${$}`,displayId:$,table:O.name,values:B}})).sort((O,P)=>O.id.localeCompare(P.id,void 0,{numeric:!0,sensitivity:"base"})),A=E.has(Ce.name);s.set(o,{columns:k,rows:v,schemaVersion:S,hasSchemaColumn:A})}),s},[l,lt,M]),Ss=u.useRef(j),ft=u.useRef(0);u.useEffect(()=>{re&&!l.includes(re)&&Ae(null)},[l,re]),u.useEffect(()=>{ae&&!mt.includes(ae)&&Ke(null)},[mt,ae]),u.useEffect(()=>{oe&&!Ft.includes(oe)&&Ye(null)},[Ft,oe]),u.useEffect(()=>{ee&&!gt.includes(ee)&&Je("")},[gt,ee]),u.useEffect(()=>{hs.current=l},[l]),u.useEffect(()=>{ms.current=z},[z]),u.useEffect(()=>{ps.current=le,le||(Ze.current=0)},[le]),u.useEffect(()=>{us.current=te},[te]);const $e=u.useRef(e?.userPinnedScenario??!1),ge=u.useMemo(()=>Ta(St,{liveScenario:T??void 0,liveScenarioName:Ge,query:g,tags:i}),[T,g,i]),b=u.useMemo(()=>ge.length?ge.find(s=>s.name===C)??ge[0]:St[0],[C,ge]);u.useEffect(()=>{Oe(b)},[b,Oe]);const bt=u.useMemo(()=>{const s=new Map;return l.forEach(o=>{const d=st.get(o);s.set(o,{present:d?.hasSchemaColumn??!1,version:d?.schemaVersion??1})}),s},[l,st]),nt=u.useMemo(()=>l.length>0?l.every(s=>bt.get(s)?.present??!1):!1,[l,bt]),we=u.useMemo(()=>{let s=1;return l.forEach(o=>{const d=bt.get(o);d&&d.version>s&&(s=d.version)}),s},[l,bt]),Pe=u.useMemo(()=>!!b.tags?.includes("schema"),[b.tags]),Es=u.useMemo(()=>{if(!Pe)return null;const s=`v${we}`;return nt?`${s} · column present`:`${s} · column absent`},[nt,we,Pe]);u.useEffect(()=>{ft.current=0},[b.name]);const Ut=u.useMemo(()=>b.table?b.table:b.ops.find(o=>o.table)?.table??"table",[b.ops,b.table]);u.useEffect(()=>{if(!be)return;const s=window.setTimeout(()=>Te(!1),2e3);return()=>window.clearTimeout(s)},[be]),u.useEffect(()=>{if(typeof window>"u")return;const s=window.setTimeout(()=>{q("comparator.event.search",{scenario:b.name,query:Y,hasQuery:!!Y.trim()})},400);return()=>window.clearTimeout(s)},[Y,b.name]),u.useEffect(()=>{Ss.current=j},[j]),u.useEffect(()=>{ge.length&&(ge.some(s=>s.name===C)||($e.current=!1,x(ge[0].name)))},[C,ge]),u.useEffect(()=>{if(!be)return;const s=window.setTimeout(()=>Te(!1),2e3);return()=>window.clearTimeout(s)},[be]),u.useEffect(()=>{if(typeof window>"u")return;const s=o=>{if(!(o instanceof CustomEvent))return;const d=es(o.detail);w(h=>h===d.query?h:d.query),p(h=>wa(h,d.tags)?h:d.tags)};return window.addEventListener("cdc:scenario-filter",s),window.dispatchEvent(new CustomEvent("cdc:scenario-filter-request")),()=>{window.removeEventListener("cdc:scenario-filter",s)}},[]),u.useEffect(()=>{if(typeof window>"u")return;const s=o=>{if(!(o instanceof CustomEvent))return;const d=o.detail;if(!d||!d.scenario){I(null);return}const h=Array.isArray(d.scenario.ops)?d.scenario.ops:[],k=d.scenario.label??"Workspace (live)",E=d.scenario.description??`${h.length} operations`,S=d.scenario.seed??1;I({name:Ge,label:k,description:E,seed:S,ops:h})};return window.addEventListener("cdc:workspace-update",s),window.dispatchEvent(new CustomEvent("cdc:workspace-request")),()=>{window.removeEventListener("cdc:workspace-update",s)}},[]),u.useEffect(()=>{T&&T.ops.length&&($e.current||x(Ge))},[T]),u.useEffect(()=>{if(typeof window>"u")return;const s=o=>{if(!(o instanceof CustomEvent))return;const d=o.detail;if(!d){$e.current=!1;return}d.userPinnedScenario!=null&&($e.current=!!d.userPinnedScenario),d.activeMethods&&y(nn(d.activeMethods)),d.methodConfig&&it(rn(d.methodConfig)),d.scenarioId&&x(d.scenarioId),d.presetId&&Mt(d.presetId)&&He(d.presetId),typeof d.applyOnCommit=="boolean"&&rs(d.applyOnCommit),typeof d.consumerRateEnabled=="boolean"&&os(d.consumerRateEnabled),typeof d.consumerRateLimit=="number"&&is(Ct(d.consumerRateLimit)),typeof d.generatorEnabled=="boolean"&&ls(d.generatorEnabled),typeof d.generatorRate=="number"&&cs(Zt(d.generatorRate))};return window.addEventListener("cdc:comparator-preferences-set",s),()=>{window.removeEventListener("cdc:comparator-preferences-set",s)}},[]),u.useEffect(()=>{Mr({scenarioId:C,presetId:Le,activeMethods:l,methodConfig:Q,userPinnedScenario:$e.current,showEventList:Me,eventOps:Ne,eventSearch:Y,eventLogTable:ae,eventLogTxn:ee,eventLogMethod:re,eventLogOp:oe,applyOnCommit:_e,consumerRateEnabled:ie,consumerRateLimit:me,generatorEnabled:le,generatorRate:te})},[C,Le,l,Q,Me,Ne,Y,ae,ee,re,oe,_e,ie,me,le,te]);const Se=u.useRef(null),xt=u.useRef(null),se=u.useCallback(()=>{xt.current!=null&&(window.clearInterval(xt.current),xt.current=null)},[]),Fe=u.useCallback(()=>{if(W)return;const s={},o=ds.current;if(o!=null){const S=o*ve/1e3,v=Xe.current+S;Xe.current=Math.min(v,o*5)}let d=o==null?Number.POSITIVE_INFINITY:Xe.current;const h=S=>S.txnId??`tx-${S.commitTs}`,k=S=>{if(!S.length)return!1;const v=S[S.length-1];return typeof v.txnLast=="boolean"?v.txnLast:typeof v.txnIndex=="number"&&typeof v.txnTotal=="number"?v.txnIndex>=v.txnTotal-1:!0},E=(S,v)=>{const A=ce.current[S]??[];let O=A.length?[...A]:[];if(O.length&&(ce.current[S]=[]),!O.length){const $=v.bus.consume(v.topic,1);if(!$.length)return[];O=$}const P=h(O[0]);for(;!k(O);){const $=v.bus.consume(v.topic,1);if(!$.length)return ce.current[S]=O,[];const B=$[0];if(h(B)!==P){const ue=ce.current[S]??[];ce.current[S]=[B,...ue];break}O.push(B)}return O};for(const S of l){const v=xe.current[S];if(!v)continue;let A=[],O=0;if(_e){const B=E(S,v);if(!B.length)continue;if(o!=null&&B.length>d){ce.current[S]=B;continue}A=B,O=B.length}else{const B=ce.current[S]??[];if(B.length){if(o!=null&&B.length>d){ce.current[S]=B;continue}A=[...B],O+=B.length,ce.current[S]=[]}const J=o==null?Number.POSITIVE_INFINITY:d-O;if(o==null?!0:J>=1){const pe=o==null?50:Math.min(Math.floor(J),50),rt=o==null?50:Math.max(pe,0);if(rt>0){const ne=v.bus.consume(v.topic,rt);ne.length&&(A=A.length?A.concat(ne):ne,O+=ne.length)}}if(!A.length)continue}o!=null&&(d=Math.max(d-O,0)),lt(S).applyEvents(A),v.metrics.onConsumed(A);const $=A.map(B=>{const J=B.__seq??0;return Sn(S,B,J)});de(S),s[S]=$}o!=null&&(Xe.current=d),Object.keys(s).length!==0&&L(S=>{const v={...S};for(const[A,O]of Object.entries(s)){const P=v[A]??[];v[A]=[...P,...O]}return v})},[l,_e,lt,W,de]),Cs=u.useCallback(()=>{se(),xt.current=window.setInterval(()=>{Se.current?.tick(ve),dt(ve),Fe()},ve)},[se,Fe,dt]);u.useEffect(()=>{const s=ie?me:null;ds.current=s,s==null&&(Xe.current=0)},[ie,me]),u.useEffect(()=>{W||Fe()},[W,Fe]),u.useEffect(()=>{L(We(l)),V(We(l)),xe.current={},ce.current={},Ie.current={},l.forEach(E=>{Ie.current[E]=new Jt}),ze(0),G(!1),se(),Oe(b);const s=new Qa,o=[],d={},h={},k=l.map(E=>{const S=jr(E,O=>xs(E,O));if(h[E]=S,E==="polling"){const O=Q.polling;S.configure({poll_interval_ms:O.pollIntervalMs,include_soft_deletes:O.includeSoftDeletes})}else if(E==="trigger"){const O=Q.trigger;S.configure({extract_interval_ms:O.extractIntervalMs,trigger_overhead_ms:O.triggerOverheadMs})}else{const O=Q.log;S.configure({fetch_interval_ms:O.fetchIntervalMs})}const v={bus:S.bus,metrics:S.metrics,topic:S.topic,applySchemaChange:S.applySchemaChange};d[E]=v;const A=S.onEvent(O=>{L(P=>{const $={...P},B=$[E]??[];return $[E]=[...B,O],$})});return o.push(A),S});return xe.current=d,Rt.current=h,l.forEach(E=>de(E,{lastOffset:-1})),s.attach(k),s.load(b),s.reset(b.seed),s.onTick(E=>ze(E)),Se.current=s,()=>{s.pause(),se(),o.forEach(E=>E()),Rt.current={}}},[l,b,se,Q,de,xs,Oe]);const Nn=u.useCallback(s=>{y(o=>{if(o.includes(s))return o.length<=bn?o:o.filter(h=>h!==s);const d=[...o,s];return he.filter(h=>d.includes(h))})},[]),Dn=u.useCallback(s=>{En(o=>{const d=new Set(o);let h=!1;return d.has(s)?d.size>1&&(d.delete(s),h=!0):(d.add(s),h=!0),h&&q("comparator.event.filter",{scenario:b.name,op:s,active:d.has(s)}),h?d:o})},[b.name]),Rn=u.useCallback(s=>{Qe(s)},[]),$n=u.useCallback(()=>{Cn(s=>{const o=!s;return q("comparator.panel.layout",{scenario:b.name,showEvents:o}),o})},[b.name]),Pn=u.useCallback(()=>{os(s=>{const o=!s;return q("comparator.consumer.rate_toggle",{scenario:b.name,enabled:o}),o}),ie&&q("comparator.consumer.rate_reset",{scenario:b.name})},[ie,b.name]),Fn=u.useCallback(s=>{const o=Ct(s,me);o!==me&&(is(o),q("comparator.consumer.rate_adjust",{scenario:b.name,rate:o}))},[me,b.name]),Un=u.useCallback(()=>{ls(s=>{const o=!s;return q("comparator.generator.toggle",{scenario:b.name,enabled:o}),o})},[b.name]),Bn=u.useCallback(s=>{const o=Zt(s,te);o!==te&&(cs(o),q("comparator.generator.rate_adjust",{scenario:b.name,rate:o}))},[te,b.name]),qn=u.useCallback(()=>{ct(Yt,fr),q("comparator.generator.burst",{scenario:b.name,count:Yt})},[ct,b.name]),Vn=u.useCallback(s=>{s.methodId&&an(s.methodId)?Ae(s.methodId):Ae(null),Ke(s.table??null),Je(s.txnId??""),Ye(s.op?s.op.toLowerCase():null)},[Ae,Ye,Ke,Je]),Gn=u.useCallback(()=>{if(Re.length===0)return;const s=Re.map(({method:k,event:E})=>JSON.stringify({method:k,offset:E.offset??null,seq:E.seq,ts_ms:E.ts_ms,op:E.op,pk:E.pk,table:E.table,before:E.before,after:E.after,topic:E.topic})),o=new Blob([s.join(`
`)],{type:"application/json"}),d=URL.createObjectURL(o),h=document.createElement("a");h.href=d,h.download=`${b.name}-event-log.ndjson`,h.click(),URL.revokeObjectURL(d),q("comparator.event.download",{scenario:b.name,events:Re.length})},[Re,b.name]),Wn=u.useCallback(s=>{const o=Ie.current[s];if(!o)return;const d=o.snapshot(),h=(b.name||"scenario").replace(/[^a-z0-9-_]+/gi,"-"),k={scenario:b.name,method:s,tables:d},E=new Blob([JSON.stringify(k,null,2)],{type:"application/json"}),S=URL.createObjectURL(E),v=document.createElement("a");v.href=S,v.download=`${h}-${s}-destination.json`,v.click(),URL.revokeObjectURL(S);const A=d.reduce((O,P)=>O+(P.rows?.length??0),0);q("comparator.destination.download",{scenario:b.name,method:s,tables:d.length,rows:A})},[b.name]),Hn=u.useCallback(()=>{V(s=>{const o={...s};return l.forEach(d=>{o[d]=[]}),o}),_s.current=new WeakMap,q("comparator.event.clear",{scenario:b.name})},[l,b.name]),zn=u.useCallback(s=>{const o=JSON.stringify({method:s.methodId??null,methodLabel:s.methodLabel??null,op:s.op,offset:s.offset??null,topic:s.topic??null,table:s.table??null,ts_ms:s.tsMs??null,pk:s.pk??null,txnId:s.txnId??null,before:s.before??null,after:s.after??null},null,2);navigator.clipboard.writeText(o).then(()=>q("comparator.event.copy",{scenario:b.name,method:s.methodId??null,op:s.op,offset:s.offset??null})).catch(()=>{q("comparator.event.copy.error",{scenario:b.name,method:s.methodId??null})})},[b.name]),Qn=u.useCallback(s=>{if(typeof window>"u")return;const o=typeof s.op=="string"?s.op.trim().toLowerCase():"";if(o!=="c"&&o!=="u"&&o!=="d")return;const d={op:o,before:s.before??null,after:s.after??null,ts_ms:typeof s.tsMs=="number"?s.tsMs:void 0,table:s.table??void 0,key:s.pk?{id:s.pk}:void 0};window.dispatchEvent(new CustomEvent("cdc:workspace-replay-event",{detail:d})),q("comparator.event.replay",{scenario:b.name,method:s.methodId??null,table:s.table??null,op:o})},[b.name]),Kn=u.useCallback(s=>{Mt(s)&&(He(s),q("comparator.preset.select",{presetId:s}))},[]),Jn=u.useCallback(s=>{w(s),ye(s,i),q("comparator.scenario.filter",{query:s})},[ye,i]),Yn=u.useCallback(s=>{const o=i.includes(s),d=o?i.filter(h=>h!==s):[...i,s];p(d),ye(g,d),q("comparator.scenario.tag_toggle",{tag:s,active:!o})},[ye,g,i]),Xn=u.useCallback(()=>{i.length&&(p([]),ye(g,[]),q("comparator.scenario.tag_clear"))},[ye,g,i]),Zn=u.useCallback(s=>{$e.current=!0,x(s),q("comparator.scenario.select",{scenario:s})},[]),ea=u.useCallback(s=>{const o={id:s.id,name:s.name,label:s.label,description:s.description,highlight:s.highlight,tags:s.tags,table:s.table,schemaVersion:s.schemaVersion,seed:s.seed,schema:s.schema??[],rows:s.rows??[],events:s.events??[],ops:s.ops},d=new Blob([JSON.stringify(o,null,2)],{type:"application/json"}),h=document.createElement("a");h.href=URL.createObjectURL(d),h.download=`${s.name}.json`,h.click(),URL.revokeObjectURL(h.href)},[]),ta=u.useCallback(s=>{q("comparator.scenario.preview",{scenario:s.name,tags:s.tags??[]}),window.dispatchEvent(new CustomEvent("cdc:preview-scenario",{detail:s}))},[]),X=u.useMemo(()=>l.map(s=>{const o=M[s]??[];return{method:s,events:o,metrics:Ar(o,z,b,s,K,et.current)}}),[l,z,M,b,K]),fe=u.useMemo(()=>l.reduce((s,o)=>{const d=K[o],h=d?.metrics,k={backlog:d?.backlog??0,lastOffset:d?.lastOffset??-1,produced:h?.produced??0,consumed:h?.consumed??0,lagMsP50:h?.lagMsP50??0,lagMsP95:h?.lagMsP95??0,missedDeletes:h?.missedDeletes??0,writeAmplification:h?.writeAmplification??0,snapshotRows:h?.snapshotRows??0,errors:h?.errors??0};return s.set(o,k),s},new Map),[l,K]),Bt=u.useMemo(()=>l.reduce((s,o)=>s+(fe.get(o)?.backlog??0),0),[l,fe]),sa=u.useMemo(()=>pt?l.reduce((s,o)=>{const d=fe.get(o);return d&&(s.produced+=d.produced,s.consumed+=d.consumed,s.backlog+=d.backlog,s.snapshotRows+=d.snapshotRows),s},{produced:0,consumed:0,backlog:0,snapshotRows:0}):{produced:0,consumed:0,backlog:0,snapshotRows:0},[l,fe,pt]),N=Ir(X),js=u.useMemo(()=>X.reduce((s,o)=>s+o.events.length,0),[X]),yt=u.useMemo(()=>X.map(({method:s,events:o,metrics:d})=>({method:s,label:R[s].label,total:o.length,inserts:d.insertCount,updates:d.updateCount,deletes:d.deleteCount,schemaChanges:d.schemaChangeCount})),[X,R]),ks=u.useMemo(()=>yt.reduce((s,o)=>s.set(o.method,o),new Map),[yt]),Ue=u.useMemo(()=>{const s=new Map;return X.forEach(({method:o,events:d})=>{s.set(o,sr(o,b.ops,d))}),s},[X,b.ops]),Ls=u.useMemo(()=>l.map(s=>{const o=fe.get(s),d=ks.get(s);return{id:s,label:R[s].label,tooltip:R[s].tooltip,produced:o?.produced??0,consumed:o?.consumed??0,backlog:o?.backlog??0,lagP50:o?.lagMsP50??0,lagP95:o?.lagMsP95??0,missedDeletes:o?.missedDeletes,writeAmplification:o?.writeAmplification,snapshotRows:o?.snapshotRows,inserts:d?.inserts??0,updates:d?.updates??0,deletes:d?.deletes??0,schemaChanges:d?.schemaChanges??0}}),[l,ks,fe,R]),at=u.useMemo(()=>l.map(s=>{const o=fe.get(s),d=R[s].label,h=o?.snapshotRows??0;return`${d} ${h}`}).join(", "),[l,fe,R]),Ts=u.useMemo(()=>l.map(s=>{const o=Ue.get(s),d=R[s].label,h=o?.totals??{missing:0,extra:0,ordering:0},k=o?.lag?.max??0,E=[];if(h.missing>0&&E.push({key:"missing",text:`${h.missing} missing`,tone:"missing"}),h.extra>0&&E.push({key:"extra",text:`${h.extra} extra`,tone:"extra"}),h.ordering>0&&E.push({key:"ordering",text:`${h.ordering} ordering`,tone:"ordering"}),k>0&&E.push({key:"lag",text:`${Math.round(k)}ms lag`,tone:"lag"}),Pe){const v=st.get(s),A=v?.schemaVersion??1;v&&!v.hasSchemaColumn?E.push({key:"schema-missing",text:`${Ce.name} missing`,tone:"schema"}):A<we&&E.push({key:"schema-behind",text:`Schema v${A}/${we}`,tone:"schema"})}E.length===0&&E.push({key:"ok",text:"Aligned",tone:"ok"});const S=!!o?.issues.length||(o?.lag?.samples?.length??0)>0||(o?.lag?.max??0)>0;return{method:s,label:d,chips:E,hasDetails:S}}),[l,st,Ue,R,we,Pe]);u.useEffect(()=>{typeof window>"u"||window.dispatchEvent(new CustomEvent("cdc:consumer-paused",{detail:{paused:W,backlog:Bt}}))},[W,Bt]);const na=u.useCallback(()=>{if(!N)return;const s=[];s.push(`${b.label}: ${b.description}`),s.push(`Methods: ${l.map(o=>R[o].label).join(", ")}`),N.bestLag&&s.push(`Fastest ${R[N.bestLag.method].label} at ${Math.round(N.bestLag.metrics.lagMs)}ms`),N.lagSpread>0&&s.push(`${R[N.worstLag.method].label} trails by ${Math.round(N.lagSpread)}ms`),s.push(`Lowest delete capture: ${R[N.lowestDeletes.method].label} (${Math.round(N.lowestDeletes.metrics.deletesPct)}%)`),N.triggerWriteAmplification&&s.push(`Trigger write amplification: ${R[N.triggerWriteAmplification.method].label} ${(N.triggerWriteAmplification.metrics.writeAmplification??0).toFixed(1)}x`),at&&s.push(`Snapshot rows: ${at}`),s.push(`Ordering: ${N.orderingIssues.length?N.orderingIssues.map(o=>R[o].label).join(", "):"All lanes aligned"}`),b.tags?.length&&s.push(`Tags: ${b.tags.join(", ")}`),navigator.clipboard.writeText(s.join(`
`)).then(()=>Te(!0)).catch(()=>Te(!1)),q("comparator.summary.copied",{scenario:b.name,tags:b.tags??[],methods:l})},[N,b,l,R,at]),aa=u.useCallback(s=>{q("comparator.overlay.inspect",{method:s,scenario:b.name});const o=document.getElementById(`lane-diff-${s}`);o instanceof HTMLDetailsElement?(o.open=!0,o.scrollIntoView({behavior:"smooth",block:"center"})):o&&o.scrollIntoView({behavior:"smooth",block:"center"})},[b.name]),qt=u.useCallback(s=>{if(!b.tags?.includes("schema"))return;const o=Math.max(z,ft.current+ve);ft.current=o,l.forEach(d=>{xe.current[d]?.applySchemaChange?.(Ut,s,Ce,o),de(d)}),q("comparator.schema.change",{action:s,table:Ut,scenario:b.name,commitTs:o,methods:l})},[l,z,xe,Ut,b.name,b.tags,de]),ra=u.useMemo(()=>{if(!b.tags?.includes("schema"))return;const s=l[0];if(s)return o=>o!==s?null:n.jsx(Ua,{columnName:Ce.name,onAdd:()=>qt("add"),onDrop:()=>qt("drop"),disableAdd:nt,disableDrop:!nt,status:Es})},[l,qt,nt,Es,b.tags]),Be=u.useCallback((s,o,d)=>{it(h=>({...h,[s]:{...h[s],[o]:d}}))},[]),qe=u.useCallback(s=>{const o=Se.current;if(o){Oe(b),o.reset(b.seed),L(We(l)),V(We(l));for(const d of l){Ie.current[d]=new Jt;const h=xe.current[d];h&&(h.bus.reset(h.topic),h.metrics.reset(),de(d,{lastOffset:-1}))}ze(0),ft.current=0,s?.keepLoop||(o.pause(),G(!1),se())}},[l,Oe,b,b.seed,se,de]),Vt=u.useCallback(()=>{const s=Se.current;s&&(qe({keepLoop:!0}),s.start(),G(!0),Cs(),ot("play",{scenario:b.name}))},[qe,Cs,b.name]),Gt=u.useCallback(()=>{Se.current?.pause(),G(!1),se(),ot("pause",{scenario:b.name})},[se,b.name]),oa=u.useCallback(()=>{$t&&Ot(s=>{const o=!s;return q("comparator.consumer.toggle",{scenario:b.name,paused:o}),o||Fe(),o})},[Fe,$t,b.name]),Wt=u.useCallback((s=ve)=>{const o=Se.current;if(!o)return;const d=Ss.current;d||o.start(),o.tick(s),dt(s),d||o.pause(),ot("step",{deltaMs:s,scenario:b.name})},[dt,b.name]),Ms=u.useCallback((s,o)=>{const d=Se.current;if(!d)return;const h=Math.max(10,o??ve);qe({keepLoop:!1});const k=Math.max(s,0);d.start();let E=0,S=0;for(;E<k&&S<1e4;){const v=Math.min(h,k-E);d.tick(v),E+=v,S+=1}d.pause(),G(!1),ot("seek",{targetMs:s,stepMs:o,scenario:b.name})},[qe,b.name]),Ht=u.useCallback(()=>{Qe(""),Ae(null),Ke(null),Ye(null),Je(""),qe(),ot("reset",{scenario:b.name})},[qe,b.name,Ae,Ye,Ke,Je,Qe]);return u.useEffect(()=>{if(typeof window>"u")return;const s={play:()=>Vt(),pause:()=>Gt(),step:d=>Wt(d),seek:(d,h)=>Ms(d,h),reset:()=>Ht()};window.cdcComparatorClock=s;const o=d=>{if(!(d instanceof CustomEvent))return;const h=d.detail;if(h)switch(h.type){case"play":s.play();break;case"pause":s.pause();break;case"step":s.step(h.deltaMs);break;case"seek":s.seek(h.timeMs,h.stepMs);break;case"reset":s.reset();break}};return window.addEventListener("cdc:comparator-clock",o),()=>{window.removeEventListener("cdc:comparator-clock",o),window.cdcComparatorClock===s&&delete window.cdcComparatorClock}},[Gt,Ht,Ms,Vt,Wt]),u.useEffect(()=>{typeof window>"u"||window.dispatchEvent(new CustomEvent("cdc:comparator-clock-tick",{detail:{clock:z}}))},[z]),u.useEffect(()=>()=>se(),[se]),u.useEffect(()=>{if(typeof window>"u")return;const s=N?{lagSpread:N.lagSpread,bestLag:{method:N.bestLag.method,label:R[N.bestLag.method].label,metrics:N.bestLag.metrics},worstLag:{method:N.worstLag.method,label:R[N.worstLag.method].label,metrics:N.worstLag.metrics},lowestDeletes:{method:N.lowestDeletes.method,label:R[N.lowestDeletes.method].label,metrics:N.lowestDeletes.metrics},highestDeletes:{method:N.highestDeletes.method,label:R[N.highestDeletes.method].label,metrics:N.highestDeletes.metrics},orderingIssues:N.orderingIssues.map(v=>({method:v,label:R[v].label})),triggerWriteAmplification:N.triggerWriteAmplification?{method:N.triggerWriteAmplification.method,label:R[N.triggerWriteAmplification.method].label,value:N.triggerWriteAmplification.metrics.writeAmplification??0}:null}:null,o=X.map(({method:v,metrics:A})=>({method:v,label:R[v].label,tooltip:R[v].tooltip,metrics:A})),d=b.table??b.ops.find(v=>v.table)?.table??"table";let h=d;try{h=F.topicFormat(d)}catch{h=d}const k={id:F.id,label:F.label,description:F.description,docsHint:F.docsHint,source:{label:F.sourceLabel,tooltip:F.sourceTooltip},log:{label:F.logLabel,tooltip:F.logTooltip},bus:{label:F.busLabel,tooltip:F.busTooltip,exampleTopic:h},destination:{label:F.destinationLabel,tooltip:F.destinationTooltip},methods:he.map(v=>({id:v,label:R[v].label,tooltip:R[v].tooltip??null}))},E=X.map(({method:v})=>{const A=Ue.get(v);return A?{method:v,totals:A.totals,issues:A.issues.slice(0,25),lag:A.lag}:{method:v,totals:{missing:0,extra:0,ordering:0},issues:[],lag:{max:0,samples:[]}}}),S=l.map(v=>{const A=Ue.get(v);return A?{method:v,label:R[v].label,totals:A.totals,issues:A.issues.slice(0,10),lag:{max:A.lag.max,samples:A.lag.samples.slice(0,10)}}:{method:v,label:R[v].label,totals:{missing:0,extra:0,ordering:0},issues:[],lag:{max:0,samples:[]}}});window.dispatchEvent(new CustomEvent("cdc:comparator-summary",{detail:{scenarioName:b.name,scenarioLabel:b.label,scenarioDescription:b.description,isLive:b.name===Ge,totalEvents:js,summary:s,lanes:o,analytics:yt,tags:i,preset:k,diffs:E,overlay:S}}))},[X,b,N,js,yt,i,Ue,R,F,l]),n.jsxs("section",{className:"sim-shell","aria-label":"Simulator preview",children:[n.jsxs("header",{className:"sim-shell__header",children:[n.jsxs("div",{children:[n.jsx("h2",{className:"sim-shell__title",children:"CDC Method Comparator"}),n.jsx("p",{className:"sim-shell__description",children:F.description}),n.jsxs("div",{className:"sim-shell__preset-row",role:"list","aria-label":"Selected vendor pipeline",children:[n.jsxs("span",{className:"sim-shell__preset-pill","data-tooltip":F.sourceTooltip,role:"listitem",children:["Source · ",F.sourceLabel]}),n.jsx("span",{className:"sim-shell__preset-arrow","aria-hidden":"true",children:"→"}),n.jsxs("span",{className:"sim-shell__preset-pill","data-tooltip":F.logTooltip,role:"listitem",children:["Capture · ",F.logLabel]}),n.jsx("span",{className:"sim-shell__preset-arrow","aria-hidden":"true",children:"→"}),n.jsxs("span",{className:"sim-shell__preset-pill","data-tooltip":F.busTooltip,role:"listitem",children:["Transport · ",F.busLabel]}),n.jsx("span",{className:"sim-shell__preset-arrow","aria-hidden":"true",children:"→"}),n.jsxs("span",{className:"sim-shell__preset-pill","data-tooltip":F.destinationTooltip,role:"listitem",children:["Sink · ",F.destinationLabel]})]}),n.jsxs("p",{className:"sim-shell__description sim-shell__description--meta",children:[F.label,F.docsHint?n.jsxs(n.Fragment,{children:[" · ",n.jsx("a",{href:F.docsHint,target:"_blank",rel:"noopener noreferrer",children:"Reference"})]}):null]})]}),n.jsxs("div",{className:"sim-shell__scenario-filter-row",role:"group","aria-label":"Filter scenarios",children:[n.jsxs("label",{className:"sim-shell__scenario-search",children:[n.jsx("span",{children:"Search scenarios"}),n.jsx("input",{type:"search",value:g,onChange:s=>Jn(s.target.value),placeholder:"Find by label, description, or tag"})]}),fs.length>0?n.jsxs("div",{className:"sim-shell__scenario-tags",role:"group","aria-label":"Scenario tags",children:[fs.map(s=>n.jsxs("button",{type:"button",className:"sim-shell__scenario-tag","data-active":gs.has(s)?"true":"false","aria-pressed":gs.has(s),onClick:()=>Yn(s),children:["#",s]},s)),i.length?n.jsx("button",{type:"button",className:"sim-shell__scenario-tag sim-shell__scenario-tag--clear",onClick:Xn,children:"Clear"}):null]}):null]}),n.jsxs("div",{className:"sim-shell__actions sim-shell__actions--scenario",role:"group","aria-label":"Scenario controls",children:[n.jsx("select",{"aria-label":"Vendor preset",value:Le,onChange:s=>Kn(s.target.value),children:kn.map(s=>n.jsx("option",{value:s.id,children:s.label},s.id))}),n.jsx("select",{"aria-label":"Scenario",value:C,onChange:s=>Zn(s.target.value),children:ge.map(s=>n.jsx("option",{value:s.name,children:s.label},s.name))}),n.jsxs("div",{className:"sim-shell__scenario-actions",children:[n.jsx("button",{type:"button",className:"sim-shell__scenario-sync",onClick:()=>{b.name!==Ge&&window.dispatchEvent(new CustomEvent("cdc:apply-scenario-template",{detail:{id:b.name}}))},disabled:b.name===Ge,children:"Load in workspace"}),n.jsx("button",{type:"button",className:"sim-shell__scenario-download",onClick:()=>ea(b),children:"Download JSON"}),n.jsx("button",{type:"button",className:"sim-shell__scenario-preview",onClick:()=>ta(b),children:"Preview"})]}),n.jsx("div",{className:"sim-shell__method-toggle",role:"group","aria-label":"Methods to display",children:he.map(s=>n.jsx("button",{type:"button",className:"sim-shell__method-chip","aria-pressed":l.includes(s),onClick:()=>Nn(s),"data-tooltip":R[s].tooltip||void 0,children:R[s].label},s))})]})]}),n.jsxs("p",{className:"sim-shell__description","aria-live":"polite",children:[n.jsxs("strong",{children:[b.label,":"]})," ",b.description]}),b.highlight&&n.jsx("p",{className:"sim-shell__description sim-shell__description--highlight","aria-live":"polite",children:b.highlight}),b.tags?.length?n.jsx("div",{className:"sim-shell__tag-row","aria-label":"Scenario tags",children:b.tags.map(s=>n.jsxs("span",{className:"sim-shell__tag-chip",children:["#",s]},s))}):null,b.stats&&n.jsxs("p",{className:"sim-shell__description sim-shell__description--meta","aria-live":"polite",children:[b.stats.rows," rows · ",b.stats.ops," ops"]}),n.jsxs("div",{className:"sim-shell__event-filters",role:"group","aria-label":"Event filters",children:[W&&n.jsx("div",{className:"sim-shell__pause-banner",role:"status","aria-live":"polite",children:"Apply paused. Resume to drain the event bus."}),n.jsxs("label",{className:"sim-shell__event-search",children:[n.jsx("span",{children:"Search events"}),n.jsx("input",{type:"search",value:Y,onChange:s=>Rn(s.target.value),placeholder:"Filter by pk, seq, or payload"})]}),n.jsx("div",{className:"sim-shell__event-ops",role:"group","aria-label":"Change operations",children:je.map(s=>n.jsx("button",{type:"button",className:"sim-shell__event-op","data-active":ys.has(s)?"true":"false",onClick:()=>Dn(s),children:s.toUpperCase()},s))}),n.jsx("button",{type:"button",className:"sim-shell__event-toggle",onClick:$n,children:Me?"Hide timeline":"Show timeline"})]}),Tn&&n.jsx(Da,{className:"sim-shell__event-log",events:An,stats:sa,totalCount:Pt.length,filters:In,filterOptions:On,onFiltersChange:Vn,onDownload:Gn,onClear:Hn,onCopyEvent:zn,onReplayEvent:Qn,maxVisibleEvents:xr}),bs&&n.jsx("section",{className:"sim-shell__harness-history","aria-label":"Harness nightly history",children:n.jsxs("details",{children:[n.jsx("summary",{children:"Harness nightly history"}),n.jsx("pre",{children:bs})]})}),n.jsxs("div",{className:"sim-shell__actions",role:"group","aria-label":"Playback controls","data-tour-target":"comparator-actions",children:[n.jsx("button",{type:"button",onClick:Vt,disabled:j,children:"Start"}),n.jsx("button",{type:"button",onClick:Gt,disabled:!j,children:"Pause"}),n.jsxs("button",{type:"button",onClick:()=>Wt(),children:["Step +",ve,"ms"]}),n.jsx("button",{type:"button",onClick:Ht,children:"Reset"}),$t&&n.jsxs("button",{type:"button",onClick:oa,className:"sim-shell__consumer-toggle","data-tooltip":H.backlog,children:[W?"Resume apply":"Pause apply",pt?` (${Bt} queued)`:""]}),n.jsxs("label",{className:"sim-shell__apply-toggle","data-tooltip":H.txnAtomic||void 0,children:[n.jsx("input",{type:"checkbox",checked:_e,onChange:s=>rs(s.target.checked)}),n.jsx("span",{children:"Apply on commit"})]}),n.jsxs("div",{className:"sim-shell__consumer-rate",role:"group","aria-label":"Apply rate limit","data-enabled":ie?"true":"false",children:[n.jsx("button",{type:"button",onClick:Pn,children:ie?"Disable throttle":"Throttle apply"}),n.jsxs("label",{children:[n.jsx("span",{children:ie?`${me} events/s`:"Unlimited"}),n.jsx("input",{type:"range",min:xn,max:yn,step:gr,value:me,onChange:s=>Fn(Number(s.target.value)),disabled:!ie})]})]}),n.jsxs("div",{className:"sim-shell__generator",role:"group","aria-label":"Event generator","data-enabled":le?"true":"false",children:[n.jsx("button",{type:"button",onClick:Un,children:le?"Stop generator":"Start generator"}),n.jsxs("label",{children:[n.jsx("span",{children:le?`${te} events/s`:`Set ${te} events/s`}),n.jsx("input",{type:"range",min:vn,max:_n,step:ns,value:te,onChange:s=>Bn(Number(s.target.value)),disabled:!le})]}),n.jsxs("button",{type:"button",onClick:qn,children:["Burst +",Yt]})]})]}),n.jsx("div",{className:"sim-shell__controls","aria-label":"Method tuning controls",children:he.map(s=>{const o=l.includes(s);if(s==="polling"){const h=Q.polling;return n.jsxs("fieldset",{className:"sim-shell__control-card","aria-labelledby":`control-${s}`,"data-active":o?"true":"false",children:[n.jsx("legend",{id:`control-${s}`,children:R[s].label}),n.jsx("p",{className:"sim-shell__control-copy",children:"Adjust poll cadence and whether soft deletes are surfaced."}),Ln?n.jsxs(n.Fragment,{children:[n.jsxs("label",{className:"sim-shell__control-field",children:[n.jsxs("span",{children:["Poll interval (",(h.pollIntervalMs/1e3).toFixed(1),"s)"]}),n.jsx("input",{type:"range",min:500,max:1e4,step:100,value:h.pollIntervalMs,onChange:k=>Be("polling","pollIntervalMs",Math.min(1e4,Math.max(500,Number(k.target.value)||500)))})]}),n.jsxs("p",{className:"sim-shell__control-hint",children:["⏱️ Polling every ",(h.pollIntervalMs/1e3).toFixed(1),"s"]})]}):n.jsxs("label",{className:"sim-shell__control-field",children:[n.jsx("span",{children:"Poll interval (ms)"}),n.jsx("input",{type:"number",min:100,step:100,value:h.pollIntervalMs,onChange:k=>Be("polling","pollIntervalMs",Math.min(1e4,Math.max(100,Number(k.target.value)||500)))})]}),n.jsxs("label",{className:"sim-shell__control-checkbox",children:[n.jsx("input",{type:"checkbox",checked:h.includeSoftDeletes,onChange:k=>Be("polling","includeSoftDeletes",k.target.checked)}),n.jsx("span",{children:"Include soft delete marker column"})]})]},s)}if(s==="trigger"){const h=Q.trigger;return n.jsxs("fieldset",{className:"sim-shell__control-card","aria-labelledby":`control-${s}`,"data-active":o?"true":"false",children:[n.jsx("legend",{id:`control-${s}`,children:R[s].label}),n.jsx("p",{className:"sim-shell__control-copy",children:"Tune audit extractor cadence and per-write trigger overhead."}),n.jsxs("label",{className:"sim-shell__control-field",children:[n.jsx("span",{children:"Extractor interval (ms)"}),n.jsx("input",{type:"number",min:100,step:50,value:h.extractIntervalMs,onChange:k=>Be("trigger","extractIntervalMs",Math.max(50,Number(k.target.value)||0))})]}),n.jsxs("label",{className:"sim-shell__control-field",children:[n.jsx("span",{children:"Trigger overhead (ms)"}),n.jsx("input",{type:"number",min:0,step:1,value:h.triggerOverheadMs,onChange:k=>Be("trigger","triggerOverheadMs",Math.max(0,Number(k.target.value)||0))})]})]},s)}const d=Q.log;return n.jsxs("fieldset",{className:"sim-shell__control-card","aria-labelledby":`control-${s}`,"data-active":o?"true":"false",children:[n.jsx("legend",{id:`control-${s}`,children:R[s].label}),n.jsx("p",{className:"sim-shell__control-copy",children:"Control how frequently the WAL/Binlog fetcher polls for new records."}),n.jsxs("label",{className:"sim-shell__control-field",children:[n.jsx("span",{children:"Fetch interval (ms)"}),n.jsx("input",{type:"number",min:10,step:10,value:d.fetchIntervalMs,onChange:h=>Be("log","fetchIntervalMs",Math.max(10,Number(h.target.value)||0))})]})]},s)})}),N&&n.jsxs("div",{className:"sim-shell__summary","aria-live":"polite",children:[n.jsxs("ul",{children:[n.jsxs("li",{children:[n.jsx("strong",{"data-tooltip":H.lagSpread,children:"Lag spread:"})," ",R[N.bestLag.method].label," is leading at",` ${N.bestLag.metrics.lagMs.toFixed(0)}ms`,N.lagSpread>0?` — ${R[N.worstLag.method].label} trails by ${N.lagSpread.toFixed(0)}ms`:" (no spread)"]}),n.jsxs("li",{children:[n.jsx("strong",{"data-tooltip":H.deleteCapture,children:"Delete capture:"})," ",R[N.lowestDeletes.method].label," is lowest at",` ${N.lowestDeletes.metrics.deletesPct.toFixed(0)}%`," · best is ",R[N.highestDeletes.method].label,` (${N.highestDeletes.metrics.deletesPct.toFixed(0)}%)`]}),at&&n.jsxs("li",{children:[n.jsx("strong",{"data-tooltip":H.snapshot,children:"Snapshot rows:"})," ",at]}),N.triggerWriteAmplification&&n.jsxs("li",{children:[n.jsx("strong",{"data-tooltip":H.triggerOverhead,children:"Trigger overhead:"})," ",R[N.triggerWriteAmplification.method].label," is at"," ",`${(N.triggerWriteAmplification.metrics.writeAmplification??0).toFixed(1)}x`," write amplification"]}),n.jsxs("li",{children:[n.jsx("strong",{children:"Ordering:"}),N.orderingIssues.length===0?" All methods preserved ordering":` Issues: ${N.orderingIssues.map(s=>R[s].label).join(", ")}`]})]}),n.jsx("button",{type:"button",className:"sim-shell__summary-copy",onClick:na,children:be?"Copied":"Copy summary"})]}),Ts.length>0&&n.jsxs("section",{className:"sim-shell__overlay-summary","aria-label":"Lane checks",children:[n.jsxs("header",{children:[n.jsx("h3",{children:"Lane checks"}),n.jsx("p",{children:"Quick glance at diff findings and lag hotspots across active capture methods."})]}),n.jsx("ul",{children:Ts.map(s=>n.jsxs("li",{className:"sim-shell__overlay-row",children:[n.jsx("div",{className:"sim-shell__overlay-label",children:s.label}),n.jsx("div",{className:"sim-shell__overlay-chips",children:s.chips.map(o=>n.jsx("span",{className:`sim-shell__overlay-chip sim-shell__overlay-chip--${o.tone}`,children:o.text},`${s.method}-${o.key}`))}),s.hasDetails&&n.jsx("button",{type:"button",className:"sim-shell__overlay-action",onClick:()=>aa(s.method),children:"Inspect"})]},s.method))})]}),Ls.length>0&&n.jsx(Pa,{lanes:Ls,renderSchemaWalkthrough:ra}),n.jsx("div",{className:"sim-shell__lane-grid","data-tour-target":"comparator-lanes",children:X.map(({method:s,metrics:o,events:d},h)=>{const k=R[s],E=k.laneDescription,S=Ue.get(s)??null,v=h===0,A=fe.get(s),O=xe.current[s],P=st.get(s),$=P?.rows.slice(0,yr)??[],B=(P?.rows.length??0)>$.length,J=Pe&&P?{version:P.schemaVersion,expectedVersion:we,hasColumn:P.hasSchemaColumn,columnName:Ce.name}:Pe?{version:0,expectedVersion:we,hasColumn:!1,columnName:Ce.name}:void 0,ue=s==="trigger"?A?.writeAmplification??o.writeAmplification??0:void 0,pe=[],rt=s==="polling"?"warning":"info";k.callout&&(s==="polling"&&o.deletesPct<100?pe.push({text:`${k.callout} (${o.deletesPct.toFixed(0)}% of deletes captured in this scenario)`,tone:rt}):pe.push({text:k.callout,tone:rt})),b.tags?.includes("schema")&&(s==="trigger"&&typeof ue=="number"&&ue>0&&pe.push({text:`Write amplification ${ue.toFixed(1)}x (extra audit writes per change)`,tone:"info"}),s==="log"&&pe.push({text:"Log capture streams schema changes in-order, keeping downstream versions aligned.",tone:"info"}),s==="polling"&&pe.push({text:"Polling picks up new columns once refreshed rows include them; expect interim nulls.",tone:"warning"})),b.tags?.includes("transactions")&&pe.push({text:_e?"Apply-on-commit groups transaction events before updating destinations so tables stay in sync.":"Apply-on-commit is off: events apply individually, so pausing mid-transaction shows partial state.",tone:_e?"info":"warning"});const ne=Mn.get(s)??d,As=ne.length!==d.length||De.length>0||ys.size<je.length,ia=Me&&ne.length>Xt,Is=Me?ne.slice(Math.max(ne.length-Xt,0)):[];return n.jsxs("article",{className:"sim-shell__lane-card",children:[n.jsxs("header",{className:"sim-shell__lane-header",children:[n.jsxs("div",{children:[n.jsx("h3",{className:"sim-shell__lane-title","data-tooltip":k.tooltip||void 0,children:k.label}),n.jsx("p",{className:"sim-shell__lane-copy",children:E})]}),n.jsxs("span",{className:"sim-shell__lane-count",children:[ne.length,As?` / ${d.length}`:""," events"]})]}),n.jsx("div",{className:"sim-shell__metrics","data-tour-target":v?"comparator-metrics":void 0,children:n.jsx(Fa,{...o})}),n.jsx(ur,{diff:S,scenarioName:b.name,laneId:s,schemaStatus:J}),pt&&n.jsxs("section",{className:"sim-shell__lane-bus","aria-label":`${k.label} event bus`,"data-paused":W?"true":"false",children:[n.jsxs("header",{children:[n.jsx("h4",{children:"Event Bus"}),n.jsx("span",{children:O?.topic??`cdc.${s}`})]}),n.jsxs("p",{children:[n.jsxs("span",{"data-tooltip":H.backlog,children:["Backlog ",n.jsx("strong",{children:A?.backlog??0}),W?" (apply paused)":""]})," · ",n.jsxs("span",{"data-tooltip":H.offset,children:["Last offset ",A?.lastOffset??-1]})]}),n.jsxs("p",{children:["Produced ",A?.produced??0," · Consumed ",A?.consumed??0]}),n.jsxs("p",{"data-tooltip":H.snapshot,children:["Snapshot rows ",A?.snapshotRows??0]}),n.jsxs("p",{"data-tooltip":H.lagPercentile,children:["Lag p50 ",Math.round(A?.lagMsP50??0),"ms · p95 ",Math.round(A?.lagMsP95??0),"ms"]}),s==="trigger"&&n.jsxs("p",{"data-tooltip":H.triggerWriteAmplification,children:["Write amplification: ",ue?.toFixed(1)??"0.0","x"]}),s==="polling"&&n.jsxs("p",{className:"sim-shell__lane-bus-warning","data-tooltip":H.deleteCapture,children:["Missed deletes: ",A?.missedDeletes??0]}),A&&A.errors>0&&n.jsxs("p",{className:"sim-shell__lane-bus-warning",children:["Errors: ",A.errors]})]}),P&&n.jsxs("section",{className:"sim-shell__destination","aria-label":`${k.label} destination snapshot`,children:[n.jsxs("header",{children:[n.jsxs("div",{className:"sim-shell__destination-title",children:[n.jsx("h4",{children:"Destination snapshot"}),n.jsxs("span",{children:["schema v",P.schemaVersion]})]}),n.jsx("div",{className:"sim-shell__destination-actions",children:n.jsx("button",{type:"button",className:"sim-shell__destination-download",onClick:()=>Wn(s),disabled:P.rows.length===0,children:"Download JSON"})})]}),$.length>0?n.jsx("div",{className:"sim-shell__destination-table",role:"table",children:n.jsxs("table",{children:[n.jsx("thead",{children:n.jsx("tr",{children:P.columns.map(U=>n.jsx("th",{"data-highlight":U===Ce.name?"true":void 0,children:U},U))})}),n.jsx("tbody",{children:$.map(U=>n.jsx("tr",{children:P.columns.map(Ee=>n.jsx("td",{children:Er(Ee==="id"?U.displayId:Ee==="table"?U.table:U.values[Ee])},`${U.id}-${Ee}`))},U.id))})]})}):n.jsx("p",{className:"sim-shell__destination-empty",children:"No rows applied yet."}),B&&n.jsxs("p",{className:"sim-shell__destination-note",children:["Showing ",$.length," of ",P.rows.length," rows."]})]}),n.jsxs("dl",{className:"sim-shell__lane-config",children:[s==="polling"&&(()=>{const U=Q.polling;return n.jsxs(n.Fragment,{children:[n.jsxs("div",{children:[n.jsx("dt",{children:"Poll interval"}),n.jsxs("dd",{"data-tooltip":H.pollingInterval,children:[U.pollIntervalMs," ms"]})]}),n.jsxs("div",{children:[n.jsx("dt",{children:"Soft deletes"}),n.jsx("dd",{"data-tooltip":H.pollingSoftDeletes,children:U.includeSoftDeletes?"included":"ignored"})]})]})})(),s==="trigger"&&(()=>{const U=Q.trigger;return n.jsxs(n.Fragment,{children:[n.jsxs("div",{children:[n.jsx("dt",{children:"Extractor interval"}),n.jsxs("dd",{"data-tooltip":H.triggerExtractorInterval,children:[U.extractIntervalMs," ms"]})]}),n.jsxs("div",{children:[n.jsx("dt",{children:"Trigger overhead"}),n.jsxs("dd",{"data-tooltip":H.triggerOverhead,children:[U.triggerOverheadMs," ms"]})]}),n.jsxs("div",{children:[n.jsx("dt",{children:"Write amplification"}),n.jsxs("dd",{"data-tooltip":H.triggerWriteAmplification,children:[ue?.toFixed(1)??"0.0","x"]})]})]})})(),s==="log"&&(()=>{const U=Q.log;return n.jsxs("div",{children:[n.jsx("dt",{children:"Fetch interval"}),n.jsxs("dd",{"data-tooltip":H.logFetchInterval,children:[U.fetchIntervalMs," ms"]})]})})()]}),pe.length>0&&n.jsx("div",{className:"sim-shell__callouts",children:pe.map((U,Ee)=>n.jsx("p",{className:`sim-shell__callout${U.tone==="warning"?" sim-shell__callout--warning":""}`,"data-tour-target":v&&Ee===0?"comparator-callouts":void 0,children:U.text},`${s}-callout-${Ee}`))}),n.jsxs("section",{className:"sim-shell__lane-why","aria-label":`When to use ${k.label}`,children:[n.jsx("h4",{children:"When to use"}),n.jsx("p",{children:k.whenToUse})]}),Me?n.jsxs("ul",{className:"sim-shell__event-list","aria-live":"polite",children:[ia&&n.jsx("li",{className:"sim-shell__event sim-shell__event--notice",children:n.jsxs("span",{children:["Showing latest ",Xt," of ",ne.length," matching events."]})}),Is.length===0?n.jsx("li",{className:"sim-shell__empty",children:As?"No events match the current filters.":"No events yet."}):Is.map(U=>n.jsxs("li",{className:`sim-shell__event${U.op==="d"?" sim-shell__event--delete":""}`,children:[n.jsx("span",{className:"sim-shell__event-op","data-op":U.op,children:U.op}),n.jsxs("span",{children:["#",U.seq," · pk=",U.pk.id]}),n.jsxs("span",{className:"sim-shell__event-target",children:["ts=",U.ts_ms,"ms"]})]},`${s}-${U.seq}`))]}):n.jsx("p",{className:"sim-shell__lane-hidden",children:"Timeline hidden. Use “Show timeline” to view recent events."})]},s)})}),n.jsxs("footer",{className:"sim-shell__footer",children:["Scenario clock: ",z,"ms · ",X.reduce((s,o)=>s+o.events.length,0)," total events emitted"]})]})}function on(){if(typeof window>"u")return;const t=window.telemetry;if(t&&typeof t.track=="function"&&typeof t.flush=="function")return t;let e;try{e=window.localStorage}catch{e=void 0}const a=za({storage:e,console:typeof console<"u"?{warn:console.warn.bind(console),debug:console.debug.bind(console)}:void 0});return window.telemetry=a,a}function ln(){const t=document.getElementById("simShellRoot");if(!t){console.warn("Simulator UI shell mount point not found (simShellRoot).");return}ca.createRoot(t).render(n.jsx(Or,{}))}document.readyState==="loading"?(on(),document.addEventListener("DOMContentLoaded",ln,{once:!0})):(on(),ln());
