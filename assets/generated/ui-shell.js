import{r as c,j as n,T as Qn,S as Vr,R as Gr}from"./event-log-widget.js";class Hr{constructor(){this.topics=new Map}publish(t,r){if(r.length===0)return[];const a=this.ensure(t);return r.map(i=>{const u=++a.offset,h={...i,offset:u};return a.queue.push(h),h})}consume(t,r=1){const a=this.ensure(t);return r<=0?[]:a.queue.splice(0,r)}size(t){return this.ensure(t).queue.length}reset(t){if(t){this.topics.delete(t);return}this.topics.clear()}ensure(t){let r=this.topics.get(t);return r||(r={offset:-1,queue:[]},this.topics.set(t,r)),r}}class zr{constructor(){this.produced=0,this.consumed=0,this.backlog=0,this.lagSamples=[],this.missedDeletes=0,this.writeAmplification=0,this.triggerWrites=0,this.sourceWrites=0,this.snapshotRows=0,this.errors=0,this.lagAggregators=new Set}onProduced(t){this.produced+=t.length,this.backlog+=t.length}onConsumed(t){this.consumed+=t.length,this.backlog=Math.max(this.backlog-t.length,0);const r=Date.now();t.forEach(a=>{const i=typeof a.commitTs=="number"?a.commitTs:typeof a.ts_ms=="number"?a.ts_ms:r,u=Math.max(r-i,0);this.lagSamples.push(u)}),this.lagSamples.length>2e3&&this.lagSamples.splice(0,this.lagSamples.length-2e3),this.notifyLagAggregators()}registerLagAggregator(t){return this.lagAggregators.add(t),this.safeInvokeAggregator(t),()=>{this.lagAggregators.delete(t)}}recordMissedDelete(t=1){this.missedDeletes+=t}recordWriteAmplification(t=1,r=1){Number.isFinite(t)&&t>0&&(this.triggerWrites+=t),Number.isFinite(r)&&r>0&&(this.sourceWrites+=r),this.sourceWrites>0?this.writeAmplification=(this.sourceWrites+this.triggerWrites)/this.sourceWrites:this.writeAmplification=0}recordSnapshotRows(t){this.snapshotRows=t}recordError(){this.errors+=1}reset(){this.produced=0,this.consumed=0,this.backlog=0,this.lagSamples=[],this.missedDeletes=0,this.writeAmplification=0,this.triggerWrites=0,this.sourceWrites=0,this.snapshotRows=0,this.errors=0,this.notifyLagAggregators()}snapshot(){const t=[...this.lagSamples].sort((i,u)=>i-u),r=this.percentile(t,.5),a=this.percentile(t,.95);return{produced:this.produced,consumed:this.consumed,backlog:this.backlog,lagMsP50:r,lagMsP95:a,missedDeletes:this.missedDeletes,writeAmplification:this.writeAmplification,snapshotRows:this.snapshotRows,errors:this.errors}}safeInvokeAggregator(t,r){try{const a=r?[...r]:[...this.lagSamples];t(a)}catch{}}notifyLagAggregators(){if(this.lagAggregators.size===0)return;const t=[...this.lagSamples];this.lagAggregators.forEach(r=>{this.safeInvokeAggregator(r,t)})}percentile(t,r){if(!t.length)return 0;const a=Math.max(t.length-1,0)*r,i=Math.floor(a),u=Math.min(i+1,t.length-1);if(i===u)return t[i];const h=a-i;return t[i]+(t[u]-t[i])*h}}class Kr{constructor(){this.tasks=new Map,this.nextId=1}every(t,r){const a=this.nextId++,i={id:a,interval:t,handler:r};this.tasks.set(a,i);const u=setInterval(()=>r(),t);return i.timerId=u,a}clear(t){if(t!=null){const r=this.tasks.get(t);r&&r.timerId&&clearInterval(r.timerId),this.tasks.delete(t);return}this.tasks.forEach(r=>{const a=r.timerId;a&&clearInterval(a)}),this.tasks.clear()}}class Qr{constructor(t,r,a,i,u,h={}){this.mode=t,this.bus=r,this.scheduler=a,this.metrics=i,this.handlers=h,this.state="IDLE",this.topic=u??`cdc.${t.toLowerCase()}`}get currentState(){return this.state}get topicName(){return this.topic}startSnapshot(t){this.state==="IDLE"&&(this.state="SNAPSHOTTING",this.handlers.startSnapshot?.(t,r=>this.emit(r)))}startTailing(){this.state!=="TAILING"&&(this.state="TAILING",this.handlers.startTailing?.(t=>this.emit(t)))}pause(){this.state==="TAILING"&&(this.state="PAUSED")}resume(){this.state==="PAUSED"&&(this.state="TAILING")}stop(){this.state="IDLE",this.scheduler.clear(),this.handlers.stop?.(),this.bus.reset(this.topic),this.metrics.reset()}emit(t){if(t.length===0)return[];const r=this.bus.publish(this.topic,t);return this.metrics.onProduced(r),r}}let Jr=0;const Ns=()=>`evt-${Date.now()}-${++Jr}`,zt=e=>e?JSON.parse(JSON.stringify(e)):null,bn=(e,t)=>`${e}::${t}`,xn=(e,t)=>({id:e.name,type:e.type,nullable:e.nullable??!1,__ts:t}),yn=(e,t,r=`tx-${t}`)=>{const a=e?.id??r,i=typeof e?.index=="number",u=i?e.index:void 0,h=typeof e?.total=="number"?e.total:void 0;let b;return typeof e?.last=="boolean"?b=e.last:i&&typeof h=="number"?b=u>=h-1:b=!e,{id:a,index:u,total:h,last:b}};function Yr(){let e=null,t=null,r=100,a=0;const i=new Map,u=[];let h=0;const b=new Map,k=x=>{const C=b.get(x);return typeof C=="number"&&C>=1?C:(b.set(x,1),1)},N=x=>{const C=k(x),d=C+1;return b.set(x,d),{previous:C,next:d}},S=(x,C,d,g,f)=>{const v=yn(x.txn,f);return{id:Ns(),kind:C,table:x.table,before:d?{id:x.pk.id,...d,__ts:f}:void 0,after:g?{id:x.pk.id,...g,__ts:f}:void 0,txnId:v.id,txnIndex:v.index,txnTotal:v.total,txnLast:v.last,commitTs:f,schemaVersion:k(x.table),topic:e?.topic??`cdc.${x.table}`,partition:0}},w=(x,C,d,g)=>{if(!t||!e)return;const{previous:f,next:v}=N(x),T=yn(void 0,g,`schema-${g}`),L={id:Ns(),kind:C==="ADD_COLUMN"?"SCHEMA_ADD_COL":"SCHEMA_DROP_COL",table:x,before:C==="DROP_COLUMN"?xn(d,g):void 0,after:C==="ADD_COLUMN"?xn(d,g):void 0,txnId:T.id,txnIndex:T.index,txnTotal:T.total,txnLast:T.last,commitTs:g,schemaVersion:v,topic:e.topic??`cdc.${x}`,partition:0,schemaChange:{action:C,column:d,previousVersion:f,nextVersion:v}};t([L])};return{id:"LOG_BASED",initialise(x){e=x},configure(x){const C=Number(x.fetch_interval_ms??x.fetchIntervalMs);Number.isFinite(C)&&C>0&&(r=C)},startSnapshot(x=[],C){if(t=C,!x.length||(x.forEach(g=>{const f=g.schema?.version??1;b.set(g.name,f),g.rows.forEach(v=>{const T=bn(g.name,v.id);i.set(T,{id:v.id,table:g.name,data:{...v},version:1,updatedAt:v.__ts??0,deleted:!1})})}),e?.metrics.recordSnapshotRows(i.size),!i.size))return;const d=[];i.forEach(g=>{d.push({id:Ns(),kind:"INSERT",table:g.table,before:void 0,after:{id:g.id,...g.data,__ts:g.updatedAt},txnId:`snapshot-${g.updatedAt}`,txnIndex:0,txnTotal:1,txnLast:!0,commitTs:g.updatedAt,schemaVersion:k(g.table),topic:e?.topic??`cdc.${g.table}`,partition:0})}),t(d),h=u.length},startTailing(x){t=x},applySource(x){if(!e)return;const C=x.t,d=bn(x.table,x.pk.id);if(k(x.table),x.op==="insert")i.set(d,{id:x.pk.id,table:x.table,data:{...x.after},version:1,updatedAt:C,deleted:!1}),u.push(S(x,"INSERT",null,zt(x.after),C));else if(x.op==="update"){const g=i.get(d),f=g?zt(g.data):null,v=g?{...g.data,...x.after}:{...x.after};i.set(d,{id:x.pk.id,table:x.table,data:v,version:(g?.version??0)+1,updatedAt:C,deleted:!1}),u.push(S(x,"UPDATE",f,zt(v),C))}else if(x.op==="delete"){const g=i.get(d);i.set(d,{id:x.pk.id,table:x.table,data:g?{...g.data}:{},version:(g?.version??0)+1,updatedAt:C,deleted:!0}),u.push(S(x,"DELETE",g?zt(g.data):null,null,C))}},applySchemaChange(x,C,d,g){e&&(k(x),C==="ADD_COLUMN"?i.forEach((f,v)=>{f.table===x&&(d.name in f.data||(f.data[d.name]=null,i.set(v,{...f,data:{...f.data}})))}):C==="DROP_COLUMN"&&i.forEach((f,v)=>{if(f.table===x&&d.name in f.data){const T={...f.data};delete T[d.name],i.set(v,{...f,data:T})}}),w(x,C,d,g))},tick(x){if(!t||x-a<r)return;const C=u.slice(h);C.length&&(t(C),h=u.length),a=x},pause(){},resume(){},stop(){i.clear(),u.length=0,h=0,t=null,e=null,b.clear(),a=0}}}let Xr=0;const Is=()=>`evt-${Date.now()}-${++Xr}`,vn=e=>e?JSON.parse(JSON.stringify(e)):null,_n=(e,t)=>`${e}::${t}`,wn=(e,t)=>({id:e.name,type:e.type,nullable:e.nullable??!1,__ts:t}),Sn=(e,t,r=`tx-${t}`)=>{const a=e?.id??r,i=typeof e?.index=="number",u=i?e.index:void 0,h=typeof e?.total=="number"?e.total:void 0;let b;return typeof e?.last=="boolean"?b=e.last:i&&typeof h=="number"?b=u>=h-1:b=!e,{id:a,index:u,total:h,last:b}};function Zr(){let e=null,t=null,r=1e3,a=!1,i=0;const u=new Map,h=new Map,b=new Map,k=[],N=d=>{const g=b.get(d);return typeof g=="number"&&g>=1?g:(b.set(d,1),1)},S=d=>{const g=N(d),f=g+1;return b.set(d,f),{previous:g,next:f}},w=(d,g,f,v,T,L,$,q)=>{const ie=Sn(q,L,$);return{id:Is(),kind:f,table:d,before:v?{id:g,...v,__ts:L}:void 0,after:T?{id:g,...T,__ts:L}:void 0,txnId:ie.id,txnIndex:ie.index,txnTotal:ie.total,txnLast:ie.last,commitTs:L,schemaVersion:N(d),topic:e?.topic??`cdc.${d}`,partition:0}},x=(d,g,f,v)=>{const{previous:T,next:L}=S(d),$=Sn(void 0,v,`schema-${v}`);k.push({id:Is(),kind:g==="ADD_COLUMN"?"SCHEMA_ADD_COL":"SCHEMA_DROP_COL",table:d,before:g==="DROP_COLUMN"?wn(f,v):void 0,after:g==="ADD_COLUMN"?wn(f,v):void 0,txnId:$.id,txnIndex:$.index,txnTotal:$.total,txnLast:$.last,commitTs:v,schemaVersion:L,topic:e?.topic??`cdc.${d}`,partition:0,schemaChange:{action:g,column:f,previousVersion:T,nextVersion:L}})},C=d=>{!d.length||!t||t(d)};return{id:"QUERY_BASED",initialise(d){e=d},configure(d){const g=Number(d.poll_interval_ms??d.pollIntervalMs);Number.isFinite(g)&&g>0&&(r=g),d.include_soft_deletes!=null&&(a=!!d.include_soft_deletes),d.includeSoftDeletes!=null&&(a=!!d.includeSoftDeletes)},startSnapshot(d=[],g){t=g;const f=[];d.forEach(v=>{const T=v.schema?.version??1;b.set(v.name,T),v.rows.forEach(L=>{const $=_n(v.name,L.id);u.set($,{id:L.id,table:v.name,data:{...L},version:1,updatedAt:L.__ts??0,deleted:!1,txn:void 0}),h.set($,1);const{id:q,__ts:ie,...H}=L;f.push({id:Is(),kind:"INSERT",table:v.name,before:void 0,after:{id:q,...H,__ts:ie??0},txnId:`snapshot-${L.__ts??0}`,txnIndex:0,txnTotal:1,txnLast:!0,commitTs:L.__ts??0,schemaVersion:N(v.name),topic:e?.topic??`cdc.${v.name}`,partition:0})})}),e?.metrics.recordSnapshotRows(f.length),C(f)},startTailing(d){t=d},applySource(d){const g=_n(d.table,d.pk.id),f=d.t;if(N(d.table),d.op==="insert")u.set(g,{id:d.pk.id,table:d.table,data:{...d.after},version:1,updatedAt:f,deleted:!1,txn:d.txn});else if(d.op==="update"){const v=u.get(g),T=v?{...v.data,...d.after}:{...d.after};u.set(g,{id:d.pk.id,table:d.table,data:T,version:(v?.version??0)+1,updatedAt:f,deleted:!1,txn:d.txn})}else if(d.op==="delete"){const v=u.get(g);u.set(g,{id:d.pk.id,table:d.table,data:v?{...v.data}:{},version:(v?.version??0)+1,updatedAt:f,deleted:!0,txn:d.txn})}},applySchemaChange(d,g,f,v){N(d),g==="ADD_COLUMN"?u.forEach((T,L)=>{if(T.table!==d||Object.prototype.hasOwnProperty.call(T.data,f.name))return;const $={...T.data,[f.name]:null};u.set(L,{...T,data:$})}):g==="DROP_COLUMN"&&u.forEach((T,L)=>{if(T.table===d&&f.name in T.data){const $={...T.data};delete $[f.name],u.set(L,{...T,data:$})}}),x(d,g,f,v)},tick(d){if(!t||d-i<r)return;const g=[];k.length&&g.push(...k.splice(0,k.length)),u.forEach((f,v)=>{if(f.updatedAt<=i)return;const T=h.get(v)??0;if(f.deleted){a?(g.push(w(f.table,f.id,"DELETE",vn(f.data),null,f.updatedAt,`tx-${f.updatedAt}`,f.txn)),h.set(v,f.version)):(e?.metrics.recordMissedDelete(),h.set(v,f.version));return}if(f.version<=T)return;const L=T===0?"INSERT":"UPDATE";g.push(w(f.table,f.id,L,null,vn(f.data),f.updatedAt,`tx-${f.updatedAt}`,f.txn)),h.set(v,f.version)}),C(g),i=d},stop(){u.clear(),h.clear(),b.clear(),k.length=0,t=null,e=null,i=0}}}let ea=0;const En=()=>`evt-${Date.now()}-${++ea}`,Kt=e=>e?JSON.parse(JSON.stringify(e)):null,ta=(e,t)=>`${e}::${t}`,jn=(e,t)=>({id:e.name,type:e.type,nullable:e.nullable??!1,__ts:t}),Cn=(e,t,r=`tx-${t}`)=>{const a=e?.id??r,i=typeof e?.index=="number",u=i?e.index:void 0,h=typeof e?.total=="number"?e.total:void 0;let b;return typeof e?.last=="boolean"?b=e.last:i&&typeof h=="number"?b=u>=h-1:b=!e,{id:a,index:u,total:h,last:b}};function sa(){let e=null,t=null,r=250,a=8,i=0,u=0;const h=new Map,b=[],k=new Map,N=d=>{const g=k.get(d);return typeof g=="number"&&g>=1?g:(k.set(d,1),1)},S=d=>{const g=N(d),f=g+1;return k.set(d,f),{previous:g,next:f}},w=(d,g,f,v,T)=>{const L=Cn(d.txn,T);return{id:En(),kind:g,table:d.table,before:f?{id:d.pk.id,...f,__ts:T}:void 0,after:v?{id:d.pk.id,...v,__ts:T}:void 0,txnId:L.id,txnIndex:L.index,txnTotal:L.total,txnLast:L.last,commitTs:T,schemaVersion:N(d.table),topic:e?.topic??`cdc.${d.table}`,partition:0}},x=(d,g,f,v)=>{const{previous:T,next:L}=S(d),$=Cn(void 0,v,`schema-${v}`),q={id:En(),kind:g==="ADD_COLUMN"?"SCHEMA_ADD_COL":"SCHEMA_DROP_COL",table:d,before:g==="DROP_COLUMN"?jn(f,v):void 0,after:g==="ADD_COLUMN"?jn(f,v):void 0,txnId:$.id,txnIndex:$.index,txnTotal:$.total,txnLast:$.last,commitTs:v,schemaVersion:L,topic:e?.topic??`cdc.${d}`,partition:0,schemaChange:{action:g,column:f,previousVersion:T,nextVersion:L}};b.push({event:q})},C=d=>{!d.length||!t||t(d)};return{id:"TRIGGER_BASED",initialise(d){e=d},configure(d){const g=Number(d.extract_interval_ms??d.extractIntervalMs);Number.isFinite(g)&&g>0&&(r=g);const f=Number(d.trigger_overhead_ms??d.triggerOverheadMs);Number.isFinite(f)&&f>=0&&(a=f)},startSnapshot(d=[],g){t=g,e?.metrics.recordSnapshotRows(0)},startTailing(d){t=d},applySource(d){if(!e)return;const g=ta(d.table,d.pk.id),f=d.t+a;let v=null,T=null,L;if(N(d.table),d.op==="insert")L="INSERT",T=Kt(d.after),h.set(g,{id:d.pk.id,table:d.table,data:{...d.after},version:1,updatedAt:f,deleted:!1});else if(d.op==="update"){const $=h.get(g);v=$?Kt($.data):null;const q=$?{...$.data,...d.after}:{...d.after};T=Kt(q),L="UPDATE",h.set(g,{id:d.pk.id,table:d.table,data:q,version:($?.version??0)+1,updatedAt:f,deleted:!1})}else if(d.op==="delete"){const $=h.get(g);v=$?Kt($.data):null,T=null,L="DELETE",h.set(g,{id:d.pk.id,table:d.table,data:$?{...$.data}:{},version:($?.version??0)+1,updatedAt:f,deleted:!0})}else return;b.push({event:w(d,L,v,T,f)}),e.metrics.recordWriteAmplification(1)},applySchemaChange(d,g,f,v){if(!e)return;const T=v+a;N(d),g==="ADD_COLUMN"?h.forEach((L,$)=>{if(L.table===d&&!(f.name in L.data)){const q={...L.data,[f.name]:null};h.set($,{...L,data:q,version:L.version+1,updatedAt:T})}}):g==="DROP_COLUMN"&&h.forEach((L,$)=>{if(L.table===d&&f.name in L.data){const q={...L.data};delete q[f.name],h.set($,{...L,data:q,version:L.version+1,updatedAt:T})}}),x(d,g,f,T)},tick(d){if(!t||d-i<r)return;const g=b.slice(u).map(f=>f.event);C(g),u=b.length,i=d},stop(){b.length=0,h.clear(),t=null,e=null,u=0,i=0,k.clear()}}}const ts={MYSQL_DEBEZIUM:{id:"MYSQL_DEBEZIUM",label:"MySQL · Debezium · Kafka",description:"Debezium tails the MySQL binlog and pushes commits to Kafka for downstream consumers.",docsHint:"https://debezium.io/documentation/reference/stable/connectors/mysql.html",sourceLabel:"MySQL primary",sourceTooltip:"InnoDB workload emitting row-level changes for capture.",logLabel:"MySQL binlog (Debezium)",logTooltip:"Debezium connector streams row-format binlog entries in commit order.",busLabel:"Kafka topic",busTooltip:"Kafka transports Debezium change events (e.g. db.orders) to consumers.",destinationLabel:"Warehouse / downstream sink",destinationTooltip:"Analytics warehouse, service, or cache subscribing to the Kafka topic.",topicFormat:e=>`db.${e}`,methodCopyOverrides:{polling:{label:"Polling (scheduled SQL)",laneDescription:"Batch jobs diff the MySQL table on an interval to detect divergence.",callout:"Misses hard deletes and rapid updates without custom tracking tables.",whenToUse:"Fallback when binlog access is blocked. Accepts lag and data loss for small tables only.",tooltip:"ETL-style SELECT polling against the MySQL primary."},trigger:{label:"Triggers (audit table)",laneDescription:"AFTER triggers write every mutation into an audit table for downstream extract.",callout:"Adds synchronous latency on the write path and increases operational overhead.",whenToUse:"When connectors are unavailable but you still need complete change history.",tooltip:"MySQL triggers populate audit tables that an extractor drains."},log:{label:"Debezium binlog tail",laneDescription:"Debezium streams row-based binlog events into Kafka with schema evolution support.",callout:"Preferred default: low-impact, ordered, near real-time change capture.",whenToUse:"Standard choice for production MySQL workloads when Kafka + Debezium are available.",tooltip:"Debezium connector tailing the MySQL binlog."}}},POSTGRES_LOGICAL:{id:"POSTGRES_LOGICAL",label:"Postgres · Logical decoding · Kafka",description:"Logical decoding streams Postgres WAL changes (pgoutput/wal2json) into Kafka.",docsHint:"https://www.postgresql.org/docs/current/logicaldecoding.html",sourceLabel:"Postgres primary",sourceTooltip:"OLTP Postgres emitting WAL entries for publications.",logLabel:"Logical replication slot",logTooltip:"Logical decoding slot materialises committed WAL changes via pgoutput or wal2json.",busLabel:"Kafka topic",busTooltip:"Kafka topics per publication (e.g. public.orders) fan out change events.",destinationLabel:"Warehouse / downstream sink",destinationTooltip:"Consumers applying logical changes into warehouses or services.",topicFormat:e=>`public.${e}`,methodCopyOverrides:{polling:{label:"Polling (snapshot queries)",laneDescription:"Incremental SELECT queries compare current rows to previous snapshots.",callout:"Can't observe deletes or mid-transaction updates without tombstone columns.",whenToUse:"Stopgap for small tables when logical replication isn't permitted.",tooltip:"Periodic comparison queries against Postgres source tables."},trigger:{label:"Triggers (audit schema)",laneDescription:"Triggers populate audit tables that an extractor tails outside the WAL.",callout:"Higher write amplification and maintenance across replicas.",whenToUse:"When WAL access is off-limits yet complete history is required.",tooltip:"AFTER triggers write into audit tables for downstream capture."},log:{label:"Logical decoding stream",laneDescription:"Slot-based logical decoding streams ordered WAL changes through Kafka.",callout:"Best balance: ordered, low-impact capture with schema evolution support.",whenToUse:"Primary choice when you can run wal2json/pgoutput connectors.",tooltip:"Logical replication slot feeding Kafka via connectors."}}},SQLSERVER_CDC:{id:"SQLSERVER_CDC",label:"SQL Server · CDC tables · ETL",description:"SQL Server CDC populates change tables that ETL tools ship downstream.",docsHint:"https://learn.microsoft.com/sql/relational-databases/track-changes/about-change-data-capture-sql-server",sourceLabel:"SQL Server OLTP",sourceTooltip:"Source database with CDC enabled on tracked tables.",logLabel:"CDC change tables",logTooltip:"Log reader agent populates [cdc].[schema_table_CT] from the transaction log.",busLabel:"ETL pipeline",busTooltip:"ADF/SSIS or similar ETL pipelines move captured rows to consumers.",destinationLabel:"Warehouse / downstream sink",destinationTooltip:"Lakehouse, staging DB, or microservice applying captured rows.",topicFormat:e=>`cdc.${e}_ct`,methodCopyOverrides:{polling:{label:"Polling (T-SQL jobs)",laneDescription:"Scheduled queries compare source tables against a shadow copy.",callout:"Hard deletes vanish and rapid updates collapse to last-write wins.",whenToUse:"Only when CDC can't be enabled. Expect drift and operational overhead.",tooltip:"Agent jobs issuing SELECT deltas against the primary."},trigger:{label:"DB triggers (audit tables)",laneDescription:"DDL-driven triggers write into audit tables that ETL picks up.",callout:"Adds synchronous writes and complicates deployments.",whenToUse:"Fallback for editions without CDC but needing full fidelity.",tooltip:"FOR INSERT/UPDATE/DELETE triggers persisting rows into audit tables."},log:{label:"CDC change table stream",laneDescription:"Native CDC surfaces ordered change rows ready for downstream ETL.",callout:"Balanced approach: leverages log reader agent with minimal code.",whenToUse:"Default when SQL Server Enterprise/Standard CDC is available.",tooltip:"Change Data Capture tables populated by the log reader agent."}}},ORACLE_GG:{id:"ORACLE_GG",label:"Oracle · GoldenGate",description:"GoldenGate extracts Oracle redo into trails that replicat apply downstream.",docsHint:"https://docs.oracle.com/en/middleware/goldengate/",sourceLabel:"Oracle primary",sourceTooltip:"Oracle Database generating redo entries for tracked schemas.",logLabel:"Redo / GoldenGate trail",logTooltip:"Extract captures redo logs into GoldenGate trail files.",busLabel:"GoldenGate distribution",busTooltip:"GoldenGate distribution path replicates changes to targets or Kafka.",destinationLabel:"Replica / downstream sink",destinationTooltip:"Target database, cache, or Kafka topic consuming GoldenGate trails.",topicFormat:e=>`ogg.${e}`,methodCopyOverrides:{polling:{label:"Polling (custom jobs)",laneDescription:"Scripts query Oracle tables for deltas outside of GoldenGate.",callout:"Expensive and incomplete without change tracking columns.",whenToUse:"Rare stopgap for small tables when GoldenGate access is unavailable.",tooltip:"Ad-hoc jobs diffing source tables over DB links or snapshots."},trigger:{label:"Triggers (shadow tables)",laneDescription:"Row-level triggers populate shadow tables for downstream capture.",callout:"Adds redo volume and requires meticulous deployment management.",whenToUse:"Fallback when GoldenGate licensing or access is restricted.",tooltip:"Oracle triggers mirroring mutations into custom staging tables."},log:{label:"GoldenGate redo tail",laneDescription:"GoldenGate Extract/Replicat stream redo into ordered trail files.",callout:"Enterprise-grade: minimal source impact with robust replication semantics.",whenToUse:"Primary approach for Oracle sources requiring guaranteed replication.",tooltip:"GoldenGate Extract reading redo logs into trail files."}}},MONGODB_STREAMS:{id:"MONGODB_STREAMS",label:"MongoDB · Change Streams",description:"Change Streams tail the MongoDB oplog and push updates to subscribers.",docsHint:"https://www.mongodb.com/docs/manual/changeStreams/",sourceLabel:"MongoDB replica set",sourceTooltip:"Replica set primary emitting operations into the oplog.",logLabel:"Change stream (oplog)",logTooltip:"Change Stream cursor streams oplog events filtered per namespace.",busLabel:"Driver subscriber",busTooltip:"Driver / connector pushes stream events to downstream sinks (Kafka/Atlas).",destinationLabel:"Streaming sink",destinationTooltip:"Analytical store or service consuming the stream.",topicFormat:e=>`mongo.${e}`,methodCopyOverrides:{polling:{label:"Polling (find queries)",laneDescription:"Scheduled queries diff collections by last-updated timestamps.",callout:"No delete visibility and heavy load for high-churn collections.",whenToUse:"Only for prototypes without Change Stream or oplog access.",tooltip:"find() queries scanning for updated documents on an interval."},trigger:{label:"Hooks (side-write)",laneDescription:"Application-layer hooks write audit documents alongside originals.",callout:"Requires app changes and doubles write throughput.",whenToUse:"When database triggers/log access is unavailable and app control exists.",tooltip:"Custom middleware duplicating writes into audit collections."},log:{label:"Change Stream tail",laneDescription:"Native Change Stream cursor fans out oplog events in order.",callout:"Recommended: low-latency stream with resume tokens and schema support.",whenToUse:"Default for MongoDB replicas when you can open a Change Stream cursor.",tooltip:"MongoDB Change Stream subscription on the oplog."}}}},ss="cdc_playground_template_filter_v1",ns="cdc_playground_template_filter_tags_v1",os={query:"",tags:[]},na=e=>typeof e=="string"?e:"",Jn=e=>{if(!Array.isArray(e))return[];const t=new Set,r=[];return e.forEach(a=>{if(a==null)return;const i=String(a).trim();!i||t.has(i)||(t.add(i),r.push(i))}),r},Us=e=>{if(!e||typeof e!="object")return{...os};const t=na(typeof e.query=="string"?e.query:""),r=e.tags;if(Array.isArray(r))return{query:t,tags:Jn(r)};if(typeof r=="string"){const a=r.trim();return{query:t,tags:a?[a]:[]}}return{query:t,tags:[]}},ra=(e,t)=>{if(e===t)return!0;if(e.length!==t.length)return!1;for(let r=0;r<e.length;r+=1)if(e[r]!==t[r])return!1;return!0},aa=e=>typeof e!="string"?"":e,oa=e=>{if(typeof e!="string"||e.trim().length===0)return[];try{const t=JSON.parse(e);if(Array.isArray(t))return Jn(t)}catch{}return[]},ia=e=>{if(!e)return{...os};try{const t=aa(e.getItem(ss)),r=oa(e.getItem(ns));return{query:t,tags:r}}catch{return{...os}}},la=(e,t)=>{if(!t)return;const r=Us(e);try{r.query?t.setItem(ss,r.query):typeof t.removeItem=="function"?t.removeItem(ss):t.setItem(ss,"")}catch{}try{r.tags.length>0?t.setItem(ns,JSON.stringify(r.tags)):typeof t.removeItem=="function"?t.removeItem(ns):t.setItem(ns,"")}catch{}},ca=e=>typeof e=="string"?e.trim().toLowerCase():"",kn=e=>Array.isArray(e)?e.map(t=>typeof t=="string"?t.trim():"").filter(t=>t.length>0):[],da=e=>{const t=[];return e.label&&t.push(e.label),e.description&&t.push(e.description),e.highlight&&t.push(e.highlight),e.name&&t.push(e.name),Array.isArray(e.tags)&&e.tags.length>0&&t.push(e.tags.join(" ")),t.join(" ").toLowerCase()};function ua(e,t={}){const r=Array.from(e),{liveScenario:a,liveScenarioName:i,tags:u,query:h}=t;if(a){const S=r.findIndex(w=>w.name===a.name);S>=0?r.splice(S,1,a):r.unshift(a)}const b=kn(u),N=ca(h).split(/\s+/).map(S=>S.trim()).filter(S=>S.length>0);return r.filter(S=>{if(i&&S.name===i)return!0;if(b.length>0){const x=kn(S.tags??[]);if(!b.every(d=>x.includes(d)))return!1}if(N.length===0)return!0;const w=da(S);return w?N.every(x=>w.includes(x)):!1})}const Os=(e,t)=>{Array.isArray(t)&&t.forEach(r=>{if(typeof r!="string")return;const a=r.trim();a.length>0&&e.add(a)})};function ha(e,t={}){const r=new Set;return e.forEach(a=>Os(r,a.tags)),t.liveScenario&&Os(r,t.liveScenario.tags),t.additionalTags?.forEach(a=>Os(r,a)),Array.from(r).sort((a,i)=>a.localeCompare(i))}const pa={"snapshot ➜ stream handoff":{summary:"Show how a snapshot catch-up hands control to the streaming tail while keeping tables consistent across methods.",controls:[{title:"Keep log + trigger enabled",detail:"Run both streaming lanes to compare how quickly they drain the backlog once the snapshot is done."},{title:"Apply on commit",detail:"Ensure atomic updates across tables once the stream takes over so item/order rows never drift during the handoff."},{title:"Throttle apply briefly",detail:"Enable the apply rate limiter to surface how much backlog accumulates during the snapshot phase versus live tailing."}],observations:[{title:"Mind duplicate delivery",detail:"Use the event log filters to confirm the first stream event after the snapshot resumes doesn't replay rows already applied."},{title:"Lag recovery",detail:"Track lag spread to show which capture method clears the handoff backlog fastest once throttling is removed."}]},"snapshot replay":{summary:"Rebuild state from a snapshot, then keep tails aligned while new mutations arrive mid-replay.",controls:[{title:"Leave polling disabled",detail:"Focus on trigger/log methods so the replay highlights ordered change events instead of bulk diffs."},{title:"Pause/resume apply",detail:"Pause apply mid-snapshot to show partially hydrated tables, then resume to watch the tail catch up."},{title:"Filter snapshot ops",detail:"Filter the event log to op=s to separate snapshot seeds from live updates when explaining offsets."}],observations:[{title:"Offset safety",detail:"Demonstrate that once the snapshot completes, resumed streams continue without reprocessing completed chunks."},{title:"Backlog pressure",detail:"Watch backlog counters while the replay runs; streaming methods should stay ahead of trigger overhead."}]},"orders + items transactions":{summary:"Highlight multi-table atomicity and why apply-on-commit matters for transactional feeds.",controls:[{title:"Enable apply-on-commit",detail:"Group transaction events so orders/items stay consistent even if a lane pauses mid-flight."},{title:"Toggle consumer pause",detail:"Pause apply during a multi-row commit to show how partial apply would drift if atomic grouping is off."},{title:"Keep log + trigger on",detail:"Contrast log ordering guarantees with trigger write amplification when commits include multiple tables."}],observations:[{title:"Out-of-order risk",detail:"Use the lane diff overlay to surface any sequence gaps when apply-on-commit is disabled."},{title:"Write amplification",detail:"Inspect trigger metrics to show the extra writes incurred versus log capture for the same transaction."}]},"outbox relay":{summary:"Compare an application-managed outbox with log capture and where each shines.",controls:[{title:"Disable polling",detail:"Keep focus on outbox vs. log/trigger capture; polling collapses the ordering story to diffs."},{title:"Filter to outbox table",detail:"Use the event log table filter to spotlight outbox_events entries and their ordering keys."},{title:"Keep apply-on-commit off",detail:"Allow partial apply to show how outbox can still preserve business ordering when consumers lag."}],observations:[{title:"Idempotent keys",detail:"Call out event_key usage and show how downstream sinks can dedupe on that key even if retries occur."},{title:"Replay behaviour",detail:"Reset and step through to prove outbox emits stable events even when upstream rows churn."}]},"retention & erasure":{summary:"Demonstrate privacy deletes, masking, and soft-delete visibility across methods.",controls:[{title:"Enable soft delete column",detail:"Turn on the polling soft-delete marker so diffs retain tombstones instead of dropping rows silently."},{title:"Keep polling slower",detail:"Use a longer poll interval (1–2s) to show how lag makes soft-delete visibility diverge from log capture."},{title:"Use event search",detail:"Filter for delete ops (d) to compare how each method surfaces erasure events and masking updates."}],observations:[{title:"Hard vs. soft delete",detail:"Point out that polling without the marker loses hard deletes, while log/trigger lanes emit explicit tombstones."},{title:"Compliance lag",detail:"Watch lag spread to discuss how quickly each method propagates erasure, especially under throttled apply."}]},"burst updates":{summary:"Stress test lag/ordering under rapid-fire updates to the same keys.",controls:[{title:"Throttle apply",detail:"Enable the apply rate limiter to build backlog and make ordering differences visible in the diff overlay."},{title:"Tighten log fetch interval",detail:"Drop the log fetch interval toward 50–100ms to show near-real-time log capture versus slower polling."},{title:"Disable generator",detail:"Keep the synthetic generator off so the scenario traffic stays focused on the curated burst pattern."}],observations:[{title:"Last-write wins",detail:"Use the event log search to show how polling collapses intermediate updates when bursts occur."},{title:"Lag hotspots",detail:"Check metrics dashboard to spot which lane accumulates the largest p95 lag under sustained bursts."}]}};function ma(e){if(!e)return null;const t=e.trim().toLowerCase();return pa[t]??null}const Bs=e=>{if(Array.isArray(e))return e.map(t=>Bs(t));if(e&&typeof e=="object"){const t={};return Object.entries(e).forEach(([r,a])=>{t[r]=Bs(a)}),t}return e},rs=e=>Bs(e),Yn=e=>({...e}),Ln=e=>({name:e.name,version:e.version,columns:e.columns.map(Yn)}),ga=(e,t)=>typeof t=="boolean"?"bool":typeof t=="number"?/_ts$|timestamp$/i.test(e)?"timestamp":"number":t instanceof Date?"timestamp":"string",fa=(e,t=1)=>({name:e,version:t,columns:[{name:"id",type:"string",nullable:!1}]}),Tn=e=>{e.columns.some(r=>r.name==="id")||e.columns.unshift({name:"id",type:"string",nullable:!1})},Mn=e=>{const t=rs(e);return t.id=String(t.id),t};class Ds{constructor(t=[]){this.tables=new Map,t.forEach(r=>this.upsertTable(r))}upsertTable(t){const r=Ln(t.schema);Tn(r);const a=new Map;t.rows.forEach(i=>{const u=Mn(rs(i));a.set(u.id,u)}),this.tables.set(t.name,{schema:r,rows:a})}replaceAll(t){this.tables.clear(),t.forEach(r=>this.upsertTable(r))}getTable(t){const r=this.tables.get(t);if(r)return{name:t,schema:Ln(r.schema),rows:Array.from(r.rows.values()).map(a=>rs(a))}}listTables(){return Array.from(this.tables.keys()).map(t=>this.getTable(t)).filter(t=>!!t)}clear(){this.tables.clear()}applyEvents(t){t.forEach(r=>this.applyEvent(r))}applyEvent(t){if(!t?.table)return;if(t.kind==="SCHEMA_ADD_COL"||t.kind==="SCHEMA_DROP_COL"){this.applySchemaChange(t);return}const r=this.ensureTableState(t.table,t.schemaVersion);if(t.schemaVersion&&t.schemaVersion>r.schema.version&&(r.schema.version=t.schemaVersion),t.kind==="DELETE"){const k=t.before?.id??t.after?.id;k!=null&&r.rows.delete(String(k));return}const a=t.after??void 0;if(!a)return;const i=Mn(a),u=r.rows.get(i.id),h=u?{...u,...i}:i,b=rs(h);this.syncSchemaColumns(r,b),r.rows.set(b.id,b)}snapshot(){return this.listTables()}ensureTableState(t,r){let a=this.tables.get(t);return a||(a={schema:fa(t,r??1),rows:new Map},this.tables.set(t,a)),r&&r>a.schema.version&&(a.schema.version=r),Tn(a.schema),a}applySchemaChange(t){const r=t.schemaChange;if(!r)return;const a=this.ensureTableState(t.table,r.nextVersion??t.schemaVersion);a.schema.version=Math.max(a.schema.version,r.nextVersion??t.schemaVersion??a.schema.version),t.kind==="SCHEMA_ADD_COL"?this.addColumn(a,r.column):t.kind==="SCHEMA_DROP_COL"&&this.dropColumn(a,r.column.name)}addColumn(t,r){const a=t.schema.columns.find(i=>i.name===r.name);a?(a.type=r.type,r.nullable&&(a.nullable=!0)):t.schema.columns.push(Yn(r)),t.rows.forEach(i=>{r.name in i||(i[r.name]=null)})}dropColumn(t,r){r!=="id"&&(t.schema.columns=t.schema.columns.filter(a=>a.name!==r),t.rows.forEach(a=>{r in a&&delete a[r]}))}syncSchemaColumns(t,r){const a=t.schema.columns;Object.entries(r).forEach(([i,u])=>{if(i==="id"||i.startsWith("__"))return;let h=a.find(b=>b.name===i);h||(h={name:i,type:ga(i,u)},a.push(h)),u==null&&(h.nullable=!0)})}}const ba=2e3,Qt={methods:[],ops:[],tables:[],txns:[]},An={empty:"No events yet.",noMatch:"No events match the current filters."},Nn=(e,t,r)=>{const a=new Map;e.forEach(h=>{const b=t(h);if(!b)return;const k=r(h);a.has(b)||a.set(b,{label:k,count:0}),a.get(b).count+=1});const i=e.length||1,u=Array.from(a.entries()).map(([h,b])=>({id:h,label:b.label,count:b.count,percent:Math.round(b.count/i*100)}));return u.sort((h,b)=>b.count!==h.count?b.count-h.count:h.label.localeCompare(b.label)),u},In=e=>{if(!e)return"";try{const t=JSON.stringify(e);return t?t.length>160?`${t.slice(0,160)}…`:t:""}catch{return""}},qs=e=>{if(typeof e!="string")return"";const t=e.trim();if(!t)return"";const r=t.toLowerCase();return["c","create","insert","i"].includes(r)?"insert":["u","update"].includes(r)?"update":["d","delete"].includes(r)?"delete":r},On=e=>{const t=qs(e);if(t==="insert"||t==="update"||t==="delete")return t.toUpperCase();if(typeof e!="string")return"—";const r=e.trim();return r?r.toUpperCase():"—"},xa=({events:e,stats:t,totalCount:r,filters:a={},filterOptions:i,onFiltersChange:u,onDownload:h,onClear:b,onCopyEvent:k,onReplayEvent:N,maxVisibleEvents:S=ba,emptyMessage:w,noMatchMessage:x,className:C})=>{const d={methods:i?.methods??Qt.methods,ops:i?.ops??Qt.ops,tables:i?.tables??Qt.tables,txns:i?.txns??Qt.txns},g=c.useMemo(()=>typeof S!="number"||S<=0?e.length:Math.min(S,e.length),[e.length,S]),[f,v]=c.useState(g);c.useEffect(()=>{v(E=>E<g?g:E>e.length?e.length:E)},[g,e.length]);const T=c.useMemo(()=>{const E=Math.max(f,0),J=Math.max(e.length-E,0);return e.slice(J)},[e,f]),L=c.useMemo(()=>e.length?T.length===e.length?`${T.length} visible`:`Latest ${T.length} of ${e.length}`:"",[e.length,T.length]),$=c.useMemo(()=>Nn(T,E=>qs(E.op),E=>On(E.op)),[T]),q=c.useMemo(()=>Nn(T,E=>E.methodId??E.methodLabel??"",E=>E.methodLabel||E.methodId||""),[T]),ie=T.length<e.length,H=f>g,gt=()=>{if(!ie)return;const E=g>0?g:e.length;v(J=>Math.min(J+E,e.length))},M=()=>{v(g)},Oe=typeof r=="number"?r:e.length,De=!!a.methodId||!!a.op||!!a.table||!!a.txnId,Re={empty:w??An.empty,noMatch:x??An.noMatch},$e=E=>{if(!u)return;const J={methodId:E.methodId===void 0?a.methodId:E.methodId,op:E.op===void 0?a.op:E.op,table:E.table===void 0?a.table:E.table,txnId:E.txnId===void 0?a.txnId:E.txnId},X={methodId:J.methodId||void 0,op:J.op||void 0,table:J.table||void 0,txnId:J.txnId||void 0};u(X)},tt=E=>{const J=In(E.before),X=In(E.after);return!J&&!X?null:n.jsxs("details",{className:"cdc-event-log__details",children:[n.jsx("summary",{children:"Row image"}),J&&n.jsxs("div",{className:"cdc-event-log__details-row",children:[n.jsx("span",{children:"before"}),n.jsx("code",{children:J})]}),X&&n.jsxs("div",{className:"cdc-event-log__details-row",children:[n.jsx("span",{children:"after"}),n.jsx("code",{children:X})]})]})};return n.jsxs("section",{className:`cdc-event-log${C?` ${C}`:""}`,"aria-label":"Event log",role:"region",children:[n.jsxs("header",{className:"cdc-event-log__header",children:[n.jsxs("div",{className:"cdc-event-log__headline",children:[n.jsx("h3",{children:"Event Log"}),t&&n.jsxs("p",{className:"cdc-event-log__stats",children:[n.jsxs("span",{children:["Produced ",t.produced]})," · ",n.jsxs("span",{children:["Consumed ",t.consumed]})," · ",n.jsxs("span",{children:["Backlog ",t.backlog]}),typeof t.snapshotRows=="number"&&n.jsxs(n.Fragment,{children:[" · ",n.jsxs("span",{children:["Snapshot rows ",t.snapshotRows]})]})]})]}),n.jsxs("div",{className:"cdc-event-log__actions",children:[n.jsxs("span",{children:[e.length," events"]}),n.jsx("button",{type:"button",onClick:h,disabled:!h||e.length===0,children:"Download NDJSON"}),n.jsx("button",{type:"button",onClick:b,disabled:!b||Oe===0,children:"Clear"})]})]}),n.jsxs("div",{className:"cdc-event-log__filters",role:"group","aria-label":"Event log filters",children:[n.jsxs("label",{children:[n.jsx("span",{children:"Method"}),n.jsxs("select",{value:a.methodId??"",onChange:E=>$e({methodId:E.target.value||void 0}),disabled:!u||d.methods.length===0,children:[n.jsx("option",{value:"",children:"All methods"}),d.methods.map(E=>n.jsx("option",{value:E.id,children:E.label},E.id))]})]}),n.jsxs("label",{children:[n.jsx("span",{children:"Operation"}),n.jsxs("select",{value:a.op??"",onChange:E=>$e({op:E.target.value||void 0}),disabled:!u||d.ops.length===0,children:[n.jsx("option",{value:"",children:"All ops"}),d.ops.map(E=>n.jsx("option",{value:E,children:E.toUpperCase()},E))]})]}),n.jsxs("label",{children:[n.jsx("span",{children:"Table"}),n.jsxs("select",{value:a.table??"",onChange:E=>$e({table:E.target.value||void 0}),disabled:!u||d.tables.length===0,children:[n.jsx("option",{value:"",children:"All tables"}),d.tables.map(E=>n.jsx("option",{value:E,children:E},E))]})]}),n.jsxs("label",{children:[n.jsx("span",{children:"Txn"}),n.jsxs("select",{value:a.txnId??"",onChange:E=>$e({txnId:E.target.value||void 0}),disabled:!u||d.txns.length===0,children:[n.jsx("option",{value:"",children:"All txns"}),d.txns.map(E=>n.jsx("option",{value:E,children:E},E))]})]})]}),T.length>0&&n.jsxs("div",{className:"cdc-event-log__summary",role:"status","aria-live":"polite",children:[n.jsxs("div",{className:"cdc-event-log__summary-block",children:[n.jsxs("div",{className:"cdc-event-log__summary-heading",children:[n.jsx("h4",{children:"Change mix"}),L?n.jsx("span",{children:L}):null]}),n.jsx("div",{className:"cdc-event-log__summary-pills","aria-label":"Change operations distribution",children:$.length>0?$.map(E=>n.jsxs("span",{className:"cdc-event-log__pill",children:[n.jsx("strong",{children:E.label}),n.jsxs("span",{children:[E.count," · ",E.percent,"%"]})]},E.id)):n.jsx("span",{className:"cdc-event-log__pill cdc-event-log__pill--muted",children:"No op codes"})})]}),n.jsxs("div",{className:"cdc-event-log__summary-block",children:[n.jsxs("div",{className:"cdc-event-log__summary-heading",children:[n.jsx("h4",{children:"Method mix"}),L?n.jsx("span",{children:L}):null]}),n.jsx("div",{className:"cdc-event-log__summary-pills","aria-label":"Method distribution",children:q.length>0?q.map(E=>n.jsxs("span",{className:"cdc-event-log__pill",children:[n.jsx("strong",{children:E.label||"Unknown"}),n.jsxs("span",{children:[E.count," · ",E.percent,"%"]})]},E.id)):n.jsx("span",{className:"cdc-event-log__pill cdc-event-log__pill--muted",children:"No method labels"})})]})]}),e.length===0?n.jsx("p",{className:"cdc-event-log__empty",children:Oe>0||De?Re.noMatch:Re.empty}):n.jsxs("ul",{className:"cdc-event-log__list",children:[e.length>T.length&&n.jsxs("li",{className:"cdc-event-log__notice",children:[n.jsxs("span",{children:["Showing latest ",T.length," of ",e.length," events."]}),n.jsxs("div",{className:"cdc-event-log__notice-actions",children:[n.jsx("button",{type:"button",onClick:gt,disabled:!ie,children:"Load more"}),H&&n.jsx("button",{type:"button",onClick:M,children:"Show latest"})]})]}),T.map(E=>{const J=On(E.op),X=qs(E.op),ft=typeof E.offset=="number"?E.offset:E.offset==null?"—":E.offset,le=E.topic??"—",bt=E.table??"—",Pe=E.pk??"—",Ee=E.txnId??"",ce=typeof E.tsMs=="number"?E.tsMs:"—",ls=X==="insert"||X==="update"||X==="delete";return n.jsxs("li",{className:"cdc-event-log__item",children:[n.jsx("span",{className:"cdc-event-log__method",children:E.methodLabel??E.methodId??"—"}),n.jsx("span",{className:"cdc-event-log__op","data-op":J,children:J}),n.jsxs("span",{className:"cdc-event-log__offset",children:["offset ",ft]}),n.jsx("span",{className:"cdc-event-log__topic",children:le}),n.jsxs("span",{className:"cdc-event-log__table",children:["table ",bt]}),n.jsxs("span",{className:"cdc-event-log__meta",children:["ts=",ce,"ms · pk=",Pe,Ee?` · txn=${Ee}`:""]}),E.meta?n.jsx("span",{className:"cdc-event-log__extra",children:E.meta}):null,N?n.jsx("button",{type:"button",className:"cdc-event-log__replay",onClick:()=>N?.(E),disabled:!ls,children:"Replay"}):null,n.jsx("button",{type:"button",className:"cdc-event-log__copy",onClick:()=>k?.(E),disabled:!k,children:"Copy"}),tt(E)]},E.id)})]})]})};function ya(e){const t=e.op?.toUpperCase?.()??"?",r=e.pk??"∅",a=e.expectedIndex!=null?`#${e.expectedIndex}`:void 0,i=e.actualIndex!=null?`#${e.actualIndex}`:void 0;return e.type==="missing"?`Missing ${t} for pk=${r} (${a??"expected"} @ ${e.expectedTime??"?"}ms)`:e.type==="extra"?`Unexpected ${t} for pk=${r} (${i??"emitted"} @ ${e.actualTime??"?"}ms)`:`Out-of-order ${t} pk=${r} (expected ${a??"?"} before actual ${i??"?"})`}const va=({diff:e,scenarioName:t,laneId:r,schemaStatus:a,onDiffDetailsOpened:i})=>{if(!e)return null;const{totals:u,issues:h,lag:b}=e,k=u.missing>0||u.extra>0||u.ordering>0,N=h.slice(0,6);let S=null;return a&&(a.hasColumn?a.version<a.expectedVersion&&(S=`Schema behind: v${a.version} (expected v${a.expectedVersion})`):S=`${a.columnName} column missing in destination`),!k&&b.max<=0&&!S?null:n.jsxs("div",{className:"sim-shell__lane-diff","data-has-issues":k?"true":"false",role:"note",children:[n.jsxs("div",{className:"sim-shell__lane-diff-summary",children:[k?n.jsxs(n.Fragment,{children:[u.missing>0&&n.jsxs("span",{className:"sim-shell__lane-diff-chip sim-shell__lane-diff-chip--missing",children:[u.missing," missing"]}),u.extra>0&&n.jsxs("span",{className:"sim-shell__lane-diff-chip sim-shell__lane-diff-chip--extra",children:[u.extra," extra"]}),u.ordering>0&&n.jsxs("span",{className:"sim-shell__lane-diff-chip sim-shell__lane-diff-chip--ordering",children:[u.ordering," ordering"]})]}):n.jsx("span",{className:"sim-shell__lane-diff-chip sim-shell__lane-diff-chip--ok",children:"Operations aligned"}),b.max>0&&n.jsxs("span",{className:"sim-shell__lane-diff-chip sim-shell__lane-diff-chip--lag",children:["Max lag ",Math.round(b.max),"ms"]})]}),S&&n.jsx("p",{className:"sim-shell__lane-diff-schema",children:S}),(N.length>0||b.samples.length>0)&&n.jsxs("details",{id:r?`lane-diff-${r}`:void 0,className:"sim-shell__lane-diff-details",onToggle:w=>{w.target.open&&i?.({method:e.method,issueCount:e.issues.length,maxLag:e.lag.max,scenario:t})},children:[n.jsx("summary",{children:"Diff details"}),N.length>0&&n.jsx("ul",{className:"sim-shell__lane-diff-list",children:N.map((w,x)=>n.jsx("li",{children:ya(w)},`${w.type}-${w.op}-${w.pk??"∅"}-${x}`))}),h.length>N.length&&n.jsxs("p",{className:"sim-shell__lane-diff-more",children:["+",h.length-N.length," additional difference(s)"]}),b.samples.length>0&&n.jsxs("div",{className:"sim-shell__lane-diff-lag",children:[n.jsx("h4",{children:"Lag hotspots"}),n.jsx("ul",{children:b.samples.map(w=>n.jsxs("li",{children:[Math.round(w.lagMs),"ms on ",w.op.toUpperCase()," pk=",w.pk??"∅"]},`${w.op}-${w.pk??"∅"}-${w.actualTime??"?"}`))})]})]})]})},Ye=Qn,Xn=.05,_a=1+Xn,wa=e=>e.replace(/\.0$/,"");function Se(e){return typeof e=="number"&&Number.isFinite(e)&&e>=_a}function Sa(e){return`${(Number.isFinite(e)?Math.max(e,0):0).toFixed(1)}x`}function Xe(e){const t=Sa(e),r=Number.isFinite(e)?Math.max(e-1,0):0;if(r<Xn)return t;const a=r>=10?0:r>=1?1:2,i=wa(r.toFixed(a));return`${t} (~${i} extra writes/change)`}const pe=e=>Number.isFinite(e)?e.toLocaleString():"—",Dn=e=>Number.isFinite(e)?`${Math.round(e)}ms`:"—",Ea=({lanes:e,renderSchemaWalkthrough:t})=>{const r=e.reduce((a,i)=>(a.produced+=i.produced,a.consumed+=i.consumed,a.backlog+=i.backlog,a),{produced:0,consumed:0,backlog:0});return n.jsxs("section",{className:"sim-shell__metrics-dashboard","aria-label":"Runtime metrics",children:[n.jsx("header",{className:"sim-shell__metrics-dashboard-header",children:n.jsxs("div",{children:[n.jsx("h3",{children:"Runtime metrics"}),n.jsxs("p",{children:["Produced ",pe(r.produced)," · Consumed ",pe(r.consumed)," · Backlog ",pe(r.backlog)]})]})}),n.jsx("div",{className:"sim-shell__metrics-dashboard-grid",children:e.map(a=>n.jsxs("article",{className:"sim-shell__metrics-dashboard-card",children:[n.jsx("header",{children:n.jsx("h4",{"data-tooltip":a.tooltip||void 0,children:a.label})}),t&&n.jsx("div",{className:"sim-shell__schema-demo-inline",children:t(a.id)}),n.jsxs("dl",{children:[n.jsxs("div",{children:[n.jsx("dt",{children:"Produced"}),n.jsx("dd",{children:pe(a.produced)})]}),n.jsxs("div",{children:[n.jsx("dt",{children:"Consumed"}),n.jsx("dd",{children:pe(a.consumed)})]}),n.jsxs("div",{children:[n.jsx("dt",{children:"Backlog"}),n.jsx("dd",{"data-tooltip":Ye.backlog,children:pe(a.backlog)})]}),n.jsxs("div",{children:[n.jsx("dt",{children:"Lag p50"}),n.jsx("dd",{"data-tooltip":Ye.lagPercentile,children:Dn(a.lagP50)})]}),n.jsxs("div",{children:[n.jsx("dt",{children:"Lag p95"}),n.jsx("dd",{"data-tooltip":Ye.lagPercentile,children:Dn(a.lagP95)})]}),typeof a.snapshotRows=="number"&&n.jsxs("div",{children:[n.jsx("dt",{children:"Snapshot rows"}),n.jsx("dd",{"data-tooltip":Ye.snapshot,children:pe(a.snapshotRows)})]}),(typeof a.inserts=="number"||typeof a.updates=="number"||typeof a.deletes=="number")&&n.jsxs("div",{children:[n.jsx("dt",{children:"Change mix"}),n.jsxs("dd",{children:["C ",pe(a.inserts??0)," · U ",pe(a.updates??0)," · D ",pe(a.deletes??0),typeof a.schemaChanges=="number"&&a.schemaChanges>0?` · Schema ${pe(a.schemaChanges)}`:""]})]}),typeof a.missedDeletes=="number"&&n.jsxs("div",{children:[n.jsx("dt",{children:"Missed deletes"}),n.jsx("dd",{"data-tooltip":Ye.deleteCapture,children:pe(a.missedDeletes)})]}),Se(a.writeAmplification)&&n.jsxs("div",{children:[n.jsx("dt",{children:"Write amplification"}),n.jsx("dd",{"data-tooltip":Ye.triggerWriteAmplification,children:Xe(a.writeAmplification)})]})]})]},a.id))})]})},ja=({lagMs:e,throughput:t,deletesPct:r,orderingOk:a,consistent:i,writeAmplification:u,insertCount:h,updateCount:b,deleteCount:k,schemaChangeCount:N})=>n.jsxs("div",{role:"status","aria-live":"polite",children:[n.jsxs("span",{children:["Lag: ",e,"ms"]})," ·",n.jsxs("span",{children:["TPS: ",t.toFixed(1)]})," ·",n.jsxs("span",{children:["Deletes: ",Math.round(r),"%"]})," ·",n.jsxs("span",{children:["Ordering: ",a?"OK":"KO"]})," ·",n.jsxs("span",{children:["Consistency: ",i?"OK":"Drift"]})," ","·",n.jsxs("span",{children:["Ops C/U/D: ",h,"/",b,"/",k]}),N>0&&n.jsxs(n.Fragment,{children:[" ","·",n.jsxs("span",{children:["Schema: ",N]})]}),Se(u)&&n.jsxs(n.Fragment,{children:[" ","·",n.jsxs("span",{"data-tooltip":Ye.triggerWriteAmplification,children:["Trigger WA: ",Xe(u)]})]})]}),Ca=({onAdd:e,onDrop:t,columnName:r,disabled:a,disableAdd:i,disableDrop:u,status:h})=>n.jsxs("section",{className:"sim-shell__schema-demo","aria-label":"Schema walkthrough",children:[n.jsxs("header",{children:[n.jsx("h4",{children:"Schema walkthrough"}),n.jsxs("p",{children:["Add or drop ",n.jsx("code",{children:r})," while events stream to compare capture behaviour."]})]}),h?n.jsx("p",{className:"sim-shell__schema-demo-status",children:h}):null,n.jsxs("div",{className:"sim-shell__schema-demo-buttons",children:[n.jsxs("button",{type:"button",onClick:e,disabled:a||i,"data-tour-target":"schema-add",children:["Add ",r]}),n.jsxs("button",{type:"button",onClick:t,disabled:a||u,"data-tour-target":"schema-drop",children:["Drop ",r]})]})]}),Tt=e=>{if(Array.isArray(e))return e.map(t=>Tt(t));if(e&&typeof e=="object"){const t={};return Object.entries(e).forEach(([r,a])=>{t[r]=Tt(a)}),t}return e},Ke=e=>{if(typeof e=="number"&&Number.isFinite(e))return e;if(typeof e=="string"&&e.trim().length>0){const t=Number(e);return Number.isFinite(t)?t:null}return null},ka=e=>{if(typeof e=="boolean")return e;if(typeof e=="string"){const t=e.trim().toLowerCase();if(t==="true")return!0;if(t==="false")return!1}return null},Ze=e=>{if(e==null)return null;if(typeof e=="string"){const t=e.trim();return t.length>0?t:null}return typeof e=="number"&&Number.isFinite(e)?String(e):typeof e=="boolean"?e?"true":"false":null},La=e=>{if(!e)return null;if(typeof e=="object"){const r=e;if(r&&Object.prototype.hasOwnProperty.call(r,"id")){const a=Ze(r.id);return a?{id:a}:null}}const t=Ze(e);return t?{id:t}:null},Ta=e=>{const t=e.event??{},r=Ze(e.method),a=Ke(t.offset),i=Ke(t.seq),u=Ke(t.ts_ms)??Ke(t.tsMs)??Ke(t.ts),h=Ze(t.op),b=Ze(t.table),k=La(t.pk),N=t.before==null?null:Tt(t.before),S=t.after==null?null:Tt(t.after),w=Ze(t.topic),x=t.tx??null,C=Ze(x?.id??t.txnId),d=Ke(x?.index??t.txnIndex),g=Ke(x?.total??t.txnTotal),f=ka(x?.last??t.txnLast),v=t.schemaChange==null?null:Tt(t.schemaChange);return{method:r??null,offset:a,seq:i,ts_ms:u,op:h,table:b,pk:k,before:N,after:S,topic:w,txn_id:C,txn_index:d,txn_total:g,txn_last:f,schema_change:v}},Ma=(e,t={})=>{const r=t.newline??`
`,a=[];for(const i of e){if(!i||typeof i!="object")continue;const u=Ta(i);a.push(JSON.stringify(u))}return a.join(r)},Aa="cdc_telemetry_buffer_v1",Na=200,Zn={activation:{key:"activation",label:"Activation",description:"Do new users reach their first comparator insight?"},funnel_drop:{key:"funnel_drop",label:"Funnel drop",description:"Where do users abandon the guided comparator walkthrough?"},adoption:{key:"adoption",label:"Adoption",description:"Which comparator features become part of regular usage?"},quality_gate:{key:"quality_gate",label:"Quality gate",description:"Do reliability issues or errors block comparator adoption?"},scenario_completeness:{key:"scenario_completeness",label:"Scenario completeness",description:"Which templates lead to full replay, export, and comparator review?"},collaboration:{key:"collaboration",label:"Collaboration",description:"How often do teams share scenarios or comparator snapshots?"}},Rn={"comparator.scenario.select":"activation","comparator.scenario.preview":"activation","comparator.preset.select":"activation","comparator.scenario.filter":"activation","comparator.scenario.tag_toggle":"funnel_drop","comparator.scenario.tag_clear":"funnel_drop","comparator.summary.copied":"activation","comparator.diff.opened":"funnel_drop","comparator.overlay.inspect":"activation","comparator.schema.change":"activation","comparator.clock.control":"funnel_drop","comparator.consumer.toggle":"funnel_drop","comparator.consumer.rate_toggle":"funnel_drop","comparator.consumer.rate_adjust":"activation","comparator.consumer.rate_reset":"activation","comparator.event.search":"activation","comparator.event.filter":"activation","comparator.panel.layout":"adoption","comparator.event.download":"adoption","comparator.event.clear":"adoption","comparator.event.copy":"activation","comparator.event.copy.error":"quality_gate","comparator.event.replay":"activation","comparator.destination.download":"adoption","comparator.generator.toggle":"adoption","comparator.generator.rate_adjust":"adoption","comparator.generator.burst":"activation","tour.started":"funnel_drop","tour.completed":"activation","tour.dismissed":"funnel_drop","workspace.share.generated":"collaboration","workspace.scenario.imported":"scenario_completeness","workspace.scenario.template_loaded":"activation","workspace.scenario.exported":"scenario_completeness","telemetry.flush":"activation"},er=e=>!!e&&typeof e=="object"&&!Array.isArray(e),is=e=>{if(!er(e))return{};const t={};return Object.keys(e).forEach(r=>{t[r]=e[r]}),t},Ia=()=>({getItem:()=>null,setItem:()=>{}}),Oa=e=>{try{return e.toISOString()}catch{return new Date().toISOString()}},Da=e=>{if(!er(e))return null;const t=typeof e.event=="string"?e.event:null;if(!t)return null;const r=is(e.payload),a=is(e.context),i=typeof e.recordedAt=="string"?e.recordedAt:typeof e.recorded_at=="string"?e.recorded_at:null,u=i&&!Number.isNaN(Date.parse(i))?i:new Date().toISOString(),h=e.question,b=typeof h=="string"&&h in Zn?h:null;return{event:t,payload:r,context:a,question:b,recordedAt:u}},Ra=e=>({event:e.event,payload:e.payload,context:e.context,question:e.question,recordedAt:e.recordedAt}),$a=(e={})=>{const t=e.storage??(typeof window<"u"&&window.localStorage?window.localStorage:Ia()),r=e.storageKey??Aa,a=Math.max(1,e.maxEntries??Na),i=e.now??(()=>new Date),u=e.console??(typeof console<"u"?{warn:console.warn.bind(console),debug:console.debug.bind(console)}:{warn:()=>{},debug:()=>{}}),b=(()=>{try{const C=t.getItem(r);if(!C)return[];const d=JSON.parse(C);return Array.isArray(d)?d.map(Da).filter(f=>!!f).slice(-a):[]}catch(C){return u.warn("Telemetry buffer load failed",C),[]}})(),k=()=>{try{const C=b.slice(-a).map(Ra);t.setItem(r,JSON.stringify(C))}catch(C){u.warn("Telemetry buffer save failed",C)}};return{buffer:b,track:(C,d={},g={})=>{if(typeof C!="string"||!C.trim())return;const f=C.trim(),v={event:f,payload:is(d),context:is(g),question:Rn[f]??null,recordedAt:Oa(i())};b.push(v),b.length>a&&b.splice(0,b.length-a),k(),v.context.debug&&u.debug("[telemetry]",v)},flush:()=>{if(b.length===0)return[];const C=b.slice();return b.length=0,k(),C},questions:()=>Object.values(Zn).map(C=>({...C})),taxonomy:()=>({...Rn})}},Pa=e=>{const t=new Map,r=i=>{if(!e)return t.get(i)??null;try{const u=e.getItem(i);return typeof u=="string"?u:u??null}catch{return t.get(i)??null}},a=i=>{if(!e)return!1;try{return typeof e.removeItem=="function"?e.removeItem(i):e.setItem(i,""),!0}catch{return!1}};return{getItem(i){return t.has(i)?t.get(i)??null:r(i)},setItem(i,u){if(e)try{e.setItem(i,u),t.delete(i);return}catch{}t.set(i,u)},removeItem(i){t.delete(i),a(i)||t.set(i,null)}}},$n=e=>{const t=e.trim();if(!t.startsWith("|")||t==="|")return[];const r=t.split("|");return r.shift(),r.length>0&&r[r.length-1].trim()===""&&r.pop(),r.map(a=>a.trim())},tr=e=>{let t=e.trim(),r=!1;const a=["*","_"];let i=!0;for(;i&&t.length>=2;)i=!1,a.forEach(u=>{if(t.startsWith(u)&&t.endsWith(u)){const h=t.slice(u.length,t.length-u.length).trim();h.length>=0&&(t=h,r=!0,i=!0)}});return{text:t,emphasis:r}},Fa=e=>{const t=e.match(/^\[([^\]]+)\]\(([^)]+)\)$/);if(!t)return{text:e};const[,r,a]=t;return{text:r.trim(),href:a.trim()}},sr=e=>e.replace(/&nbsp;/gi," ").replace(/&#160;/g," "),Ua=e=>{if(!e)return{text:""};const t=sr(e),{text:r,emphasis:a}=tr(t),i=Fa(r);return{text:i.text.trim(),href:i.href,emphasis:a}},Ba=e=>e.length>0&&e.every(t=>/^:?[-=]+:?$/u.test(t.replace(/\s+/g,""))),qa=e=>{if(!e.length)return!1;const t=e[0].text.trim().toLowerCase();return t.length>0&&t.includes("no runs")&&t.includes("captured")},Wa=e=>{const t=e.split(/\r?\n/).map(b=>b.trim()).filter(b=>b.startsWith("|"));if(t.length<2)return null;const r=$n(t[0]);if(!r.length)return null;const a=r.map(b=>tr(sr(b)).text),i=t.slice(1),u=[];let h=null;return i.forEach(b=>{const k=$n(b);if(!k.length||Ba(k))return;const N=k.map(Ua);if(qa(N)){h=N[0].text.trim();return}N.every(S=>S.text==="")||u.push(N)}),{headers:a,rows:u,placeholder:h}};function Va(e,t){const r=structuredClone(e??{}),a=(i,u,h)=>{if(!i)return;const b=i[u],k=typeof b=="string"?b:h,N=k?t[k]:void 0;b!=null&&typeof b=="object"&&"label"in b||(i[u]={label:N?.label??String(k??b??""),tooltip:N?.tooltip,value:typeof b=="number"?b:b?.value??b})};return a(r,"bestLag",r?.bestLagId),a(r,"triggerWriteAmplification",r?.triggerWriteAmplificationId),Array.isArray(r.lanes)&&(r.lanes=r.lanes.map(i=>{const u=typeof i?.method=="string"?i.method:void 0,h=u?t[u]:void 0;return{...i,id:u,label:h?.label??u,tooltip:h?.tooltip}}).filter(Boolean)),r}class Ga{constructor(){this.scenario=null,this.engines=[],this.idx=0,this.now=0,this.playing=!1}attach(t){this.engines=t}load(t){this.scenario=t,this.idx=0,this.now=0,this.playing=!1}reset(t){this.engines.forEach(r=>r.reset(t)),this.idx=0,this.now=0}onTick(t){this.onTickCb=t}start(){this.playing=!0}pause(){this.playing=!1}tick(t){if(!this.playing||!this.scenario)return;this.now+=t;const{ops:r}=this.scenario;for(;this.idx<r.length&&r[this.idx].t<=this.now;){const a=r[this.idx++];this.engines.forEach(i=>i.applySourceOp(a))}this.engines.forEach(a=>a.tick(this.now)),this.onTickCb?.(this.now)}}const Ha=new Set(["c","u","d"]);function za(e){switch(e.op){case"insert":return"c";case"update":return"u";case"delete":return"d";default:return null}}function Ka(e){return e.map((t,r)=>{const a=za(t);if(!a)return null;const i=t.pk?.id!=null?String(t.pk.id):"";return{key:`${a}::${i}`,op:a,pk:i,index:r,time:t.t}}).filter(t=>!!t)}function Qa(e){return e.map((t,r)=>{if(!Ha.has(t.op))return null;const a=t.pk?.id!=null?String(t.pk.id):"",i=t.op;return{key:`${i}::${a}`,op:i,pk:a,index:r,time:t.ts_ms}}).filter(t=>!!t)}function Pn(e){const t=new Map;for(const r of e){const a=t.get(r.key);a?a.push(r):t.set(r.key,[r])}return t}function Ja(e,t){const r=[],a=[],i=[],u=Pn(e),h=Pn(t),b=new Set([...u.keys(),...h.keys()]);for(const k of b){const N=u.get(k)??[],S=h.get(k)??[],w=Math.min(N.length,S.length);for(let x=0;x<w;x++){const C=N[x],d=S[x];r.push({expected:C,actual:d,lagMs:Math.max(0,d.time-C.time)})}for(let x=w;x<N.length;x++)a.push(N[x]);for(let x=w;x<S.length;x++)i.push(S[x])}return{matched:r,missing:a,extra:i}}function Ya(e){const t=[],r=[...e].sort((i,u)=>i.actual.index-u.actual.index);let a=-1/0;for(const i of r)i.expected.index<a?t.push({type:"ordering",op:i.expected.op,pk:i.expected.pk,expectedIndex:i.expected.index,actualIndex:i.actual.index,expectedTime:i.expected.time,actualTime:i.actual.time}):a=i.expected.index;return t}function Xa(e){return e.filter(t=>t.lagMs>0).sort((t,r)=>r.lagMs-t.lagMs).slice(0,5).map(t=>({op:t.expected.op,pk:t.expected.pk,expectedTime:t.expected.time,actualTime:t.actual.time,lagMs:t.lagMs}))}function Za(e,t,r){const a=Ka(t),i=Qa(r),{matched:u,missing:h,extra:b}=Ja(a,i),k=[];for(const w of h)k.push({type:"missing",op:w.op,pk:w.pk,expectedIndex:w.index,expectedTime:w.time});for(const w of b)k.push({type:"extra",op:w.op,pk:w.pk,actualIndex:w.index,actualTime:w.time});k.push(...Ya(u));const N=Xa(u),S=N.reduce((w,x)=>Math.max(w,x.lagMs),0);return{method:e,totals:{missing:k.filter(w=>w.type==="missing").length,extra:k.filter(w=>w.type==="extra").length,ordering:k.filter(w=>w.type==="ordering").length},issues:k,lag:{max:S,samples:N}}}const eo=`# Harness Nightly History

Run \`GITHUB_TOKEN=... npm run harness:history\` to refresh this summary. The script aggregates the latest Harness Nightly artifacts and records table-level parity results here so the app can surface them inline.

| Run | Date | Conclusion | Events | Missing | Extra | Max Lag (ms) | Tables | Mismatches |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| _No runs captured yet._ |   |   |   |   |   |   |   |   |

`,to="workspace",so=e=>({...e}),no=e=>!Array.isArray(e)||e.length===0?[{name:"id",type:"string",pk:!0}]:e.filter(t=>t&&typeof t.name=="string").map(t=>{const r={name:t.name,type:"string",pk:!!t.pk},a=t.type;if(typeof a=="string"){const i=a.toLowerCase();i==="number"||i==="bool"||i==="timestamp"?r.type=i:i==="string"&&(r.type="string")}return typeof t.nullable=="boolean"&&(r.nullable=t.nullable),r}),ro=e=>e.type?String(e.type).toLowerCase():"string",ao=e=>{const t=e.find(r=>r.pk);return t?.name?t.name:"id"},Fn=(e,t,r)=>Array.isArray(r)&&r.length>0?r.reduce((a,i)=>(i===t||Object.prototype.hasOwnProperty.call(e,i)&&(a[i]=e[i]),a),{}):Object.entries(e).reduce((a,[i,u])=>(i===t||(a[i]=u),a),{}),Un=(e,t,r,a)=>{const i=ro(e);if(i==="number"){const h=t.seq*10+r;return typeof a=="number"?a+1:h}if(i==="bool"||i==="boolean")return typeof a=="boolean"?!a:r%2===0;if(i==="timestamp")return t.logicalTime+r+1;const u=`${t.seq}_${r}_${t.opCounter}`;return`${e.name}_${u}`},oo=(e,t={})=>{const r=no(e.schema),a=ao(r),i=new Map;(Array.isArray(e.rows)?e.rows:[]).forEach(k=>{if(!k||typeof k!="object")return;const N=k,S=N[a]??N.id;if(S==null)return;const w=String(S),x={};Object.entries(N).forEach(([C,d])=>{if(C===a){x[C]=String(d);return}C==="id"&&a!=="id"||(x[C]=d)}),Object.prototype.hasOwnProperty.call(x,a)||(x[a]=w),i.set(w,x)});const h=Array.isArray(e.ops)?e.ops.reduce((k,N)=>Math.max(k,N?.t??0),0):0;return{table:typeof e.table=="string"&&e.table.trim().length?e.table:t.fallbackTable??to,columns:r,pkField:a,rows:i,logicalTime:h,seq:i.size+1,opCounter:0}},io=(e,t,r)=>{const a=Math.max(1,Math.floor(t)||1),i=Array.from(e.rows.keys()),u=e.columns.filter(S=>S.name!==e.pkField);let h="insert";if(i.length>0&&u.length>0){const S=e.opCounter%6;(S===0||S===4)&&i.length>1?h="delete":S===1||S===2||S===3?h="update":h="insert"}else i.length>1&&u.length===0&&(h=e.opCounter%3===0?"delete":"insert");const b=e.opCounter;e.opCounter+=1;const k=Math.max(e.logicalTime,r);e.logicalTime=k+a;const N=e.logicalTime;if(h==="insert"){const S=`gen-${e.seq++}`,w={[e.pkField]:S};u.forEach((d,g)=>{w[d.name]=Un(d,e,g)}),e.rows.set(S,w);const x=Fn(w,e.pkField);return{op:{t:N,op:"insert",table:e.table,pk:{id:S},after:x},kind:h}}if(h==="update"&&i.length>0&&u.length>0){const S=b%i.length,w=i[S],x=e.rows.get(w);if(!x)return null;const C=u[b%u.length],d=Un(C,e,b,x[C.name]),g=so(x);g[C.name]=d,e.rows.set(w,g);const f=Fn(g,e.pkField,[C.name]);return{op:{t:N,op:"update",table:e.table,pk:{id:w},after:f},kind:h}}if(h==="delete"&&i.length>0){const S=b%i.length,w=i[S];return e.rows.delete(w),{op:{t:N,op:"delete",table:e.table,pk:{id:w}},kind:h}}return null};function V(e,t={},r={}){if(typeof window>"u")return;const a=window.telemetry;!a||typeof a.track!="function"||a.track(e,t,r)}function Lt(e,t={}){V("comparator.clock.control",{action:e,...t})}function lo({onDiffDetailsOpened:e,...t}){const r=a=>{e?.(a),V("comparator.diff.opened",{method:a.method,issues:a.issueCount,maxLag:a.maxLag,scenario:a.scenario})};return n.jsx(va,{...t,onDiffDetailsOpened:r})}function co({preset:e,topicExample:t,methods:r}){return n.jsxs("section",{className:"sim-shell__preset-guidance","aria-label":"Vendor preset guidance and quick tips",children:[n.jsxs("div",{className:"sim-shell__preset-guidance-header",children:[n.jsxs("div",{children:[n.jsx("h3",{className:"sim-shell__subtitle",children:"Pipeline blueprint"}),n.jsx("p",{className:"sim-shell__description sim-shell__description--subtle",children:e.description}),n.jsxs("div",{className:"sim-shell__preset-row sim-shell__preset-row--compact",role:"list","aria-label":"Preset pipeline",children:[n.jsxs("span",{className:"sim-shell__preset-pill","data-tooltip":e.sourceTooltip,role:"listitem",children:["Source · ",e.sourceLabel]}),n.jsx("span",{className:"sim-shell__preset-arrow","aria-hidden":"true",children:"→"}),n.jsxs("span",{className:"sim-shell__preset-pill","data-tooltip":e.logTooltip,role:"listitem",children:["Capture · ",e.logLabel]}),n.jsx("span",{className:"sim-shell__preset-arrow","aria-hidden":"true",children:"→"}),n.jsxs("span",{className:"sim-shell__preset-pill","data-tooltip":e.busTooltip,role:"listitem",children:["Transport · ",e.busLabel]}),n.jsx("span",{className:"sim-shell__preset-arrow","aria-hidden":"true",children:"→"}),n.jsxs("span",{className:"sim-shell__preset-pill","data-tooltip":e.destinationTooltip,role:"listitem",children:["Sink · ",e.destinationLabel]})]})]}),n.jsxs("div",{className:"sim-shell__preset-meta-cards","aria-label":"Preset quick facts",children:[n.jsxs("div",{className:"sim-shell__preset-meta-card",children:[n.jsx("p",{className:"sim-shell__preset-meta-label",children:"Topic example"}),n.jsx("code",{className:"sim-shell__preset-topic","aria-label":"Example transport topic or namespace",children:t})]}),n.jsxs("div",{className:"sim-shell__preset-meta-card",children:[n.jsx("p",{className:"sim-shell__preset-meta-label",children:"Docs"}),e.docsHint?n.jsx("a",{className:"sim-shell__preset-docs",href:e.docsHint,target:"_blank",rel:"noopener noreferrer",children:"Open preset reference"}):n.jsx("span",{className:"sim-shell__preset-meta-placeholder",children:"No reference link provided"})]})]})]}),n.jsx("div",{className:"sim-shell__method-guidance",role:"list","aria-label":"Method-specific guidance",children:r.map(a=>n.jsxs("article",{className:"sim-shell__method-card","data-active":a.active?"true":"false",role:"listitem",children:[n.jsxs("header",{className:"sim-shell__method-card-header",children:[n.jsxs("div",{className:"sim-shell__method-card-titles",children:[n.jsx("p",{className:"sim-shell__method-name",children:a.label}),n.jsx("p",{className:"sim-shell__method-lane",children:a.laneDescription})]}),n.jsx("span",{className:"sim-shell__method-state","aria-live":"polite",children:a.active?"Active":"Off"})]}),n.jsxs("p",{className:"sim-shell__method-card-line",children:[n.jsx("strong",{children:"Use when:"})," ",a.whenToUse]}),n.jsxs("p",{className:"sim-shell__method-card-line sim-shell__method-card-line--callout",role:"note",children:[n.jsx("strong",{children:"Watch for:"})," ",a.callout]})]},a.id))})]})}function uo({guidance:e}){return!e.controls.length&&!e.observations.length?null:n.jsxs("section",{className:"sim-shell__scenario-guidance","aria-label":"Scenario guardrails and teaching tips",children:[n.jsx("header",{className:"sim-shell__scenario-guidance-header",children:n.jsxs("div",{children:[n.jsx("p",{className:"sim-shell__subtitle",children:"Scenario guardrails"}),e.summary?n.jsx("p",{className:"sim-shell__description sim-shell__description--meta",children:e.summary}):null]})}),n.jsxs("div",{className:"sim-shell__scenario-guidance-grid",role:"list",children:[e.controls.length?n.jsxs("article",{className:"sim-shell__scenario-guidance-card",role:"listitem",children:[n.jsx("h4",{children:"Recommended controls"}),n.jsx("ul",{children:e.controls.map(t=>n.jsxs("li",{children:[n.jsxs("strong",{children:[t.title,"."]})," ",t.detail]},t.title))})]}):null,e.observations.length?n.jsxs("article",{className:"sim-shell__scenario-guidance-card",role:"listitem",children:[n.jsx("h4",{children:"What to observe"}),n.jsx("ul",{children:e.observations.map(t=>n.jsxs("li",{children:[n.jsxs("strong",{children:[t.title,"."]})," ",t.detail]},t.title))})]}):null]})]})}function ho(e){const t={...e};return e.pk&&(t.pk={...e.pk}),e.after&&(t.after={...e.after}),e.txn&&(t.txn={...e.txn}),t}function po(e){if(e==null)return e;try{return JSON.parse(JSON.stringify(e))}catch{return e}}function mo(e){return{id:e.id,name:e.name,label:e.label,description:e.description,highlight:e.highlight,stats:{rows:e.rows.length,ops:e.ops.length},table:e.table,tags:[...e.tags],schema:e.schema.length?e.schema.map(t=>({...t})):void 0,rows:e.rows.length?e.rows.map(t=>({...t})):void 0,events:e.events.length?e.events.map(t=>({...t})):void 0,schemaVersion:e.schemaVersion,seed:e.seed,ops:e.ops.map(ho),comparator:e.comparator?po(e.comparator):null}}const nr=Vr;nr.length===0&&typeof console<"u"&&console.warn("No scenario templates were loaded from assets/shared-scenarios.js; the comparator scenario gallery will be empty.");const Jt=nr.map(mo),rr={polling:{label:"Polling (Query)",laneDescription:"Simple, but lossy. Periodic scans read current state only; hard deletes and mid-poll updates can disappear.",callout:"Polling reads current state only. Hard deletes and intermediate updates are not captured.",whenToUse:"Simple, but lossy. Periodic scans read current state only. Hard deletes and intermediate updates between polls are not observable. Good for small, non-critical syncs where some lag and loss is acceptable."},trigger:{label:"Trigger (Audit)",laneDescription:"Complete, but intrusive. Database triggers write to an audit table and add synchronous source overhead.",callout:"Triggers add write overhead to source transactions.",whenToUse:"Complete, but intrusive. Triggers capture every change into an audit table, but add write latency and operational overhead on the source. Use when log access isn’t available."},log:{label:"Log (WAL)",laneDescription:"Default choice. Streams the transaction log post-commit for ordered, low-latency change events.",callout:"Log-based CDC is the preferred default when available.",whenToUse:"Default choice. Reads the database’s transaction log post-commit. Lowest source impact, complete and ordered changes, near-real-time. Requires connector setup and ops discipline."}};typeof window<"u"&&(window.CDC_METHOD_COPY=rr);const Qe="workspace-live",ar="cdc_comparator_prefs_v1",Je={name:"priority_flag",type:"bool"},go=()=>{if(typeof window>"u")return null;try{return window.localStorage}catch{return null}},Hs=(()=>{let e=null,t=null;return()=>{const r=go();return(!e||r!==t)&&(e=Pa(r),t=r),e}})();function fo(e,t,r,a){if(r.length===0)return 0;const i=e[t]?.metrics.writeAmplification;if(typeof i=="number"&&i>=0)return i;const u=a.ops.filter(h=>h.table===r[0]?.table);return u.length?r.length/u.length:r.length}function bo(e){return!Number.isFinite(e)||e<=0?null:{key:"write-amplification",text:`${e.toFixed(1)}x write amplification`,tone:"amplification"}}const mt=["polling","trigger","log"],or=2,Ie=100,ir=10,lr=300,Ws=120,xo=10,cr=10,dr=600,ur=120,Vs=10,Rs=40,yo=5,Yt=32,et=["c","u","d","s"],Bn="MYSQL_DEBEZIUM";function as(e){return typeof e=="string"&&Object.prototype.hasOwnProperty.call(ts,e)}const vo=e=>e?{columns:[...e.columns],rows:e.rows.map(t=>({id:t.id,displayId:t.displayId,table:t.table,values:{...t.values}})),schemaVersion:e.schemaVersion,hasSchemaColumn:e.hasSchemaColumn}:null,me=e=>{if(e==null)return e;try{return JSON.parse(JSON.stringify(e))}catch{return null}},_o=e=>{if(!e)return null;const t=e.methodCopyOverrides?me(e.methodCopyOverrides)??void 0:void 0;return{id:e.id,label:e.label,description:e.description,docsHint:e.docsHint,sourceLabel:e.sourceLabel,sourceTooltip:e.sourceTooltip,logLabel:e.logLabel,logTooltip:e.logTooltip,busLabel:e.busLabel,busTooltip:e.busTooltip,destinationLabel:e.destinationLabel,destinationTooltip:e.destinationTooltip,methodCopyOverrides:t}};function wo(e,t,r,a,i,u,h,b){const k=me(e),N=t?me(t):null,S=me(r)??[],w=h?me(h):null,x=Array.from(a.values()).map(d=>me(d)).filter(d=>!!d),C=b.map(d=>{const g=me(d.metrics);return g?{method:d.method,eventCount:d.events.length,metrics:g}:null}).filter(d=>!!d);return{preferences:k,summary:N,analytics:S,diffs:x,tags:[...i],preset:_o(u),overlay:w,lanes:C}}function qn(e){return e?!!(e.preferences&&Object.keys(e.preferences).length>0)||!!e.summary||(e.analytics?.length??0)>0||(e.diffs?.length??0)>0||(e.tags?.length??0)>0||!!e.preset||(e.overlay?.length??0)>0||(e.lanes?.length??0)>0:!1}const So=rr,Q=Qn,$s=200,Eo=2e3,jo=6;function Co(){if(typeof window>"u")return new Set;const t=window.cdcFeatureFlags?.all?.();if(Array.isArray(t)&&t.length)return new Set(t.map(String));const r=window.APPWRITE_CFG?.featureFlags;return Array.isArray(r)&&r.length?new Set(r.map(String)):new Set}const ko={polling:{pollIntervalMs:500,includeSoftDeletes:!1},trigger:{extractIntervalMs:250,triggerOverheadMs:8},log:{fetchIntervalMs:50}},Lo={polling:"QUERY_BASED",trigger:"TRIGGER_BASED",log:"LOG_BASED"},To={polling:"polling",trigger:"trigger",log:"log"},Wn=e=>{switch(e){case"polling":return Zr();case"trigger":return sa();case"log":default:return Yr()}},Vn=e=>{if(!e)return null;const t={...e};return delete t.__ts,t},Mo=e=>{if(e==null)return"—";if(typeof e=="boolean")return e?"true":"false";if(typeof e=="number")return Number.isFinite(e)?e.toString():"—";if(e instanceof Date)return e.toISOString();if(typeof e=="object")try{return JSON.stringify(e)}catch{return"[object]"}return String(e)},Gs=(e,t,r)=>{const a=t.kind==="INSERT"?"c":t.kind==="UPDATE"?"u":t.kind==="DELETE"?"d":"s",i=t.schemaChange?{action:t.schemaChange.action,column:{name:t.schemaChange.column.name,type:t.schemaChange.column.type,nullable:t.schemaChange.column.nullable},previousVersion:t.schemaChange.previousVersion,nextVersion:t.schemaChange.nextVersion}:null,u=t.after?.id??t.before?.id??i?.column?.name??null,h=u!=null?String(u):"";return{source:"demo-db",table:t.table,op:a,pk:{id:h},before:Vn(t.before),after:Vn(t.after),ts_ms:t.commitTs,tx:{id:t.txnId??`tx-${t.commitTs}`,lsn:typeof t.offset=="number"?t.offset:null,index:typeof t.txnIndex=="number"?t.txnIndex:void 0,total:typeof t.txnTotal=="number"?t.txnTotal:void 0,last:typeof t.txnLast=="boolean"?t.txnLast:typeof t.txnTotal=="number"&&typeof t.txnIndex=="number"?t.txnIndex>=t.txnTotal-1:!0},seq:r,meta:{method:To[e]},schemaChange:i}};function Ao(e,t){const r=new Hr,a=new zr,i=new Kr,u=`cdc.${e}`;let h=Wn(e),b,k={bus:r,metrics:a,scheduler:i,topic:u},N={},S=0;const w=new Set,x=f=>{const v=f.__seq,T=typeof v=="number"&&v>0?v:++S;return f.__seq=T,{...Gs(e,f,T),offset:f.offset,topic:f.topic??u}},C=f=>v=>{const T=f(v);if(T.length){const L=T.map($=>x($));t(L),L.forEach($=>w.forEach(q=>q($)))}return T},d=()=>{h.initialise?.(k),h.configure?.(N),b=new Qr(Lo[e],r,i,a,u,{startSnapshot:(f,v)=>h.startSnapshot?.(f,T=>C(v)(T)),startTailing:f=>h.startTailing?.(v=>C(f)(v)),stop:()=>h.stop?.()}),b.startSnapshot([]),b.startTailing()};return d(),{name:e,configure(f){N={...f},h.configure?.(f)},reset(f){b.stop(),i.clear(),a.reset(),r.reset(u),S=0,h=Wn(e),k={bus:r,metrics:a,scheduler:i,topic:u},d()},applySourceOp(f){h.applySource?.(f)},applySchemaChange(f,v,T,L){const $=v==="add"?"ADD_COLUMN":"DROP_COLUMN";h.applySchemaChange?.(f,$,T,L)},tick(f){h.tick?.(f)},onEvent(f){return w.add(f),()=>w.delete(f)},bus:r,metrics:a,topic:u}}function No(e,t){return Ao(e,t)}function pt(e){return e.reduce((t,r)=>(t[r]=[],t),{})}function Io(e){return{polling:{...e.polling},trigger:{...e.trigger},log:{...e.log}}}function Xt(e,t,r){let a=typeof e=="number"?e:Number(e);return Number.isFinite(a)?(typeof r=="number"&&(a=Math.max(r,a)),a):t}function Zt(e,t=Ws){if(typeof e!="number"||!Number.isFinite(e))return t;const r=Math.round(e);return Number.isFinite(r)?Math.min(lr,Math.max(ir,r)):t}function Ps(e,t=ur){if(typeof e!="number"||!Number.isFinite(e))return t;const r=Math.round(e/Vs)*Vs;return Number.isFinite(r)?Math.min(dr,Math.max(cr,r)):t}function Fs(e,t=mt){const r=[...t];if(!Array.isArray(e))return r;const a=[];t.forEach(u=>{e.includes(u)&&!a.includes(u)&&a.push(u)});const i=Math.min(or,t.length);return a.length>=i?a:r}function Gn(e){const t=Array.from(et);if(!Array.isArray(e)||e.length===0)return new Set(t);const r=[];return e.forEach(a=>{if(et.includes(a)){const i=a;r.includes(i)||r.push(i)}}),r.length?new Set(r):new Set(t)}function es(e,t=mt){return typeof e=="string"&&t.includes(e)}function Hn(e){const t=Io(ko);return e&&(e.polling&&(e.polling.pollIntervalMs!=null&&(t.polling.pollIntervalMs=Xt(e.polling.pollIntervalMs,t.polling.pollIntervalMs,50)),e.polling.includeSoftDeletes!=null&&(t.polling.includeSoftDeletes=!!e.polling.includeSoftDeletes)),e.trigger&&(e.trigger.extractIntervalMs!=null&&(t.trigger.extractIntervalMs=Xt(e.trigger.extractIntervalMs,t.trigger.extractIntervalMs,50)),e.trigger.triggerOverheadMs!=null&&(t.trigger.triggerOverheadMs=Xt(e.trigger.triggerOverheadMs,t.trigger.triggerOverheadMs,0))),e.log&&e.log.fetchIntervalMs!=null&&(t.log.fetchIntervalMs=Xt(e.log.fetchIntervalMs,t.log.fetchIntervalMs,10))),t}function Oo(){if(typeof window>"u")return null;try{const t=Hs().getItem(ar);if(!t)return null;const r=JSON.parse(t);return{scenarioId:typeof r.scenarioId=="string"?r.scenarioId:void 0,presetId:as(r.presetId)?r.presetId:void 0,activeMethods:Array.isArray(r.activeMethods)?r.activeMethods:void 0,methodConfig:r.methodConfig??void 0,userPinnedScenario:typeof r.userPinnedScenario=="boolean"?r.userPinnedScenario:void 0,showEventList:typeof r.showEventList=="boolean"?r.showEventList:void 0,eventOps:Array.isArray(r.eventOps)?r.eventOps:void 0,eventSearch:typeof r.eventSearch=="string"?r.eventSearch:void 0,eventLogTable:typeof r.eventLogTable=="string"?r.eventLogTable:void 0,eventLogTxn:typeof r.eventLogTxn=="string"?r.eventLogTxn:void 0,eventLogMethod:typeof r.eventLogMethod=="string"?r.eventLogMethod:void 0,eventLogOp:typeof r.eventLogOp=="string"?r.eventLogOp:void 0,applyOnCommit:typeof r.applyOnCommit=="boolean"?r.applyOnCommit:void 0,consumerRateEnabled:typeof r.consumerRateEnabled=="boolean"?r.consumerRateEnabled:void 0,consumerRateLimit:typeof r.consumerRateLimit=="number"?r.consumerRateLimit:void 0,generatorEnabled:typeof r.generatorEnabled=="boolean"?r.generatorEnabled:void 0,generatorRate:typeof r.generatorRate=="number"?r.generatorRate:void 0}}catch(e){return console.warn("Comparator prefs load failed",e),null}}function Do(e){if(!(typeof window>"u"))try{Hs().setItem(ar,JSON.stringify(e))}catch(t){console.warn("Comparator prefs save failed",t)}}function Ro(e,t,r,a,i,u){const h=e.length?e[e.length-1]:null,b=h?Math.max(t-h.ts_ms,0):t,k=t>0?e.length/(t/1e3):0;let N=0,S=0,w=0,x=0;e.forEach(L=>{L.op==="c"?N+=1:L.op==="u"?S+=1:L.op==="d"&&(w+=1),L.schemaChange&&(x+=1)});const C=r.ops.filter(L=>L.op==="delete").length,d=u?.deletes??0,g=C+d,f=g===0?100:w/g*100,v=e.every((L,$)=>{if($===0)return!0;const q=e[$-1];return L.ts_ms>=q.ts_ms});return{lagMs:b,throughput:k,deletesPct:f,orderingOk:v,consistent:v&&(a==="polling"?w===g:!0),writeAmplification:a==="trigger"?fo(i,a,e,r)??0:void 0,insertCount:N,updateCount:S,deleteCount:w,schemaChangeCount:x}}function $o(e){if(e.length===0)return null;const t=[...e].sort((w,x)=>w.metrics.lagMs-x.metrics.lagMs),r=t[0],a=t[t.length-1],i=a.metrics.lagMs-r.metrics.lagMs,u=[...e].sort((w,x)=>w.metrics.deletesPct-x.metrics.deletesPct),h=u[0],b=u[u.length-1],k=e.filter(w=>!w.metrics.orderingOk).map(w=>w.method),N=e.filter(w=>w.method==="trigger"&&Se(w.metrics.writeAmplification)),S=N.length?N.reduce((w,x)=>Se(w.metrics.writeAmplification)?Se(x.metrics.writeAmplification)&&x.metrics.writeAmplification>w.metrics.writeAmplification?x:w:x):null;return{bestLag:r,worstLag:a,lagSpread:i,lowestDeletes:h,highestDeletes:b,orderingIssues:k,triggerWriteAmplification:S}}function Po(){const e=c.useRef(null);e.current===null&&(e.current=Oo());const t=e.current||void 0,r=c.useMemo(()=>Hs(),[]),[a,i]=c.useState(()=>Co()),u=a.size===0||a.has("ff_trigger_mode"),h=a.size===0||a.has("ff_schema_demo"),b=a.size===0||a.has("ff_multitable"),k=a.size===0||a.has("ff_metrics"),N=a.size===0||a.has("ff_walkthrough"),S=c.useMemo(()=>u?[...mt]:mt.filter(s=>s!=="trigger"),[u]),w=c.useMemo(()=>Fs(t?.activeMethods,S),[S,t?.activeMethods]),x=Hn(t?.methodConfig),C=t?.presetId&&as(t.presetId)?t.presetId:Bn,d=es(t?.eventLogMethod,S)?t?.eventLogMethod:null,g=typeof t?.eventLogOp=="string"&&t.eventLogOp.trim()?t.eventLogOp.trim().toLowerCase():null,f=c.useMemo(()=>typeof window>"u"?{...os}:ia(r),[r]),[v,T]=c.useState(null),[L,$]=c.useState(()=>t?.scenarioId??Jt[0].name),[q,ie]=c.useState(()=>f.query),[H,gt]=c.useState(()=>f.tags),[M,Oe]=c.useState(()=>w),[De,Re]=c.useState(()=>pt(w)),[$e,tt]=c.useState(()=>pt(w)),[E,J]=c.useState(()=>({})),[X,ft]=c.useState(C),[le,bt]=c.useState(0),[Pe,Ee]=c.useState(!1),[ce,ls]=c.useState(!1),[K,cs]=c.useState(()=>x),[xt,Mt]=c.useState(!1),[xe,yt]=c.useState(()=>t?.eventSearch??""),[zs,ds]=c.useState(()=>Gn(t?.eventOps)),[je,us]=c.useState(t?.showEventList??!0),[de,Fe]=c.useState(t?.eventLogTable??null),[oe,Ue]=c.useState(t?.eventLogTxn??""),[ue,Ce]=c.useState(d),[he,ke]=c.useState(g),[re,At]=c.useState(t?.applyOnCommit??!1),[Z,hs]=c.useState(t?.consumerRateEnabled??!1),[se,ps]=c.useState(()=>Zt(t?.consumerRateLimit,Ws)),[ae,ms]=c.useState(t?.generatorEnabled??!1),[ne,gs]=c.useState(()=>Ps(t?.generatorRate,ur)),Le=c.useRef({}),ge=c.useRef({}),st=c.useRef({}),Nt=c.useRef(t?.consumerRateEnabled??!1?Zt(t?.consumerRateLimit,Ws):null),Be=c.useRef(0),fs=c.useRef(null),vt=c.useRef(0),Ks=c.useRef(ne),Qs=c.useRef(ae),_t=c.useRef({inserts:0,updates:0,deletes:0}),bs=c.useRef({}),Js=c.useRef(M),Ys=c.useRef(le),U=ts[X]??ts[Bn],hr=c.useMemo(()=>Object.values(ts).map(s=>({id:s.id,label:s.label})),[]),I=c.useMemo(()=>{const s=U.methodCopyOverrides??{};return mt.reduce((o,l)=>{const m=So[l],j=s[l];return o[l]={label:j?.label??m.label,laneDescription:j?.laneDescription??m.laneDescription,callout:j?.callout??m.callout,whenToUse:j?.whenToUse??m.whenToUse,tooltip:j?.tooltip??m.tooltip},o},{})},[U]),Xs=c.useMemo(()=>mt.reduce((s,o)=>{const l=I[o];return s[o]={label:l.label,tooltip:l.tooltip},s},{}),[I]),Zs=c.useMemo(()=>new Set(H),[H]),en=c.useMemo(()=>ha(Jt,{liveScenario:v??void 0,additionalTags:[H]}),[v,H]);c.useEffect(()=>{typeof window>"u"||la({query:q,tags:H},r)},[q,H,r]);const Te=c.useCallback((s,o)=>{if(typeof window>"u")return;const l=Us({query:s,tags:o});window.dispatchEvent(new CustomEvent("cdc:scenario-filter",{detail:l}))},[]),It=c.useCallback(s=>{if(!s){Ve.current=!1;return}if("userPinnedScenario"in s&&(Ve.current=!!s.userPinnedScenario),s.activeMethods&&Oe(Fs(s.activeMethods,S)),s.methodConfig&&cs(Hn(s.methodConfig)),s.scenarioId&&$(s.scenarioId),s.presetId&&as(s.presetId)&&ft(s.presetId),"showEventList"in s&&typeof s.showEventList=="boolean"&&us(s.showEventList),"eventOps"in s&&ds(Gn(s.eventOps)),"eventSearch"in s&&typeof s.eventSearch=="string"&&yt(s.eventSearch),"eventLogTable"in s){const o=typeof s.eventLogTable=="string"&&s.eventLogTable.trim().length>0?s.eventLogTable:null;Fe(o)}if("eventLogTxn"in s&&Ue(typeof s.eventLogTxn=="string"?s.eventLogTxn:""),"eventLogMethod"in s){const o=es(s.eventLogMethod,S)?s.eventLogMethod:null;Ce(o)}if("eventLogOp"in s)if(typeof s.eventLogOp=="string"){const o=s.eventLogOp.trim().toLowerCase();ke(o||null)}else ke(null);"applyOnCommit"in s&&typeof s.applyOnCommit=="boolean"&&At(s.applyOnCommit),"consumerRateEnabled"in s&&typeof s.consumerRateEnabled=="boolean"&&hs(s.consumerRateEnabled),"consumerRateLimit"in s&&typeof s.consumerRateLimit=="number"&&ps(Zt(s.consumerRateLimit)),"generatorEnabled"in s&&typeof s.generatorEnabled=="boolean"&&ms(s.generatorEnabled),"generatorRate"in s&&typeof s.generatorRate=="number"&&gs(Ps(s.generatorRate))},[S,Oe,cs,$,ft,us,ds,yt,Fe,Ue,Ce,ke,At,hs,ps,ms,gs]);c.useEffect(()=>{if(typeof window>"u")return;const s=()=>{Te(q,H)};return window.addEventListener("cdc:scenario-filter-request",s),()=>{window.removeEventListener("cdc:scenario-filter-request",s)}},[Te,q,H]);const qe=c.useMemo(()=>Wa(eo),[]),nt=c.useCallback(s=>{let o=st.current[s];return o||(o=new Ds,st.current[s]=o),o},[]),rt=c.useCallback(s=>{fs.current=oo(s),vt.current=0,_t.current={inserts:0,updates:0,deletes:0}},[]),Ot=c.useCallback((s,o)=>{const l=fs.current;if(!l||s<=0)return;const m=Js.current;if(!m.length)return;const j=bs.current;for(let y=0;y<s;y+=1){const _=io(l,o,Ys.current);_&&(m.forEach(A=>{j[A]?.applySourceOp(_.op)}),_.kind==="insert"?_t.current.inserts+=1:_.kind==="update"?_t.current.updates+=1:_.kind==="delete"&&(_t.current.deletes+=1))}},[]),Dt=c.useCallback(s=>{if(!Qs.current||!fs.current)return;const o=Ks.current;if(!Number.isFinite(o)||o<=0)return;vt.current+=o*s/1e3;const l=Math.floor(vt.current);if(l<=0)return;vt.current-=l;const m=l>0?s/l:s;Ot(l,m)},[Ot]),ye=c.useCallback((s,o)=>{const l=Le.current[s];if(!l)return;const m=l.metrics.snapshot(),j=l.bus.size(l.topic);J(y=>({...y,[s]:{metrics:m,backlog:j,lastOffset:o?.lastOffset??y[s]?.lastOffset??-1}}))},[]),tn=c.useCallback((s,o)=>{o.length&&(tt(l=>{const m={...l},j=m[s]??[];return m[s]=[...j,...o],m}),ye(s,{lastOffset:o[o.length-1]?.offset??-1}))},[ye]);c.useEffect(()=>{if(typeof window>"u")return;const s=o=>{if(!(o instanceof CustomEvent))return;const l=o.detail,m=Array.isArray(l)?l:[];i(new Set(m.map(String)))};return window.addEventListener("cdc:feature-flags",s),()=>{window.removeEventListener("cdc:feature-flags",s)}},[]);const Rt=c.useCallback(s=>a.size===0?!0:a.has(s),[a]),at=Rt("ff_event_bus"),wt=Rt("ff_pause_resume"),xs=Rt("ff_query_slider"),ys=Rt("ff_event_log");c.useEffect(()=>{Oe(s=>{const o=Fs(s,S);return o.length===s.length&&o.every((l,m)=>l===s[m])?s:o})},[S]),c.useEffect(()=>{!b&&re&&At(!1)},[re,b]);const Me=c.useMemo(()=>Array.from(zs).sort(),[zs]),sn=c.useMemo(()=>new Set(Me),[Me]),ot=c.useMemo(()=>xe.trim().toLowerCase().split(/\s+/).filter(Boolean),[xe]),nn=c.useMemo(()=>ot.join("|"),[ot]),rn=c.useRef(new WeakMap),$t=c.useCallback(s=>{const o=new Set(Me),l=o.size<et.length,m=ot.length>0,j=rn.current,y=new Map,_=A=>{const D=j.get(A);if(D)return D;const R=[String(A.seq??""),A.op,A.pk?.id??"",A.table??""];A.after&&R.push(...Object.values(A.after).map(P=>String(P??""))),A.before&&R.push(...Object.values(A.before).map(P=>String(P??"")));const F=R.join(" ").toLowerCase();return j.set(A,F),F};return M.forEach(A=>{const D=s[A]??[];if(!l&&!m){y.set(A,D);return}const R=D.filter(F=>{if(!o.has(F.op))return!1;if(!m)return!0;const P=_(F);return ot.every(B=>P.includes(B))});y.set(A,R)}),y},[M,Me,ot]),pr=c.useMemo(()=>$t(De),[$t,De,nn]),an=c.useMemo(()=>$t($e),[$t,$e,nn]),St=c.useMemo(()=>{const s=[],o=new Set,l=new Set,m=new Set;return M.forEach(j=>{(an.get(j)??[]).forEach(_=>{const A=_.table??"";A&&o.add(A);const D=_.tx?.id??null;D&&l.add(D);const R=typeof _.op=="string"?_.op.trim().toLowerCase():"";R&&m.add(R),s.push({method:j,event:_})})}),s.sort((j,y)=>{const _=j.event.offset??j.event.seq??0,A=y.event.offset??y.event.seq??0;return _!==A?_-A:(j.event.ts_ms??0)-(y.event.ts_ms??0)}),{events:s,tables:Array.from(o).sort(),txns:Array.from(l).sort(),ops:Array.from(m)}},[M,an]),vs=St.events,Pt=St.tables,Ft=St.txns,_s=c.useMemo(()=>{const s=new Set(St.ops),o=et.filter(m=>s.has(m)),l=Array.from(s).filter(m=>!et.includes(m));return l.sort(),[...o,...l]},[St.ops]),it=c.useMemo(()=>vs.filter(({method:s,event:o})=>{if(ue&&s!==ue||de&&(o.table??"")!==de||oe&&(o.tx?.id??"")!==oe)return!1;const l=typeof o.op=="string"?o.op.trim().toLowerCase():"";return!(he&&l!==he)}),[vs,ue,he,de,oe]),mr=c.useMemo(()=>it.map(({method:s,event:o},l)=>{const m=typeof o.offset=="number"?o.offset:null,j=typeof o.seq=="number"?o.seq:null,y=typeof o.ts_ms=="number"?o.ts_ms:null,_=[s,m!=null?`offset-${m}`:null,j!=null?`seq-${j}`:null,y!=null?`ts-${y}`:null,l].filter(Boolean),A=o.pk?.id!=null?String(o.pk.id):null,D=o.schemaChange?n.jsxs("span",{className:"sim-shell__event-log-schema",children:[o.schemaChange.action==="ADD_COLUMN"?"Added":"Dropped"," column ",o.schemaChange.column.name,` · v${o.schemaChange.previousVersion}→v${o.schemaChange.nextVersion}`]}):void 0;return{id:_.length?_.join("|"):`${s}-${l}`,methodId:s,methodLabel:I[s].label,op:o.op??"",offset:m,topic:o.topic??null,table:o.table??null,tsMs:y,pk:A,txnId:o.tx?.id??null,before:o.before??null,after:o.after??null,meta:D}}),[it,I]),gr=c.useMemo(()=>({methodId:ue??void 0,op:he??void 0,table:de??void 0,txnId:oe||void 0}),[ue,he,de,oe]),fr=c.useMemo(()=>({methods:S.map(s=>({id:s,label:I[s].label})),ops:_s,tables:Pt,txns:Ft}),[Pt,Ft,S,I]),_e=c.useMemo(()=>{const s=new Map;return M.forEach(o=>{const m=nt(o).snapshot(),j=["table","id"],y=new Set(j);let _=1;m.forEach(R=>{_=Math.max(_,R.schema?.version??1),R.schema?.columns.forEach(F=>{if(!F)return;const P=F.name;!P||P==="id"||P.startsWith("__")||y.has(P)||(y.add(P),j.push(P))})}),m.forEach(R=>{R.rows.forEach(F=>{Object.keys(F).forEach(P=>{P==="id"||P.startsWith("__")||y.has(P)||(y.add(P),j.push(P))})})});const A=m.flatMap(R=>R.rows.map(F=>{const P=String(F.id),B={};return j.forEach(W=>{if(W==="table"||W==="id"||W.startsWith("__"))return;const Y=F[W];B[W]=Y??null}),{id:`${R.name}::${P}`,displayId:P,table:R.name,values:B}})).sort((R,F)=>R.id.localeCompare(F.id,void 0,{numeric:!0,sensitivity:"base"})),D=y.has(Je.name);s.set(o,{columns:j,rows:A,schemaVersion:_,hasSchemaColumn:D})}),s},[M,nt,De]),We=c.useRef(new Map),on=c.useRef(Pe),Ut=c.useRef(0),ws=c.useCallback(s=>{const o=We.current;o.has(s)||o.set(s,[]);const l=o.get(s),m=nt(s).snapshot().reduce((y,_)=>y+_.rows.length,0),j=l[l.length-1];(l.length===0||j!==m)&&(l.push(m),l.length>Yt&&l.splice(0,l.length-Yt))},[nt]);c.useEffect(()=>{const s=We.current,o=new Set(M);for(const l of Array.from(s.keys()))o.has(l)||s.delete(l);M.forEach(l=>{s.has(l)||s.set(l,[]);const j=_e.get(l)?.rows.length??0,y=s.get(l);if(!y)return;const _=y[y.length-1];(y.length===0||_!==j)&&(y.push(j),y.length>Yt&&y.splice(0,y.length-Yt))})},[M,_e]),c.useEffect(()=>{ue&&!M.includes(ue)&&Ce(null)},[M,ue]),c.useEffect(()=>{de&&!Pt.includes(de)&&Fe(null)},[Pt,de]),c.useEffect(()=>{he&&!_s.includes(he)&&ke(null)},[_s,he]),c.useEffect(()=>{oe&&!Ft.includes(oe)&&Ue("")},[Ft,oe]),c.useEffect(()=>{Js.current=M},[M]),c.useEffect(()=>{Ys.current=le},[le]),c.useEffect(()=>{Qs.current=ae,ae||(vt.current=0)},[ae]),c.useEffect(()=>{Ks.current=ne},[ne]);const Ve=c.useRef(t?.userPinnedScenario??!1),Ss=c.useRef(null),we=c.useMemo(()=>ua(Jt,{liveScenario:v??void 0,liveScenarioName:Qe,query:q,tags:H}),[v,q,H]),p=c.useMemo(()=>we.length?we.find(s=>s.name===L)??we[0]:Jt[0],[L,we]),ln=c.useMemo(()=>ma(p.name),[p.name]),Es=c.useMemo(()=>{const s=p.table??p.ops.find(o=>o.table)?.table??"table";try{return U.topicFormat(s)}catch{return s}},[U,p]);c.useEffect(()=>{rt(p)},[p,rt]),c.useEffect(()=>{const s=p.comparator?.preferences;if(!s||typeof s!="object"){Ss.current=null;return}Ss.current!==p.name&&(It(s),Ss.current=p.name)},[It,p]);const Bt=c.useMemo(()=>{const s=new Map;return M.forEach(o=>{const l=_e.get(o);s.set(o,{present:l?.hasSchemaColumn??!1,version:l?.schemaVersion??1})}),s},[M,_e]),Et=c.useMemo(()=>M.length>0?M.every(s=>Bt.get(s)?.present??!1):!1,[M,Bt]),Ge=c.useMemo(()=>{let s=1;return M.forEach(o=>{const l=Bt.get(o);l&&l.version>s&&(s=l.version)}),s},[M,Bt]),lt=c.useMemo(()=>!!p.tags?.includes("schema"),[p.tags]),cn=c.useMemo(()=>{if(!lt)return null;const s=`v${Ge}`;return Et?`${s} · column present`:`${s} · column absent`},[Et,Ge,lt]);c.useEffect(()=>{Ut.current=0},[p.name]);const js=c.useMemo(()=>p.table?p.table:p.ops.find(o=>o.table)?.table??"table",[p.ops,p.table]);c.useMemo(()=>{const s=p.stats??{rows:p.rows?.length??0,ops:p.ops.length},o=S.map(l=>{const m=M.includes(l);if(l==="polling"){const y=K.polling;return{id:l,label:I[l].label,laneDescription:I[l].laneDescription,active:m,configSummary:`${y.pollIntervalMs}ms poll interval${y.includeSoftDeletes?" + soft deletes":""}`,configValues:{poll_interval_ms:y.pollIntervalMs,include_soft_deletes:y.includeSoftDeletes}}}if(l==="trigger"){const y=K.trigger;return{id:l,label:I[l].label,laneDescription:I[l].laneDescription,active:m,configSummary:`${y.extractIntervalMs}ms extract · +${y.triggerOverheadMs}ms overhead`,configValues:{extract_interval_ms:y.extractIntervalMs,trigger_overhead_ms:y.triggerOverheadMs}}}const j=K.log;return{id:l,label:I[l].label,laneDescription:I[l].laneDescription,active:m,configSummary:`${j.fetchIntervalMs}ms fetch cadence`,configValues:{fetch_interval_ms:j.fetchIntervalMs}}});return{scenario:{id:p.id,label:p.label,tags:p.tags??[],stats:s},preset:{id:U.id,label:U.label},featureFlags:Array.from(a).sort(),usesDefaultFlags:a.size===0,applyOnCommit:re,consumerRate:Z?se:null,generatorRate:ae?ne:null,toggles:{eventBus:at,eventLog:ys,pauseResume:wt,querySlider:xs,metrics:k,schemaWalkthrough:h,triggerMethod:u,multiTable:b},methods:o}},[M,re,Z,se,S,at,ys,a,ae,ne,K.log,K.polling,K.trigger,I,k,b,wt,U.id,U.label,xs,p.id,p.label,p.ops.length,p.rows?.length,p.stats,p.tags,h,u]),c.useEffect(()=>{if(!xt)return;const s=window.setTimeout(()=>Mt(!1),2e3);return()=>window.clearTimeout(s)},[xt]),c.useEffect(()=>{if(typeof window>"u")return;const s=window.setTimeout(()=>{V("comparator.event.search",{scenario:p.name,query:xe,hasQuery:!!xe.trim()})},400);return()=>window.clearTimeout(s)},[xe,p.name]),c.useEffect(()=>{on.current=Pe},[Pe]),c.useEffect(()=>{we.length&&(we.some(s=>s.name===L)||(Ve.current=!1,$(we[0].name)))},[L,we]),c.useEffect(()=>{if(!xt)return;const s=window.setTimeout(()=>Mt(!1),2e3);return()=>window.clearTimeout(s)},[xt]),c.useEffect(()=>{if(typeof window>"u")return;const s=o=>{if(!(o instanceof CustomEvent))return;const l=Us(o.detail);ie(m=>m===l.query?m:l.query),gt(m=>ra(m,l.tags)?m:l.tags)};return window.addEventListener("cdc:scenario-filter",s),window.dispatchEvent(new CustomEvent("cdc:scenario-filter-request")),()=>{window.removeEventListener("cdc:scenario-filter",s)}},[]),c.useEffect(()=>{if(typeof window>"u")return;const s=o=>{if(!(o instanceof CustomEvent))return;const l=o.detail;if(!l||!l.scenario){T(null);return}const m=Array.isArray(l.scenario.ops)?l.scenario.ops:[],j=l.scenario.label??"Workspace (live)",y=l.scenario.description??`${m.length} operations`,_=l.scenario.seed??1;T({name:Qe,label:j,description:y,seed:_,ops:m})};return window.addEventListener("cdc:workspace-update",s),window.dispatchEvent(new CustomEvent("cdc:workspace-request")),()=>{window.removeEventListener("cdc:workspace-update",s)}},[]),c.useEffect(()=>{v&&v.ops.length&&(Ve.current||$(Qe))},[v]),c.useEffect(()=>{if(typeof window>"u")return;const s=o=>{if(!(o instanceof CustomEvent))return;const l=o.detail;It(l)};return window.addEventListener("cdc:comparator-preferences-set",s),()=>{window.removeEventListener("cdc:comparator-preferences-set",s)}},[It]),c.useEffect(()=>{Do({scenarioId:L,presetId:X,activeMethods:M,methodConfig:K,userPinnedScenario:Ve.current,showEventList:je,eventOps:Me,eventSearch:xe,eventLogTable:de,eventLogTxn:oe,eventLogMethod:ue,eventLogOp:he,applyOnCommit:re,consumerRateEnabled:Z,consumerRateLimit:se,generatorEnabled:ae,generatorRate:ne})},[L,X,M,K,je,Me,xe,de,oe,ue,he,re,Z,se,ae,ne]);const He=c.useRef(null),qt=c.useRef(null),fe=c.useCallback(()=>{qt.current!=null&&(window.clearInterval(qt.current),qt.current=null)},[]),ct=c.useCallback(()=>{if(ce)return;const s={},o=Nt.current;if(o!=null){const _=o*Ie/1e3,A=Be.current+_;Be.current=Math.min(A,o*5)}let l=o==null?Number.POSITIVE_INFINITY:Be.current;const m=_=>_.txnId??`tx-${_.commitTs}`,j=_=>{if(!_.length)return!1;const A=_[_.length-1];return typeof A.txnLast=="boolean"?A.txnLast:typeof A.txnIndex=="number"&&typeof A.txnTotal=="number"?A.txnIndex>=A.txnTotal-1:!0},y=(_,A)=>{const D=ge.current[_]??[];let R=D.length?[...D]:[];if(R.length&&(ge.current[_]=[]),!R.length){const P=A.bus.consume(A.topic,1);if(!P.length)return[];R=P}const F=m(R[0]);for(;!j(R);){const P=A.bus.consume(A.topic,1);if(!P.length)return ge.current[_]=R,[];const B=P[0];if(m(B)!==F){const Y=ge.current[_]??[];ge.current[_]=[B,...Y];break}R.push(B)}return R};for(const _ of M){const A=Le.current[_];if(!A)continue;let D=[],R=0;if(re){const B=y(_,A);if(!B.length)continue;if(o!=null&&B.length>l){ge.current[_]=B;continue}D=B,R=B.length}else{const B=ge.current[_]??[];if(B.length){if(o!=null&&B.length>l){ge.current[_]=B;continue}D=[...B],R+=B.length,ge.current[_]=[]}const W=o==null?Number.POSITIVE_INFINITY:l-R;if(o==null?!0:W>=1){const te=o==null?50:Math.min(Math.floor(W),50),z=o==null?50:Math.max(te,0);if(z>0){const ve=A.bus.consume(A.topic,z);ve.length&&(D=D.length?D.concat(ve):ve,R+=ve.length)}}if(!D.length)continue}o!=null&&(l=Math.max(l-R,0));const F=nt(_),P=[];re?(F.applyEvents(D),A.metrics.onConsumed(D),ws(_),D.forEach(B=>{const W=B.__seq??0;P.push(Gs(_,B,W))})):D.forEach(B=>{F.applyEvents([B]),A.metrics.onConsumed([B]),ws(_);const W=B.__seq??0;P.push(Gs(_,B,W))}),ye(_),s[_]=P}o!=null&&(Be.current=l),Object.keys(s).length!==0&&Re(_=>{const A={..._};for(const[D,R]of Object.entries(s)){const F=A[D]??[];A[D]=[...F,...R]}return A})},[M,re,nt,ce,ws,ye]),dn=c.useCallback(()=>{fe(),qt.current=window.setInterval(()=>{He.current?.tick(Ie),Dt(Ie),ct()},Ie)},[fe,ct,Dt]);c.useEffect(()=>{const s=Z?se:null;Nt.current=s,s==null&&(Be.current=0)},[Z,se]),c.useEffect(()=>{ce||ct()},[ce,ct]),c.useEffect(()=>{Re(pt(M)),tt(pt(M)),Le.current={},ge.current={},st.current={},M.forEach(y=>{st.current[y]=new Ds}),We.current=new Map,M.forEach(y=>{We.current.set(y,[])}),bt(0),Ee(!1),fe(),rt(p);const s=new Ga,o=[],l={},m={},j=M.map(y=>{const _=No(y,R=>tn(y,R));if(m[y]=_,y==="polling"){const R=K.polling;_.configure({poll_interval_ms:R.pollIntervalMs,include_soft_deletes:R.includeSoftDeletes})}else if(y==="trigger"){const R=K.trigger;_.configure({extract_interval_ms:R.extractIntervalMs,trigger_overhead_ms:R.triggerOverheadMs})}else{const R=K.log;_.configure({fetch_interval_ms:R.fetchIntervalMs})}const A={bus:_.bus,metrics:_.metrics,topic:_.topic,applySchemaChange:_.applySchemaChange};l[y]=A;const D=_.onEvent(R=>{Re(F=>{const P={...F},B=P[y]??[];return P[y]=[...B,R],P})});return o.push(D),_});return Le.current=l,bs.current=m,M.forEach(y=>ye(y,{lastOffset:-1})),s.attach(j),s.load(p),s.reset(p.seed),s.onTick(y=>bt(y)),He.current=s,()=>{s.pause(),fe(),o.forEach(y=>y()),bs.current={}}},[M,p,fe,K,ye,tn,rt]);const br=c.useCallback(s=>{Oe(o=>{const l=Math.min(or,S.length);if(o.includes(s))return o.length<=l?o:o.filter(j=>j!==s);if(!S.includes(s))return o;const m=[...o,s];return S.filter(j=>m.includes(j))})},[S]),xr=c.useCallback(s=>{ds(o=>{const l=new Set(o);let m=!1;return l.has(s)?l.size>1&&(l.delete(s),m=!0):(l.add(s),m=!0),m&&V("comparator.event.filter",{scenario:p.name,op:s,active:l.has(s)}),m?l:o})},[p.name]),yr=c.useCallback(s=>{yt(s)},[]),vr=c.useCallback(()=>{us(s=>{const o=!s;return V("comparator.panel.layout",{scenario:p.name,showEvents:o}),o})},[p.name]),_r=c.useCallback(()=>{hs(s=>{const o=!s;return V("comparator.consumer.rate_toggle",{scenario:p.name,enabled:o}),Nt.current=o?se:null,o||(Be.current=0),o}),Z&&V("comparator.consumer.rate_reset",{scenario:p.name})},[Z,se,p.name]),wr=c.useCallback(s=>{const o=Zt(s,se);o!==se&&(ps(o),Z&&(Nt.current=o),V("comparator.consumer.rate_adjust",{scenario:p.name,rate:o}))},[Z,se,p.name]),Sr=c.useCallback(()=>{ms(s=>{const o=!s;return V("comparator.generator.toggle",{scenario:p.name,enabled:o}),o})},[p.name]),Er=c.useCallback(s=>{const o=Ps(s,ne);o!==ne&&(gs(o),V("comparator.generator.rate_adjust",{scenario:p.name,rate:o}))},[ne,p.name]),jr=c.useCallback(()=>{Ot(Rs,yo),V("comparator.generator.burst",{scenario:p.name,count:Rs})},[Ot,p.name]),Cr=c.useCallback(s=>{s.methodId&&es(s.methodId)?Ce(s.methodId):Ce(null),Fe(s.table??null),Ue(s.txnId??""),ke(s.op?s.op.toLowerCase():null)},[Ce,ke,Fe,Ue]),kr=c.useCallback(()=>{if(it.length===0)return;const s=Ma(it);if(!s)return;const o=new Blob([s],{type:"application/x-ndjson"}),l=URL.createObjectURL(o),m=document.createElement("a");m.href=l,m.download=`${p.name}-event-log.ndjson`,m.click(),URL.revokeObjectURL(l),V("comparator.event.download",{scenario:p.name,events:it.length})},[it,p.name]),Lr=c.useCallback(s=>{const o=st.current[s];if(!o)return;const l=o.snapshot(),m=(p.name||"scenario").replace(/[^a-z0-9-_]+/gi,"-"),j={scenario:p.name,method:s,tables:l},y=new Blob([JSON.stringify(j,null,2)],{type:"application/json"}),_=URL.createObjectURL(y),A=document.createElement("a");A.href=_,A.download=`${m}-${s}-destination.json`,A.click(),URL.revokeObjectURL(_);const D=l.reduce((R,F)=>R+(F.rows?.length??0),0);V("comparator.destination.download",{scenario:p.name,method:s,tables:l.length,rows:D})},[p.name]),Tr=c.useCallback(()=>{tt(s=>{const o={...s};return M.forEach(l=>{o[l]=[]}),o}),rn.current=new WeakMap,V("comparator.event.clear",{scenario:p.name})},[M,p.name]),Mr=c.useCallback(s=>{const o=JSON.stringify({method:s.methodId??null,methodLabel:s.methodLabel??null,op:s.op,offset:s.offset??null,topic:s.topic??null,table:s.table??null,ts_ms:s.tsMs??null,pk:s.pk??null,txnId:s.txnId??null,before:s.before??null,after:s.after??null},null,2);navigator.clipboard.writeText(o).then(()=>V("comparator.event.copy",{scenario:p.name,method:s.methodId??null,op:s.op,offset:s.offset??null})).catch(()=>{V("comparator.event.copy.error",{scenario:p.name,method:s.methodId??null})})},[p.name]),Ar=c.useCallback(s=>{if(typeof window>"u")return;const o=typeof s.op=="string"?s.op.trim().toLowerCase():"";if(o!=="c"&&o!=="u"&&o!=="d")return;const l={op:o,before:s.before??null,after:s.after??null,ts_ms:typeof s.tsMs=="number"?s.tsMs:void 0,table:s.table??void 0,key:s.pk?{id:s.pk}:void 0};window.dispatchEvent(new CustomEvent("cdc:workspace-replay-event",{detail:l})),V("comparator.event.replay",{scenario:p.name,method:s.methodId??null,table:s.table??null,op:o})},[p.name]),Nr=c.useCallback(s=>{as(s)&&(ft(s),V("comparator.preset.select",{presetId:s}))},[]),Ir=c.useCallback(s=>{ie(s),Te(s,H),V("comparator.scenario.filter",{query:s})},[Te,H]),Or=c.useCallback(s=>{const o=H.includes(s),l=o?H.filter(m=>m!==s):[...H,s];gt(l),Te(q,l),V("comparator.scenario.tag_toggle",{tag:s,active:!o})},[Te,q,H]),Dr=c.useCallback(()=>{H.length&&(gt([]),Te(q,[]),V("comparator.scenario.tag_clear"))},[Te,q,H]),Rr=c.useCallback(s=>{Ve.current=!0,$(s),V("comparator.scenario.select",{scenario:s})},[]),$r=c.useCallback(s=>{V("comparator.scenario.preview",{scenario:s.name,tags:s.tags??[]}),window.dispatchEvent(new CustomEvent("cdc:preview-scenario",{detail:s}))},[]),ee=c.useMemo(()=>M.map(s=>{const o=De[s]??[];return{method:s,events:o,metrics:Ro(o,le,p,s,E,_t.current)}}),[M,le,De,p,E]),Wt=c.useMemo(()=>ee.some(s=>s.events.length>0),[ee]),jt=c.useMemo(()=>{const s=p.comparator;if(!s||!s.summary)return null;const o=s.summary?me(s.summary)??s.summary:null;if(!o)return null;const l=Va(o,Xs),m=me(s.analytics)??[],j=me(s.diffs)??[],y=me(s.overlay)??[],_=s.preset?me(s.preset)??s.preset:null,A=s.tags.length?[...s.tags]:Array.isArray(p.tags)?[...p.tags]:[],D=m.reduce((W,Y)=>{const te=Number(Y.total);return Number.isFinite(te)?W+te:W},0),R=Array.isArray(s.lanes)?s.lanes.reduce((W,Y)=>{const te=Number(Y.eventCount);return Number.isFinite(te)?W+te:W},0):0,F=typeof p.stats?.ops=="number"&&Number.isFinite(p.stats.ops)?p.stats.ops:p.ops.length,P=D||R||F;if(!(P>0))return null;const B=Array.isArray(s.lanes)?s.lanes.map(W=>{const Y=typeof W.method=="string"?W.method:void 0;if(!Y||!es(Y))return null;const te=W.metrics&&typeof W.metrics=="object"&&!Array.isArray(W.metrics)?W.metrics:{},z=(...Ne)=>{for(const Ht of Ne){const kt=te[Ht];if(typeof kt=="number"&&Number.isFinite(kt))return kt}},ve=I[Y];return{id:Y,label:ve?.label??Y,tooltip:ve?.tooltip,produced:z("produced")??0,consumed:z("consumed")??0,backlog:z("backlog")??0,lagP50:z("lagMsP50","lagP50")??0,lagP95:z("lagMsP95","lagP95")??0,missedDeletes:z("missedDeletes"),writeAmplification:z("writeAmplification"),snapshotRows:z("snapshotRows"),inserts:z("insertCount","inserts")??0,updates:z("updateCount","updates")??0,deletes:z("deleteCount","deletes")??0,schemaChanges:z("schemaChangeCount","schemaChanges")??0}}).filter(W=>!!W):[];return{scenarioName:p.name,scenarioLabel:p.label,scenarioDescription:p.description,isLive:p.name===Qe,totalEvents:P,summary:l,lanes:B,analytics:m,tags:A,preset:_,diffs:j,overlay:y}},[I,Xs,p]),be=c.useMemo(()=>M.reduce((s,o)=>{const l=E[o],m=l?.metrics,j={backlog:l?.backlog??0,lastOffset:l?.lastOffset??-1,produced:m?.produced??0,consumed:m?.consumed??0,lagMsP50:m?.lagMsP50??0,lagMsP95:m?.lagMsP95??0,missedDeletes:m?.missedDeletes??0,writeAmplification:m?.writeAmplification??0,snapshotRows:m?.snapshotRows??0,errors:m?.errors??0};return s.set(o,j),s},new Map),[M,E]);c.useEffect(()=>{typeof window>"u"||jt&&(Wt||window.dispatchEvent(new CustomEvent("cdc:comparator-summary",{detail:jt})))},[Wt,jt]);const Cs=c.useMemo(()=>M.reduce((s,o)=>s+(be.get(o)?.backlog??0),0),[M,be]),Pr=c.useMemo(()=>at?M.reduce((s,o)=>{const l=be.get(o);return l&&(s.produced+=l.produced,s.consumed+=l.consumed,s.backlog+=l.backlog,s.snapshotRows+=l.snapshotRows),s},{produced:0,consumed:0,backlog:0,snapshotRows:0}):{produced:0,consumed:0,backlog:0,snapshotRows:0},[M,be,at]),O=$o(ee),un=c.useMemo(()=>ee.reduce((s,o)=>s+o.events.length,0),[ee]),dt=c.useMemo(()=>ee.map(({method:s,events:o,metrics:l})=>({method:s,label:I[s].label,total:o.length,inserts:l.insertCount,updates:l.updateCount,deletes:l.deleteCount,schemaChanges:l.schemaChangeCount})),[ee,I]),hn=c.useMemo(()=>dt.reduce((s,o)=>s.set(o.method,o),new Map),[dt]),Ae=c.useMemo(()=>{const s=new Map;return ee.forEach(({method:o,events:l})=>{s.set(o,Za(o,p.ops,l))}),s},[ee,p.ops]),pn=c.useMemo(()=>k?M.map(s=>{const o=be.get(s),l=hn.get(s);return{id:s,label:I[s].label,tooltip:I[s].tooltip,produced:o?.produced??0,consumed:o?.consumed??0,backlog:o?.backlog??0,lagP50:o?.lagMsP50??0,lagP95:o?.lagMsP95??0,missedDeletes:o?.missedDeletes,writeAmplification:o?.writeAmplification,snapshotRows:o?.snapshotRows,inserts:l?.inserts??0,updates:l?.updates??0,deletes:l?.deletes??0,schemaChanges:l?.schemaChanges??0}}):[],[M,hn,be,k,I]),Ct=c.useMemo(()=>M.map(s=>{const o=be.get(s),l=I[s].label,m=o?.snapshotRows??0;return`${l} ${m}`}).join(", "),[M,be,I]),Vt=c.useMemo(()=>M.map(s=>{const o=Ae.get(s),l=I[s].label,m=o?.totals??{missing:0,extra:0,ordering:0},j=o?.lag?.max??0,y=[];if(m.missing>0&&y.push({key:"missing",text:`${m.missing} missing`,tone:"missing"}),m.extra>0&&y.push({key:"extra",text:`${m.extra} extra`,tone:"extra"}),m.ordering>0&&y.push({key:"ordering",text:`${m.ordering} ordering`,tone:"ordering"}),j>0&&y.push({key:"lag",text:`${Math.round(j)}ms lag`,tone:"lag"}),s==="trigger"){const A=be.get(s)?.writeAmplification??0,D=bo(A);D&&y.push(D)}if(lt){const A=_e.get(s),D=A?.schemaVersion??1;A&&!A.hasSchemaColumn?y.push({key:"schema-missing",text:`${Je.name} missing`,tone:"schema"}):D<Ge&&y.push({key:"schema-behind",text:`Schema v${D}/${Ge}`,tone:"schema"})}y.length===0&&y.push({key:"ok",text:"Aligned",tone:"ok"});const _=!!o?.issues.length||(o?.lag?.samples?.length??0)>0||(o?.lag?.max??0)>0;return{method:s,label:l,chips:y,hasDetails:_}}),[M,_e,Ae,be,I,Ge,lt]),mn=Ve.current,Gt=c.useMemo(()=>{const s={scenarioId:L,presetId:X,activeMethods:[...M],methodConfig:K,userPinnedScenario:mn,showEventList:je,eventOps:Me,eventSearch:xe,eventLogTable:de,eventLogTxn:oe,eventLogMethod:ue,eventLogOp:he,applyOnCommit:re,consumerRateEnabled:Z,consumerRateLimit:se,generatorEnabled:ae,generatorRate:ne};return wo(s,O??null,dt,Ae,Array.isArray(p.tags)?p.tags:[],U,Vt,ee)},[M,dt,re,Z,se,ue,he,de,oe,Me,xe,ae,ne,Ae,ee,Vt,K,U,X,p,L,je,O,mn]),Fr=c.useCallback(s=>{const o=new Date().toISOString(),l=qn(Gt)?Gt:s.comparator??Gt,m={id:s.id,name:s.name,label:s.label,description:s.description,highlight:s.highlight,tags:s.tags,table:s.table,schemaVersion:s.schemaVersion,seed:s.seed,schema:s.schema??[],rows:s.rows??[],events:s.events??[],ops:s.ops,version:2,exportedAt:o,comparator:l},j=new Blob([JSON.stringify(m,null,2)],{type:"application/json"}),y=document.createElement("a");y.href=URL.createObjectURL(j),y.download=`${s.name}.json`,y.click(),URL.revokeObjectURL(y.href);const _=Array.isArray(s.rows)?s.rows.length:0,A=Array.isArray(s.events)?s.events.length:0;V("workspace.scenario.exported",{scenario:s.name,rows:_,events:A,hasComparator:qn(l),methods:M})},[M,Gt,V]);c.useEffect(()=>{typeof window>"u"||window.dispatchEvent(new CustomEvent("cdc:consumer-paused",{detail:{paused:ce,backlog:Cs}}))},[ce,Cs]);const Ur=c.useCallback(()=>{if(!O)return;const s=[];if(s.push(`${p.label}: ${p.description}`),s.push(`Methods: ${M.map(o=>I[o].label).join(", ")}`),O.bestLag&&s.push(`Fastest ${I[O.bestLag.method].label} at ${Math.round(O.bestLag.metrics.lagMs)}ms`),O.lagSpread>0&&s.push(`${I[O.worstLag.method].label} trails by ${Math.round(O.lagSpread)}ms`),s.push(`Lowest delete capture: ${I[O.lowestDeletes.method].label} (${Math.round(O.lowestDeletes.metrics.deletesPct)}%)`),O.triggerWriteAmplification&&Se(O.triggerWriteAmplification.metrics.writeAmplification)){const o=Xe(O.triggerWriteAmplification.metrics.writeAmplification);s.push(`Trigger write amplification: ${I[O.triggerWriteAmplification.method].label} ${o}`)}Ct&&s.push(`Snapshot rows: ${Ct}`),s.push(`Ordering: ${O.orderingIssues.length?O.orderingIssues.map(o=>I[o].label).join(", "):"All lanes aligned"}`),p.tags?.length&&s.push(`Tags: ${p.tags.join(", ")}`),navigator.clipboard.writeText(s.join(`
`)).then(()=>Mt(!0)).catch(()=>Mt(!1)),V("comparator.summary.copied",{scenario:p.name,tags:p.tags??[],methods:M})},[O,p,M,I,Ct]),Br=c.useCallback(s=>{V("comparator.overlay.inspect",{method:s,scenario:p.name});const o=document.getElementById(`lane-diff-${s}`);o instanceof HTMLDetailsElement?(o.open=!0,o.scrollIntoView({behavior:"smooth",block:"center"})):o&&o.scrollIntoView({behavior:"smooth",block:"center"})},[p.name]),ks=c.useCallback(s=>{if(!h||!p.tags?.includes("schema"))return;const o=Math.max(le,Ut.current+Ie);Ut.current=o,M.forEach(l=>{Le.current[l]?.applySchemaChange?.(js,s,Je,o),ye(l)}),V("comparator.schema.change",{action:s,table:js,scenario:p.name,commitTs:o,methods:M})},[M,le,Le,h,js,p.name,p.tags,ye]),qr=c.useMemo(()=>{if(!h||!p.tags?.includes("schema"))return;const s=M[0];if(s)return o=>o!==s?null:n.jsx(Ca,{columnName:Je.name,onAdd:()=>ks("add"),onDrop:()=>ks("drop"),disableAdd:Et,disableDrop:!Et,status:cn})},[M,ks,Et,h,cn,p.tags]),ut=c.useCallback((s,o,l)=>{cs(m=>({...m,[s]:{...m[s],[o]:l}}))},[]),ht=c.useCallback(s=>{const o=He.current;if(o){rt(p),o.reset(p.seed),Re(pt(M)),tt(pt(M)),ge.current={},We.current.forEach(l=>l.splice(0));for(const l of M){st.current[l]=new Ds;const m=Le.current[l];m&&(m.bus.reset(m.topic),m.metrics.reset(),ye(l,{lastOffset:-1}))}bt(0),Be.current=0,Ut.current=0,s?.keepLoop||(o.pause(),Ee(!1),fe())}},[M,rt,p,p.seed,fe,ye]),Ls=c.useCallback(()=>{const s=He.current;s&&(ht({keepLoop:!0}),s.start(),Ee(!0),dn(),Lt("play",{scenario:p.name}))},[ht,dn,p.name]),Ts=c.useCallback(()=>{He.current?.pause(),Ee(!1),fe(),Lt("pause",{scenario:p.name})},[fe,p.name]),Wr=c.useCallback(()=>{wt&&ls(s=>{const o=!s;return V("comparator.consumer.toggle",{scenario:p.name,paused:o}),o||ct(),o})},[ct,wt,p.name]),Ms=c.useCallback((s=Ie)=>{const o=He.current;if(!o)return;const l=on.current;l||o.start(),o.tick(s),Dt(s),l||o.pause(),Lt("step",{deltaMs:s,scenario:p.name})},[Dt,p.name]),gn=c.useCallback((s,o)=>{const l=He.current;if(!l)return;const m=Math.max(10,o??Ie);ht({keepLoop:!1});const j=Math.max(s,0);l.start();let y=0,_=0;for(;y<j&&_<1e4;){const A=Math.min(m,j-y);l.tick(A),y+=A,_+=1}l.pause(),Ee(!1),Lt("seek",{targetMs:s,stepMs:o,scenario:p.name})},[ht,p.name]),As=c.useCallback(()=>{yt(""),Ce(null),Fe(null),ke(null),Ue(""),ht(),Lt("reset",{scenario:p.name})},[ht,p.name,Ce,ke,Fe,Ue,yt]);return c.useEffect(()=>{if(typeof window>"u")return;const s={play:()=>Ls(),pause:()=>Ts(),step:l=>Ms(l),seek:(l,m)=>gn(l,m),reset:()=>As()};window.cdcComparatorClock=s;const o=l=>{if(!(l instanceof CustomEvent))return;const m=l.detail;if(m)switch(m.type){case"play":s.play();break;case"pause":s.pause();break;case"step":s.step(m.deltaMs);break;case"seek":s.seek(m.timeMs,m.stepMs);break;case"reset":s.reset();break}};return window.addEventListener("cdc:comparator-clock",o),()=>{window.removeEventListener("cdc:comparator-clock",o),window.cdcComparatorClock===s&&delete window.cdcComparatorClock}},[Ts,As,gn,Ls,Ms]),c.useEffect(()=>{if(typeof window>"u")return;const s={getLaneSnapshot:o=>vo(_e.get(o)),getLaneHistory:o=>[...We.current.get(o)??[]],resetHistory:()=>{We.current.forEach(o=>o.splice(0))}};return window.cdcComparatorDebug=s,()=>{window.cdcComparatorDebug===s&&delete window.cdcComparatorDebug}},[_e,M]),c.useEffect(()=>{typeof window>"u"||window.dispatchEvent(new CustomEvent("cdc:comparator-clock-tick",{detail:{clock:le}}))},[le]),c.useEffect(()=>()=>fe(),[fe]),c.useEffect(()=>{if(typeof window>"u"||!Wt&&jt)return;const s=O?{lagSpread:O.lagSpread,bestLag:{method:O.bestLag.method,label:I[O.bestLag.method].label,metrics:O.bestLag.metrics},worstLag:{method:O.worstLag.method,label:I[O.worstLag.method].label,metrics:O.worstLag.metrics},lowestDeletes:{method:O.lowestDeletes.method,label:I[O.lowestDeletes.method].label,metrics:O.lowestDeletes.metrics},highestDeletes:{method:O.highestDeletes.method,label:I[O.highestDeletes.method].label,metrics:O.highestDeletes.metrics},orderingIssues:O.orderingIssues.map(y=>({method:y,label:I[y].label})),triggerWriteAmplification:O.triggerWriteAmplification&&Se(O.triggerWriteAmplification.metrics.writeAmplification)?{method:O.triggerWriteAmplification.method,label:I[O.triggerWriteAmplification.method].label,value:O.triggerWriteAmplification.metrics.writeAmplification??0}:null}:null,o=ee.map(({method:y,metrics:_})=>({method:y,label:I[y].label,tooltip:I[y].tooltip,metrics:_})),l={id:U.id,label:U.label,description:U.description,docsHint:U.docsHint,source:{label:U.sourceLabel,tooltip:U.sourceTooltip},log:{label:U.logLabel,tooltip:U.logTooltip},bus:{label:U.busLabel,tooltip:U.busTooltip,exampleTopic:Es},destination:{label:U.destinationLabel,tooltip:U.destinationTooltip},methods:S.map(y=>({id:y,label:I[y].label,tooltip:I[y].tooltip??null}))},m=ee.map(({method:y})=>{const _=Ae.get(y);return _?{method:y,totals:_.totals,issues:_.issues.slice(0,25),lag:_.lag}:{method:y,totals:{missing:0,extra:0,ordering:0},issues:[],lag:{max:0,samples:[]}}}),j=M.map(y=>{const _=Ae.get(y);return _?{method:y,label:I[y].label,totals:_.totals,issues:_.issues.slice(0,10),lag:{max:_.lag.max,samples:_.lag.samples.slice(0,10)}}:{method:y,label:I[y].label,totals:{missing:0,extra:0,ordering:0},issues:[],lag:{max:0,samples:[]}}});window.dispatchEvent(new CustomEvent("cdc:comparator-summary",{detail:{scenarioName:p.name,scenarioLabel:p.label,scenarioDescription:p.description,isLive:p.name===Qe,totalEvents:un,summary:s,lanes:o,analytics:dt,tags:H,preset:l,diffs:m,overlay:j}}))},[M,dt,Wt,Ae,ee,I,U,p,Es,jt,H,O,un]),n.jsxs("section",{className:"sim-shell","aria-label":"Simulator preview",children:[n.jsxs("header",{className:"sim-shell__header",children:[n.jsxs("div",{children:[n.jsx("h2",{className:"sim-shell__title",children:"CDC Method Comparator"}),n.jsx("p",{className:"sim-shell__description",children:U.description}),n.jsxs("div",{className:"sim-shell__preset-row",role:"list","aria-label":"Selected vendor pipeline",children:[n.jsxs("span",{className:"sim-shell__preset-pill","data-tooltip":U.sourceTooltip,role:"listitem",children:["Source · ",U.sourceLabel]}),n.jsx("span",{className:"sim-shell__preset-arrow","aria-hidden":"true",children:"→"}),n.jsxs("span",{className:"sim-shell__preset-pill","data-tooltip":U.logTooltip,role:"listitem",children:["Capture · ",U.logLabel]}),n.jsx("span",{className:"sim-shell__preset-arrow","aria-hidden":"true",children:"→"}),n.jsxs("span",{className:"sim-shell__preset-pill","data-tooltip":U.busTooltip,role:"listitem",children:["Transport · ",U.busLabel]}),n.jsx("span",{className:"sim-shell__preset-arrow","aria-hidden":"true",children:"→"}),n.jsxs("span",{className:"sim-shell__preset-pill","data-tooltip":U.destinationTooltip,role:"listitem",children:["Sink · ",U.destinationLabel]})]}),n.jsxs("p",{className:"sim-shell__description sim-shell__description--meta",children:[U.label,U.docsHint?n.jsxs(n.Fragment,{children:[" · ",n.jsx("a",{href:U.docsHint,target:"_blank",rel:"noopener noreferrer",children:"Reference"})]}):null]})]}),n.jsxs("div",{className:"sim-shell__scenario-filter-row",role:"group","aria-label":"Filter scenarios",children:[n.jsxs("label",{className:"sim-shell__scenario-search",children:[n.jsx("span",{children:"Search scenarios"}),n.jsx("input",{type:"search",value:q,onChange:s=>Ir(s.target.value),placeholder:"Find by label, description, or tag"})]}),en.length>0?n.jsxs("div",{className:"sim-shell__scenario-tags",role:"group","aria-label":"Scenario tags",children:[en.map(s=>n.jsxs("button",{type:"button",className:"sim-shell__scenario-tag","data-active":Zs.has(s)?"true":"false","aria-pressed":Zs.has(s),onClick:()=>Or(s),children:["#",s]},s)),H.length?n.jsx("button",{type:"button",className:"sim-shell__scenario-tag sim-shell__scenario-tag--clear",onClick:Dr,children:"Clear"}):null]}):null]}),n.jsxs("div",{className:"sim-shell__actions sim-shell__actions--scenario",role:"group","aria-label":"Scenario controls",children:[n.jsx("select",{"aria-label":"Vendor preset",value:X,onChange:s=>Nr(s.target.value),children:hr.map(s=>n.jsx("option",{value:s.id,children:s.label},s.id))}),n.jsx("select",{"aria-label":"Scenario",value:L,onChange:s=>Rr(s.target.value),children:we.map(s=>n.jsx("option",{value:s.name,children:s.label},s.name))}),n.jsxs("div",{className:"sim-shell__scenario-actions",children:[n.jsx("button",{type:"button",className:"sim-shell__scenario-sync",onClick:()=>{p.name!==Qe&&window.dispatchEvent(new CustomEvent("cdc:apply-scenario-template",{detail:{id:p.name}}))},disabled:p.name===Qe,children:"Load in workspace"}),n.jsx("button",{type:"button",className:"sim-shell__scenario-download",onClick:()=>Fr(p),children:"Download JSON"}),n.jsx("button",{type:"button",className:"sim-shell__scenario-preview",onClick:()=>$r(p),children:"Preview"})]}),n.jsx("div",{className:"sim-shell__method-toggle",role:"group","aria-label":"Methods to display",children:S.map(s=>n.jsx("button",{type:"button",className:"sim-shell__method-chip","aria-pressed":M.includes(s),onClick:()=>br(s),"data-tooltip":I[s].tooltip||void 0,children:I[s].label},s))})]})]}),n.jsxs("p",{className:"sim-shell__description","aria-live":"polite",children:[n.jsxs("strong",{children:[p.label,":"]})," ",p.description]}),p.highlight&&n.jsx("p",{className:"sim-shell__description sim-shell__description--highlight","aria-live":"polite",children:p.highlight}),p.tags?.length?n.jsx("div",{className:"sim-shell__tag-row","aria-label":"Scenario tags",children:p.tags.map(s=>n.jsxs("span",{className:"sim-shell__tag-chip",children:["#",s]},s))}):null,p.stats&&n.jsxs("p",{className:"sim-shell__description sim-shell__description--meta","aria-live":"polite",children:[p.stats.rows," rows · ",p.stats.ops," ops"]}),ln?n.jsx(uo,{guidance:ln}):null,n.jsx(co,{preset:U,topicExample:Es,methods:S.map(s=>({id:s,label:I[s].label,laneDescription:I[s].laneDescription,whenToUse:I[s].whenToUse,callout:I[s].callout,active:M.includes(s)}))}),n.jsxs("div",{className:"sim-shell__event-filters",role:"group","aria-label":"Event filters",children:[ce&&n.jsx("div",{className:"sim-shell__pause-banner",role:"status","aria-live":"polite",children:"Apply paused. Resume to drain the event bus."}),n.jsxs("label",{className:"sim-shell__event-search",children:[n.jsx("span",{children:"Search events"}),n.jsx("input",{type:"search",value:xe,onChange:s=>yr(s.target.value),placeholder:"Filter by pk, seq, or payload"})]}),n.jsx("div",{className:"sim-shell__event-ops",role:"group","aria-label":"Change operations",children:et.map(s=>n.jsx("button",{type:"button",className:"sim-shell__event-op","data-active":sn.has(s)?"true":"false",onClick:()=>xr(s),children:s.toUpperCase()},s))}),n.jsx("button",{type:"button",className:"sim-shell__event-toggle",onClick:vr,children:je?"Hide timeline":"Show timeline"})]}),ys&&n.jsx(xa,{className:"sim-shell__event-log",events:mr,stats:Pr,totalCount:vs.length,filters:gr,filterOptions:fr,onFiltersChange:Cr,onDownload:kr,onClear:Tr,onCopyEvent:Mr,onReplayEvent:Ar,maxVisibleEvents:Eo}),qe&&(qe.rows.length>0||qe.placeholder)&&n.jsx("section",{className:"sim-shell__harness-history","aria-label":"Harness nightly history",children:n.jsxs("details",{children:[n.jsx("summary",{children:"Harness nightly history"}),qe.rows.length>0?n.jsx("div",{className:"sim-shell__harness-history-table-wrapper",children:n.jsxs("table",{children:[n.jsx("thead",{children:n.jsx("tr",{children:qe.headers.map(s=>n.jsx("th",{children:s},s))})}),n.jsx("tbody",{children:qe.rows.map((s,o)=>n.jsx("tr",{children:s.map((l,m)=>{const j=l.text||"—",y=l.href?n.jsx("a",{href:l.href,target:"_blank",rel:"noreferrer noopener",children:j}):j,_=l.emphasis?n.jsx("em",{children:y}):y;return n.jsx("td",{children:_},`harness-cell-${o}-${m}`)})},`harness-row-${o}`))})]})}):n.jsx("p",{className:"sim-shell__harness-history-empty",children:qe.placeholder??"No harness runs captured yet."})]})}),n.jsxs("div",{className:"sim-shell__actions",role:"group","aria-label":"Playback controls","data-tour-target":N?"comparator-actions":void 0,children:[n.jsx("button",{type:"button",onClick:Ls,disabled:Pe,children:"Start"}),n.jsx("button",{type:"button",onClick:Ts,disabled:!Pe,children:"Pause"}),n.jsxs("button",{type:"button",onClick:()=>Ms(),children:["Step +",Ie,"ms"]}),n.jsx("button",{type:"button",onClick:As,children:"Reset"}),wt&&n.jsxs("button",{type:"button",onClick:Wr,className:"sim-shell__consumer-toggle","data-tooltip":Q.backlog,children:[ce?"Resume apply":"Pause apply",at?` (${Cs} queued)`:""]}),b&&n.jsxs("label",{className:"sim-shell__apply-toggle","data-tooltip":Q.txnAtomic||void 0,children:[n.jsx("input",{type:"checkbox",checked:re,onChange:s=>At(s.target.checked)}),n.jsx("span",{children:"Apply on commit"})]}),n.jsxs("div",{className:"sim-shell__consumer-rate",role:"group","aria-label":"Apply rate limit","data-enabled":Z?"true":"false",children:[n.jsx("button",{type:"button",onClick:_r,children:Z?"Disable throttle":"Throttle apply"}),n.jsxs("label",{children:[n.jsx("span",{children:Z?`${se} events/s`:"Unlimited"}),n.jsx("input",{type:"range",min:ir,max:lr,step:xo,value:se,onChange:s=>wr(Number(s.target.value)),disabled:!Z})]})]}),n.jsxs("div",{className:"sim-shell__generator",role:"group","aria-label":"Event generator","data-enabled":ae?"true":"false",children:[n.jsx("button",{type:"button",onClick:Sr,children:ae?"Stop generator":"Start generator"}),n.jsxs("label",{children:[n.jsx("span",{children:ae?`${ne} events/s`:`Set ${ne} events/s`}),n.jsx("input",{type:"range",min:cr,max:dr,step:Vs,value:ne,onChange:s=>Er(Number(s.target.value)),disabled:!ae})]}),n.jsxs("button",{type:"button",onClick:jr,children:["Burst +",Rs]})]})]}),n.jsx("div",{className:"sim-shell__controls","aria-label":"Method tuning controls",children:S.map(s=>{const o=M.includes(s);if(s==="polling"){const m=K.polling;return n.jsxs("fieldset",{className:"sim-shell__control-card","aria-labelledby":`control-${s}`,"data-active":o?"true":"false",children:[n.jsx("legend",{id:`control-${s}`,children:I[s].label}),n.jsx("p",{className:"sim-shell__control-copy",children:"Adjust poll cadence and whether soft deletes are surfaced."}),xs?n.jsxs(n.Fragment,{children:[n.jsxs("label",{className:"sim-shell__control-field",children:[n.jsxs("span",{children:["Poll interval (",(m.pollIntervalMs/1e3).toFixed(1),"s)"]}),n.jsx("input",{type:"range",min:500,max:1e4,step:100,value:m.pollIntervalMs,onChange:j=>ut("polling","pollIntervalMs",Math.min(1e4,Math.max(500,Number(j.target.value)||500)))})]}),n.jsxs("p",{className:"sim-shell__control-hint",children:["⏱️ Polling every ",(m.pollIntervalMs/1e3).toFixed(1),"s"]})]}):n.jsxs("label",{className:"sim-shell__control-field",children:[n.jsx("span",{children:"Poll interval (ms)"}),n.jsx("input",{type:"number",min:100,step:100,value:m.pollIntervalMs,onChange:j=>ut("polling","pollIntervalMs",Math.min(1e4,Math.max(100,Number(j.target.value)||500)))})]}),n.jsxs("label",{className:"sim-shell__control-checkbox",children:[n.jsx("input",{type:"checkbox",checked:m.includeSoftDeletes,onChange:j=>ut("polling","includeSoftDeletes",j.target.checked)}),n.jsx("span",{children:"Include soft delete marker column"})]})]},s)}if(s==="trigger"){const m=K.trigger;return n.jsxs("fieldset",{className:"sim-shell__control-card","aria-labelledby":`control-${s}`,"data-active":o?"true":"false",children:[n.jsx("legend",{id:`control-${s}`,children:I[s].label}),n.jsx("p",{className:"sim-shell__control-copy",children:"Tune audit extractor cadence and per-write trigger overhead."}),n.jsxs("label",{className:"sim-shell__control-field",children:[n.jsx("span",{children:"Extractor interval (ms)"}),n.jsx("input",{type:"number",min:100,step:50,value:m.extractIntervalMs,onChange:j=>ut("trigger","extractIntervalMs",Math.max(50,Number(j.target.value)||0))})]}),n.jsxs("label",{className:"sim-shell__control-field",children:[n.jsx("span",{children:"Trigger overhead (ms)"}),n.jsx("input",{type:"number",min:0,step:1,value:m.triggerOverheadMs,onChange:j=>ut("trigger","triggerOverheadMs",Math.max(0,Number(j.target.value)||0))})]})]},s)}const l=K.log;return n.jsxs("fieldset",{className:"sim-shell__control-card","aria-labelledby":`control-${s}`,"data-active":o?"true":"false",children:[n.jsx("legend",{id:`control-${s}`,children:I[s].label}),n.jsx("p",{className:"sim-shell__control-copy",children:"Control how frequently the WAL/Binlog fetcher polls for new records."}),n.jsxs("label",{className:"sim-shell__control-field",children:[n.jsx("span",{children:"Fetch interval (ms)"}),n.jsx("input",{type:"number",min:10,step:10,value:l.fetchIntervalMs,onChange:m=>ut("log","fetchIntervalMs",Math.max(10,Number(m.target.value)||0))})]})]},s)})}),k&&O&&n.jsxs("div",{className:"sim-shell__summary","aria-live":"polite",children:[n.jsxs("ul",{children:[n.jsxs("li",{children:[n.jsx("strong",{"data-tooltip":Q.lagSpread,children:"Lag spread:"})," ",I[O.bestLag.method].label," is leading at",` ${O.bestLag.metrics.lagMs.toFixed(0)}ms`,O.lagSpread>0?` — ${I[O.worstLag.method].label} trails by ${O.lagSpread.toFixed(0)}ms`:" (no spread)"]}),n.jsxs("li",{children:[n.jsx("strong",{"data-tooltip":Q.deleteCapture,children:"Delete capture:"})," ",I[O.lowestDeletes.method].label," is lowest at",` ${O.lowestDeletes.metrics.deletesPct.toFixed(0)}%`," · best is ",I[O.highestDeletes.method].label,` (${O.highestDeletes.metrics.deletesPct.toFixed(0)}%)`]}),Ct&&n.jsxs("li",{children:[n.jsx("strong",{"data-tooltip":Q.snapshot,children:"Snapshot rows:"})," ",Ct]}),O.triggerWriteAmplification&&Se(O.triggerWriteAmplification.metrics.writeAmplification)&&n.jsxs("li",{children:[n.jsx("strong",{"data-tooltip":Q.triggerOverhead,children:"Trigger overhead:"})," ",I[O.triggerWriteAmplification.method].label," is at"," ",Xe(O.triggerWriteAmplification.metrics.writeAmplification)," ","write amplification"]}),n.jsxs("li",{children:[n.jsx("strong",{children:"Ordering:"}),O.orderingIssues.length===0?" All methods preserved ordering":` Issues: ${O.orderingIssues.map(s=>I[s].label).join(", ")}`]})]}),n.jsx("button",{type:"button",className:"sim-shell__summary-copy",onClick:Ur,children:xt?"Copied":"Copy summary"})]}),Vt.length>0&&n.jsxs("section",{className:"sim-shell__overlay-summary","aria-label":"Lane checks",children:[n.jsxs("header",{children:[n.jsx("h3",{children:"Lane checks"}),n.jsx("p",{children:"Quick glance at diff findings and lag hotspots across active capture methods."})]}),n.jsx("ul",{children:Vt.map(s=>n.jsxs("li",{className:"sim-shell__overlay-row",children:[n.jsx("div",{className:"sim-shell__overlay-label",children:s.label}),n.jsx("div",{className:"sim-shell__overlay-chips",children:s.chips.map(o=>n.jsx("span",{className:`sim-shell__overlay-chip sim-shell__overlay-chip--${o.tone}`,children:o.text},`${s.method}-${o.key}`))}),s.hasDetails&&n.jsx("button",{type:"button",className:"sim-shell__overlay-action",onClick:()=>Br(s.method),children:"Inspect"})]},s.method))})]}),pn.length>0&&n.jsx(Ea,{lanes:pn,renderSchemaWalkthrough:qr}),n.jsx("div",{className:"sim-shell__lane-grid","data-tour-target":N?"comparator-lanes":void 0,children:ee.map(({method:s,metrics:o,events:l},m)=>{const j=I[s],y=j.laneDescription,_=Ae.get(s)??null,A=m===0,D=be.get(s),R=Le.current[s],F=_e.get(s),P=F?.rows.slice(0,jo)??[],B=(F?.rows.length??0)>P.length,W=h&&lt&&F?{version:F.schemaVersion,expectedVersion:Ge,hasColumn:F.hasSchemaColumn,columnName:Je.name}:h&&lt?{version:0,expectedVersion:Ge,hasColumn:!1,columnName:Je.name}:void 0,Y=s==="trigger"?D?.writeAmplification??o.writeAmplification:void 0,te=Se(Y)?Y:void 0,z=[],ve=s==="polling"?"warning":"info";j.callout&&(s==="polling"&&o.deletesPct<100?z.push({text:`${j.callout} (${o.deletesPct.toFixed(0)}% of deletes captured in this scenario)`,tone:ve}):z.push({text:j.callout,tone:ve})),h&&p.tags?.includes("schema")&&(s==="trigger"&&typeof te=="number"&&z.push({text:`Write amplification ${Xe(te)}`,tone:"info"}),s==="log"&&z.push({text:"Log capture streams schema changes in-order, keeping downstream versions aligned.",tone:"info"}),s==="polling"&&z.push({text:"Polling picks up new columns once refreshed rows include them; expect interim nulls.",tone:"warning"})),p.tags?.includes("transactions")&&z.push({text:re?"Apply-on-commit groups transaction events before updating destinations so tables stay in sync.":"Apply-on-commit is off: events apply individually, so pausing mid-transaction shows partial state.",tone:re?"info":"warning"});const Ne=pr.get(s)??l,Ht=Ne.length!==l.length||ot.length>0||sn.size<et.length,kt=je&&Ne.length>$s,fn=je?Ne.slice(Math.max(Ne.length-$s,0)):[];return n.jsxs("article",{className:"sim-shell__lane-card",children:[n.jsxs("header",{className:"sim-shell__lane-header","data-tour-target":N&&A&&m===0?"comparator-callouts":void 0,children:[n.jsxs("div",{children:[n.jsx("h3",{className:"sim-shell__lane-title","data-tooltip":j.tooltip||void 0,children:j.label}),n.jsx("p",{className:"sim-shell__lane-copy",children:y})]}),n.jsxs("span",{className:"sim-shell__lane-count",children:[Ne.length,Ht?` / ${l.length}`:""," events"]})]}),k&&n.jsx("div",{className:"sim-shell__metrics","data-tour-target":N&&A?"comparator-metrics":void 0,children:n.jsx(ja,{...o})}),n.jsx(lo,{diff:_,scenarioName:p.name,laneId:s,schemaStatus:W}),at&&n.jsxs("section",{className:"sim-shell__lane-bus","aria-label":`${j.label} event bus`,"data-paused":ce?"true":"false",children:[n.jsxs("header",{children:[n.jsx("h4",{children:"Event Bus"}),n.jsx("span",{children:R?.topic??`cdc.${s}`})]}),n.jsxs("p",{children:[n.jsxs("span",{"data-tooltip":Q.backlog,children:["Backlog ",n.jsx("strong",{children:D?.backlog??0}),ce?" (apply paused)":""]})," · ",n.jsxs("span",{"data-tooltip":Q.offset,children:["Last offset ",D?.lastOffset??-1]})]}),n.jsxs("p",{children:["Produced ",D?.produced??0," · Consumed ",D?.consumed??0]}),n.jsxs("p",{"data-tooltip":Q.snapshot,children:["Snapshot rows ",D?.snapshotRows??0]}),n.jsxs("p",{"data-tooltip":Q.lagPercentile,children:["Lag p50 ",Math.round(D?.lagMsP50??0),"ms · p95 ",Math.round(D?.lagMsP95??0),"ms"]}),s==="trigger"&&typeof te=="number"&&n.jsxs("p",{"data-tooltip":Q.triggerWriteAmplification,children:["Write amplification: ",Xe(te)]}),s==="polling"&&n.jsxs("p",{className:"sim-shell__lane-bus-warning","data-tooltip":Q.deleteCapture,children:["Missed deletes: ",D?.missedDeletes??0]}),D&&D.errors>0&&n.jsxs("p",{className:"sim-shell__lane-bus-warning",children:["Errors: ",D.errors]})]}),F&&n.jsxs("section",{className:"sim-shell__destination","aria-label":`${j.label} destination snapshot`,children:[n.jsxs("header",{children:[n.jsxs("div",{className:"sim-shell__destination-title",children:[n.jsx("h4",{children:"Destination snapshot"}),n.jsxs("span",{children:["schema v",F.schemaVersion]})]}),n.jsx("div",{className:"sim-shell__destination-actions",children:n.jsx("button",{type:"button",className:"sim-shell__destination-download",onClick:()=>Lr(s),disabled:F.rows.length===0,children:"Download JSON"})})]}),P.length>0?n.jsx("div",{className:"sim-shell__destination-table",role:"table",children:n.jsxs("table",{children:[n.jsx("thead",{children:n.jsx("tr",{children:F.columns.map(G=>n.jsx("th",{"data-highlight":G===Je.name?"true":void 0,children:G},G))})}),n.jsx("tbody",{children:P.map(G=>n.jsx("tr",{children:F.columns.map(ze=>n.jsx("td",{children:Mo(ze==="id"?G.displayId:ze==="table"?G.table:G.values[ze])},`${G.id}-${ze}`))},G.id))})]})}):n.jsx("p",{className:"sim-shell__destination-empty",children:"No rows applied yet."}),B&&n.jsxs("p",{className:"sim-shell__destination-note",children:["Showing ",P.length," of ",F.rows.length," rows."]})]}),n.jsxs("dl",{className:"sim-shell__lane-config",children:[s==="polling"&&(()=>{const G=K.polling;return n.jsxs(n.Fragment,{children:[n.jsxs("div",{children:[n.jsx("dt",{children:"Poll interval"}),n.jsxs("dd",{"data-tooltip":Q.pollingInterval,children:[G.pollIntervalMs," ms"]})]}),n.jsxs("div",{children:[n.jsx("dt",{children:"Soft deletes"}),n.jsx("dd",{"data-tooltip":Q.pollingSoftDeletes,children:G.includeSoftDeletes?"included":"ignored"})]})]})})(),s==="trigger"&&(()=>{const G=K.trigger;return n.jsxs(n.Fragment,{children:[n.jsxs("div",{children:[n.jsx("dt",{children:"Extractor interval"}),n.jsxs("dd",{"data-tooltip":Q.triggerExtractorInterval,children:[G.extractIntervalMs," ms"]})]}),n.jsxs("div",{children:[n.jsx("dt",{children:"Trigger overhead"}),n.jsxs("dd",{"data-tooltip":Q.triggerOverhead,children:[G.triggerOverheadMs," ms"]})]}),typeof te=="number"&&n.jsxs("div",{children:[n.jsx("dt",{children:"Write amplification"}),n.jsx("dd",{"data-tooltip":Q.triggerWriteAmplification,children:Xe(te)})]})]})})(),s==="log"&&(()=>{const G=K.log;return n.jsxs("div",{children:[n.jsx("dt",{children:"Fetch interval"}),n.jsxs("dd",{"data-tooltip":Q.logFetchInterval,children:[G.fetchIntervalMs," ms"]})]})})()]}),z.length>0&&n.jsx("div",{className:"sim-shell__callouts",children:z.map((G,ze)=>n.jsx("p",{className:`sim-shell__callout${G.tone==="warning"?" sim-shell__callout--warning":""}`,"data-tour-target":N&&A&&ze===0?"comparator-callouts":void 0,children:G.text},`${s}-callout-${ze}`))}),n.jsxs("section",{className:"sim-shell__lane-why","aria-label":`When to use ${j.label}`,children:[n.jsx("h4",{children:"When to use"}),n.jsx("p",{children:j.whenToUse})]}),je?n.jsxs("ul",{className:"sim-shell__event-list","aria-live":"polite",children:[kt&&n.jsx("li",{className:"sim-shell__event sim-shell__event--notice",children:n.jsxs("span",{children:["Showing latest ",$s," of ",Ne.length," matching events."]})}),fn.length===0?n.jsx("li",{className:"sim-shell__empty",children:Ht?"No events match the current filters.":"No events yet."}):fn.map(G=>n.jsxs("li",{className:`sim-shell__event${G.op==="d"?" sim-shell__event--delete":""}`,children:[n.jsx("span",{className:"sim-shell__event-op","data-op":G.op,children:G.op}),n.jsxs("span",{children:["#",G.seq," · pk=",G.pk.id]}),n.jsxs("span",{className:"sim-shell__event-target",children:["ts=",G.ts_ms,"ms"]})]},`${s}-${G.seq}`))]}):n.jsx("p",{className:"sim-shell__lane-hidden",children:"Timeline hidden. Use “Show timeline” to view recent events."})]},s)})}),n.jsxs("footer",{className:"sim-shell__footer",children:["Scenario clock: ",le,"ms · ",ee.reduce((s,o)=>s+o.events.length,0)," total events emitted"]})]})}function zn(){if(typeof window>"u")return;const e=window.telemetry;if(e&&typeof e.track=="function"&&typeof e.flush=="function")return e;let t;try{t=window.localStorage}catch{t=void 0}const r=$a({storage:t,console:typeof console<"u"?{warn:console.warn.bind(console),debug:console.debug.bind(console)}:void 0});return window.telemetry=r,r}function Kn(){const e=document.getElementById("simShellRoot");if(!e){console.warn("Simulator UI shell mount point not found (simShellRoot).");return}Gr.createRoot(e).render(n.jsx(Po,{}))}document.readyState==="loading"?(zn(),document.addEventListener("DOMContentLoaded",Kn,{once:!0})):(zn(),Kn());
