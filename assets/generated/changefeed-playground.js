import{r as u,j as e,R as z}from"./event-log-widget.js";let V=0;function A(s="tx"){return V+=1,`${s}-${V.toString(36)}`}const H={partitions:3,commitDrift:!1,schemaDrift:!1,dropProbability:0,applyPolicy:"apply-on-commit",projectSchemaDrift:!0,maxApplyPerTick:4},G=["id","email","name","tier"],I="priority_flag",B=s=>{let a=0;for(let t=0;t<s.length;t+=1)a=(a*31+s.charCodeAt(t))%9973;return a},X=(s,a)=>{if(a<=0)return!1;const t=Math.floor(a*100);return B(String(s))%100<t},Z=(s,a)=>a<=1?0:B(s)%a,ee=(s,a,t)=>{if(a.type==="delete")return;const l={...s??{},...a.after??{}};return!t&&I in l&&delete l[I],l},L=(s,a,t)=>{const l=s[a.table]??{},c=l[a.pk],i=ee(c,a,t),o={...l};return i?o[a.pk]=i:delete o[a.pk],{...s,[a.table]:o}},k=(s,a)=>{let t=s,l=s.broker.partitions.map(c=>[...c]);for(const c of a){const i=Z(c.pk,s.options.partitions),o=s.options.commitDrift?B(`${c.txId}:${c.index}`)%2:0,d=[...l[i]],p=s.options.commitDrift?0:d.length;d.splice(p,0,{...c,partition:i,offset:p,availableAt:s.clockMs+o*50}),l[i]=d,t={...t,metrics:{...t.metrics,latestCommitTs:Math.max(t.metrics.latestCommitTs,c.commitTs)}}}return{...t,broker:{...t.broker,partitions:l}}},se=(s,a)=>{let t={...s.consumer,buffered:{...s.consumer.buffered}};const l=[];for(const c of a){const i=t.buffered[c.txId],o=i?{...i,events:[...i.events,c]}:{events:[c],total:c.total,commitTs:c.commitTs,lsn:c.lsn};if(s.options.applyPolicy==="apply-as-polled"){t.tables=L(t.tables,c,s.options.projectSchemaDrift),t.appliedLog=[...t.appliedLog,c],t.lastAppliedCommitTs=Math.max(t.lastAppliedCommitTs,c.commitTs);const p=o.events.length>=o.total;t.buffered=p?Object.fromEntries(Object.entries(t.buffered).filter(([f])=>f!==c.txId)):{...t.buffered,[c.txId]:o};continue}const d={...t.buffered,[c.txId]:o};if(o.events.length>=o.total){l.push({events:[...o.events].sort((r,m)=>r.index-m.index),commitTs:o.commitTs,lsn:o.lsn});const{[c.txId]:p,...f}=d;t.buffered=f}else t.buffered=d}if(s.options.applyPolicy==="apply-on-commit"){const c=[...t.ready,...l],i=[...c.map(m=>m.commitTs),...Object.values(t.buffered).map(m=>m.commitTs),...s.broker.partitions.flat().map(m=>m.commitTs)],o=i.length>0?Math.min(...i):1/0,p=c.filter(m=>m.commitTs<=o).sort((m,j)=>m.commitTs===j.commitTs?m.lsn-j.lsn:m.commitTs-j.commitTs).slice(0,s.options.maxApplyPerTick);let f={...t.tables};for(const m of p){for(const j of m.events)f=L(f,j,s.options.projectSchemaDrift);t.appliedLog=[...t.appliedLog,...m.events],t.lastAppliedCommitTs=Math.max(t.lastAppliedCommitTs,m.commitTs)}const r=c.filter(m=>!p.includes(m));t={...t,tables:f,ready:r}}return{...s,consumer:t,metrics:{...s.metrics}}},te=s=>{const a=s.broker.partitions.map(c=>[...c]),t=[],l=s.options.maxApplyPerTick*s.options.partitions+s.options.maxApplyPerTick;for(let c=0;c<a.length;c+=1){const i=a[c];let o=0;for(;i.length>0&&i[0].availableAt<=s.clockMs&&t.length<l&&o<s.options.maxApplyPerTick;){const d=i.shift();o+=1,!X(d.lsn,s.options.dropProbability)&&t.push(d)}a[c]=i}return{nextState:{...s,broker:{...s.broker,partitions:a}},delivered:t}},w=(s,a,t,l,c,i,o)=>{const d=o?.txId??A(),p=o?.commitTs??s.clockMs+100,f=s.lsn+1,r=o?.total??1,m=o?.index??0;return{event:{txId:d,lsn:f,commitTs:p,type:t,table:a,pk:l,before:i??null,after:c,schemaVersion:s.schemaVersion,index:m,total:r,availableAt:s.clockMs},nextState:{...s,lsn:f,metrics:{...s.metrics,latestCommitTs:Math.max(s.metrics.latestCommitTs,p)}}}},P=(s,a,t)=>{const l=[...s.source.rows.filter(c=>!(c.table===a&&c.id===t.id)),{table:a,id:t.id,data:t}];return{...s,source:{...s.source,rows:l}}},ae=(s,a,t)=>{const l=s.source.rows.filter(c=>!(c.table===a&&c.id===t));return{...s,source:{...s.source,rows:l}}},ce=()=>[{table:"customers",id:"C-100",data:{id:"C-100",email:"ada@example.com",name:"Ada Lovelace",tier:"gold"}},{table:"customers",id:"C-200",data:{id:"C-200",email:"lin@example.com",name:"Lin Cheng",tier:"silver"}},{table:"orders",id:"O-500",data:{id:"O-500",customer_id:"C-100",status:"processing"}}],R=s=>({clockMs:0,lsn:0,schemaVersion:1,options:{...H,...s},source:{rows:ce(),log:[]},broker:{partitions:Array.from({length:s?.partitions??H.partitions},()=>[]),dropped:0},consumer:{tables:{},buffered:{},ready:[],lastAppliedCommitTs:0,appliedLog:[]},metrics:{latestCommitTs:0}}),C=(s,a)=>({...s,source:{...s.source,log:[...s.source.log,...a]}}),E=(s,a)=>s.options.schemaDrift?{...a,[I]:!0}:a,F=(s,a)=>{const t=`C-${500+a}`,l={id:t,email:`user${a}@example.com`,name:`Customer ${a}`,tier:a%2===0?"gold":"silver"},c=E(s,l);return w(s,"customers","insert",t,c)},le=(s,a,t)=>{const l=A(),c=s.clockMs+120,i=1+t,o=`O-${800+s.lsn}`;let d=s;const{event:p,nextState:f}=w(d,"orders","insert",o,E(d,{id:o,customer_id:a,status:"created"}),null,{txId:l,commitTs:c,total:i,index:0});d=f;const r=[p];for(let m=0;m<t;m+=1){const{event:j,nextState:b}=w(d,"order_items","insert",`${o}-ITEM-${m+1}`,E(d,{id:`${o}-ITEM-${m+1}`,order_id:o,sku:`SKU-${m+1}`,qty:1}),null,{txId:l,commitTs:c,total:i,index:m+1});d=b,r.push(j)}return{events:r,nextState:d}},ne=s=>{const a=s.consumer.lastAppliedCommitTs>0?Math.max(0,s.metrics.latestCommitTs-s.consumer.lastAppliedCommitTs):0,t=s.broker.partitions.reduce((l,c)=>l+c.length,0)+Object.values(s.consumer.buffered).reduce((l,c)=>l+c.events.length,0)+s.consumer.ready.reduce((l,c)=>l+c.events.length,0);return{lagMs:a,backlog:t}};function oe(s){let a={...s.consumer.tables},t=[...s.consumer.appliedLog],l=s.consumer.lastAppliedCommitTs;for(const c of s.consumer.ready){for(const i of c.events)a=L(a,i,s.options.projectSchemaDrift);t=[...t,...c.events],l=Math.max(l,c.commitTs)}return{...s,consumer:{...s.consumer,tables:a,ready:[],buffered:{},appliedLog:t,lastAppliedCommitTs:l}}}const ie=(s,a)=>{switch(a.type){case"reset":return R({...s.options});case"seed":return R({...s.options});case"setApplyPolicy":{let t=oe(s);return{...t,options:{...t.options,applyPolicy:a.policy},consumer:{...t.consumer,buffered:{},ready:[]}}}case"setDropProbability":return{...s,options:{...s.options,dropProbability:a.probability}};case"toggleCommitDrift":return{...s,options:{...s.options,commitDrift:a.enabled}};case"toggleSchemaDrift":return{...s,options:{...s.options,schemaDrift:a.enabled},schemaVersion:a.enabled?s.schemaVersion+1:s.schemaVersion};case"setProjectSchemaDrift":return{...s,options:{...s.options,projectSchemaDrift:a.project}};case"setMaxApply":return{...s,options:{...s.options,maxApplyPerTick:a.maxApplyPerTick}};case"insertCustomers":{let t=s;const l=[],c=a.count??1;for(let i=0;i<c;i+=1){const{event:o,nextState:d}=F(t,i+1+s.source.rows.length);t=P(d,"customers",o.after??{}),l.push(o)}return t=C(t,l),k(t,l)}case"placeOrder":{const t=s.source.rows.find(d=>d.table==="customers")?.id??"C-100",l=a.items??2,{events:c,nextState:i}=le(s,t,l);let o=i;for(const d of c)o=P(o,d.table,d.after??{});return o=C(o,c),k(o,c)}case"updateCustomer":{const t=s.source.rows.find(f=>f.table==="customers"&&(!a.id||f.id===a.id));if(!t)return s;const l=E(s,{...t.data,tier:a.tier??(t.data.tier==="gold"?"platinum":"gold")}),c=a.commitTs??s.clockMs+100,{event:i,nextState:o}=w(s,"customers","update",t.id,l,t.data,{txId:A(),commitTs:c}),d=P(o,"customers",l),p=C(d,[i]);return k(p,[i])}case"deleteCustomer":{const t=s.source.rows.find(d=>d.table==="customers");if(!t)return s;const{event:l,nextState:c}=w(s,"customers","delete",t.id,null,t.data,{txId:A()}),i=ae(c,"customers",t.id),o=C(i,[l]);return k(o,[l])}case"injectBacklog":{let t=s;const l=[];for(let c=0;c<a.count;c+=1){const{event:i,nextState:o}=F(t,c+1e3+s.source.rows.length);t=P(o,"customers",i.after??{}),l.push(i)}return t=C(t,l),k(t,l)}case"tick":{const t=a.deltaMs??50;let l={...s,clockMs:s.clockMs+t};const{nextState:c,delivered:i}=te(l);return l=c,l=se(l,i),l}default:return s}},re=s=>{const{lagMs:a,backlog:t}=ne(s);return{source:s.source,broker:s.broker,consumer:s.consumer,options:s.options,metrics:{...s.metrics,lagMs:a,backlog:t}}},de=[...G,I],v=u.memo(({children:s,"data-tooltip":a})=>e.jsx("span",{className:"cf-tooltip","data-tooltip":a,children:s}));v.displayName="Tooltip";const T=u.memo(({events:s,renderEvent:a,itemHeight:t=120,maxHeight:l=600,threshold:c=50})=>{const i=u.useRef(null),[o,d]=u.useState(0),p=s.length>c,f=u.useCallback(b=>{d(b.currentTarget.scrollTop)},[]),{visibleItems:r,totalHeight:m,offsetY:j}=(()=>{if(!p)return{visibleItems:s,totalHeight:"auto",offsetY:0};const b=s.length*t,M=Math.max(0,Math.floor(o/t)-5),D=Math.min(s.length,Math.ceil((o+l)/t)+5),O=s.slice(M,D),y=M*t;return{visibleItems:O,totalHeight:b,offsetY:y}})();return e.jsx("div",{ref:i,className:`cf-event-stack ${p?"cf-event-stack--virtual":""}`,style:p?{maxHeight:`${l}px`,overflowY:"auto",position:"relative"}:void 0,onScroll:p?f:void 0,children:p?e.jsx(e.Fragment,{children:e.jsx("div",{style:{height:m,position:"relative"},children:e.jsx("div",{style:{transform:`translateY(${j}px)`},children:r.map(b=>e.jsx("div",{children:a(b)},b.lsn))})})}):s.map(b=>e.jsx("div",{children:a(b)},b.lsn))})});T.displayName="VirtualEventStack";const me=[{id:"multi-table-transaction",name:"Multi-Table Transaction",description:"Place an order that spans customers + orders tables atomically",icon:"ðŸ”—",actions:[{type:"setApplyPolicy",policy:"apply-on-commit"},{type:"toggleCommitDrift",enabled:!1},{type:"placeOrder",items:3}]},{id:"schema-drift-demo",name:"Schema Evolution",description:"Enable schema drift and insert customers with new column version",icon:"ðŸ“Š",actions:[{type:"toggleSchemaDrift",enabled:!0},{type:"setProjectSchemaDrift",project:!0},{type:"insertCustomers",count:2},{type:"updateCustomer"}]},{id:"commit-lag-demo",name:"Commit Lag & Drift",description:"See how commit drift affects event ordering and arrival times",icon:"â±ï¸",actions:[{type:"toggleCommitDrift",enabled:!0},{type:"insertCustomers",count:2},{type:"updateCustomer"},{type:"placeOrder",items:2}]},{id:"backlog-recovery",name:"Backlog Recovery",description:"Inject backlog, throttle consumer, then catch up",icon:"ðŸ”¥",actions:[{type:"injectBacklog",count:12},{type:"setMaxApply",maxApplyPerTick:1}]},{id:"fault-injection",name:"Event Drops & Faults",description:"Simulate network issues with 20% drop rate",icon:"âš ï¸",actions:[{type:"setDropProbability",probability:.2},{type:"insertCustomers",count:3},{type:"placeOrder",items:2}]},{id:"apply-policy-compare",name:"Apply Policies",description:"Compare apply-on-commit vs apply-as-polled behavior",icon:"âš¡",actions:[{type:"setApplyPolicy",policy:"apply-as-polled"},{type:"placeOrder",items:2}]}],Y=u.memo(({onRunScenario:s})=>e.jsxs("div",{className:"cf-demo-scenarios",children:[e.jsxs("div",{className:"cf-demo-scenarios__header",children:[e.jsx("h4",{className:"cf-demo-scenarios__title",children:"Guided Demos"}),e.jsx("p",{className:"cf-demo-scenarios__hint",children:"Quick scenarios to explore CDC features"})]}),e.jsx("div",{className:"cf-demo-scenarios__grid",children:me.map(a=>e.jsxs("button",{type:"button",className:"cf-demo-card",onClick:()=>s(a),title:a.description,children:[e.jsx("span",{className:"cf-demo-card__icon",children:a.icon}),e.jsx("span",{className:"cf-demo-card__name",children:a.name})]},a.id))})]}));Y.displayName="DemoScenariosPanel";const $=[.5,1,2],q=50,_=s=>`${s} ms`,J=u.memo(({type:s})=>e.jsx("span",{className:`cf-badge cf-badge--${s}`,children:s}));J.displayName="TypeBadge";const S=u.memo(({event:s,showPartition:a=!1,showAvailability:t=!1,tone:l,showSchemaVersion:c=!1,isHighlighted:i=!1,onHighlight:o})=>e.jsxs("div",{className:`cf-event-card${l?` cf-event-card--${l}`:""}${i?" cf-event-card--highlighted":""}`,onClick:()=>o?.(i?null:s.lsn),style:{cursor:o?"pointer":void 0},children:[e.jsxs("div",{className:"cf-event-card__header",children:[e.jsx(J,{type:s.type}),e.jsxs("span",{className:"cf-event-card__tx",children:["tx ",s.txId]}),c&&s.schemaVersion>1&&e.jsxs("span",{className:"cf-badge cf-badge--schema",title:`Schema version ${s.schemaVersion}`,children:["v",s.schemaVersion]})]}),e.jsxs("dl",{className:"cf-event-card__meta",children:[e.jsxs("div",{children:[e.jsx("dt",{children:e.jsx(v,{"data-tooltip":"Log Sequence Number - unique, monotonically increasing identifier ensuring event ordering",children:"lsn"})}),e.jsx("dd",{children:s.lsn})]}),e.jsxs("div",{children:[e.jsx("dt",{children:e.jsx(v,{"data-tooltip":"Database timestamp when the transaction was committed",children:"commit"})}),e.jsx("dd",{children:_(s.commitTs)})]}),e.jsxs("div",{children:[e.jsx("dt",{children:"index"}),e.jsxs("dd",{children:[s.index+1,"/",s.total]})]}),a?e.jsxs("div",{children:[e.jsx("dt",{children:"partition"}),e.jsx("dd",{children:s.partition??0})]}):null,t?e.jsxs("div",{children:[e.jsx("dt",{children:"available"}),e.jsx("dd",{children:_(s.availableAt)})]}):null]}),e.jsxs("div",{className:"cf-event-card__body",children:[e.jsx("div",{className:"cf-event-card__table",children:s.table}),e.jsxs("div",{className:"cf-event-card__pk",children:["pk ",s.pk]})]})]}));S.displayName="EventCard";const pe=s=>{if(s.source.log.length===0)return[];const a=new Map;for(const t of s.source.log){const l=a.get(t.txId);l?l.stages.source+=1:a.set(t.txId,{txId:t.txId,total:t.total,commitTs:t.commitTs,lsn:t.lsn,stages:{source:1,broker:0,buffered:0,ready:0,applied:0}})}for(const t of s.broker.partitions)for(const l of t){const c=a.get(l.txId);c&&(c.stages.broker+=1)}for(const t of Object.values(s.consumer.buffered))for(const l of t.events){const c=a.get(l.txId);c&&(c.stages.buffered+=1)}for(const t of s.consumer.ready)for(const l of t.events){const c=a.get(l.txId);c&&(c.stages.ready+=1)}for(const t of s.consumer.appliedLog){const l=a.get(t.txId);l&&(l.stages.applied+=1)}return Array.from(a.values()).sort((t,l)=>t.commitTs===l.commitTs?t.lsn-l.lsn:t.commitTs-l.commitTs).slice(-20)};function he(){const[s,a]=u.useReducer(ie,void 0,()=>R()),[t,l]=u.useState(1),[c,i]=u.useState(!0),[o,d]=u.useState(""),[p,f]=u.useState(null),r=u.useMemo(()=>({...re(s),clockMs:s.clockMs}),[s]);u.useEffect(()=>{if(!c)return;const n=window.setInterval(()=>{a({type:"tick",deltaMs:Math.round(q*t)})},Math.round(q*2/t));return()=>window.clearInterval(n)},[t,c]);const m=u.useMemo(()=>pe(r),[r]),j=u.useCallback(n=>{a({type:"setApplyPolicy",policy:n})},[]),b=u.useCallback(n=>{a({type:"toggleSchemaDrift",enabled:n})},[]),M=u.useCallback(n=>{a({type:"setProjectSchemaDrift",project:n})},[]),D=u.useCallback(n=>{d(n)},[]),O=u.useCallback(n=>{a({type:"reset"}),i(!1),f(null),n.actions.forEach((x,h)=>{setTimeout(()=>{a(x),h===n.actions.length-1&&setTimeout(()=>i(!0),500)},h*800)})},[]),y=u.useCallback(n=>{f(n)},[]),N=u.useCallback(n=>{if(!o)return n;const x=o.toLowerCase();return n.filter(h=>h.table.toLowerCase().includes(x)||h.txId.toLowerCase().includes(x)||h.pk.toString().includes(x)||h.type.toLowerCase().includes(x))},[o]),K=u.useMemo(()=>N(r.source.log).slice(-12).reverse(),[r.source.log,N]);return e.jsxs("section",{className:"cf-shell","aria-label":"Change feed playground",children:[e.jsxs("header",{className:"cf-shell__header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cf-shell__eyebrow",children:"Change Feed Playground"}),e.jsx("h3",{className:"cf-shell__title",children:"Source â†’ Change Feed â†’ Consumer"}),e.jsxs("p",{className:"cf-shell__lede",children:["Drive inserts, updates, deletes, and multi-table transactions to watch ordering, drift, and apply policies across the pipeline.",p!==null&&e.jsxs("span",{className:"cf-flow-hint",children:[" ","ðŸ’¡ ",e.jsxs("strong",{children:["Tracking LSN ",p]})," across lanes (click event to deselect)"]})]})]}),e.jsxs("div",{className:"cf-shell__metrics",role:"status","aria-live":"polite",children:[e.jsxs("div",{className:"cf-metric",children:[e.jsx("span",{className:"cf-metric__label",children:"Lag"}),e.jsx("span",{className:"cf-metric__value",children:_(r.metrics.lagMs)})]}),e.jsxs("div",{className:"cf-metric",children:[e.jsx("span",{className:"cf-metric__label",children:"Backlog"}),e.jsx("span",{className:"cf-metric__value",children:r.metrics.backlog})]}),e.jsxs("div",{className:"cf-metric",children:[e.jsx("span",{className:"cf-metric__label",children:"Dropped"}),e.jsx("span",{className:"cf-metric__value",style:{color:r.broker.dropped>0?"var(--cf-danger)":void 0},children:r.broker.dropped})]})]})]}),e.jsxs("div",{className:"cf-toolbar",role:"group","aria-label":"Playground controls",children:[e.jsxs("div",{className:"cf-toolbar__row",children:[e.jsxs("label",{className:"cf-field cf-field--search",children:[e.jsx("span",{className:"cf-field__label",children:"ðŸ”"}),e.jsx("input",{type:"text",placeholder:"Filter events (table, tx, pk, type)",value:o,onChange:n=>D(n.target.value),"aria-label":"Filter events by table, transaction ID, primary key, or type"}),o&&e.jsx("button",{type:"button",className:"cf-field__clear",onClick:()=>D(""),"aria-label":"Clear filter",children:"Ã—"})]}),e.jsxs("label",{className:"cf-field",children:[e.jsx("span",{className:"cf-field__label",children:"Speed"}),e.jsx("input",{type:"range",min:0,max:$.length-1,step:1,value:$.indexOf(t),onChange:n=>l($[Number(n.target.value)]??1),"aria-valuetext":`${t}x`}),e.jsxs("span",{className:"cf-field__value",children:[t,"x"]})]}),e.jsxs("label",{className:"cf-field",children:[e.jsx("span",{className:"cf-field__label",children:e.jsx(v,{"data-tooltip":"When to apply changes: on-commit waits for full transaction, as-polled applies each event immediately",children:"Apply policy"})}),e.jsxs("select",{value:r.options.applyPolicy,onChange:n=>j(n.target.value),children:[e.jsx("option",{value:"apply-on-commit",children:"Apply on commit"}),e.jsx("option",{value:"apply-as-polled",children:"Apply as polled"})]})]}),e.jsxs("label",{className:"cf-field cf-field--toggle",children:[e.jsx("input",{type:"checkbox",checked:r.options.commitDrift,onChange:n=>a({type:"toggleCommitDrift",enabled:n.target.checked})}),e.jsx("span",{children:e.jsx(v,{"data-tooltip":"Simulates delays between transaction commit and events appearing in the change feed",children:"Commit drift"})})]}),e.jsxs("label",{className:"cf-field cf-field--toggle",children:[e.jsx("input",{type:"checkbox",checked:r.options.schemaDrift,onChange:n=>b(n.target.checked)}),e.jsx("span",{children:e.jsx(v,{"data-tooltip":"Simulates schema evolution where events contain different column versions",children:"Schema drift"})})]}),e.jsxs("label",{className:"cf-field cf-field--toggle",children:[e.jsx("input",{type:"checkbox",checked:r.options.projectSchemaDrift,onChange:n=>M(n.target.checked)}),e.jsx("span",{children:"Project drifted column"})]}),e.jsxs("label",{className:"cf-field",children:[e.jsx("span",{className:"cf-field__label",children:"Faults (drop %)"}),e.jsx("input",{type:"range",min:0,max:.4,step:.05,value:r.options.dropProbability,onChange:n=>a({type:"setDropProbability",probability:Number(n.target.value)}),"aria-valuetext":`${Math.round(r.options.dropProbability*100)}%`}),e.jsxs("span",{className:"cf-field__value",children:[Math.round(r.options.dropProbability*100),"%"]})]}),e.jsxs("div",{className:"cf-toolbar__actions",children:[e.jsx("button",{type:"button",onClick:()=>i(n=>!n),"aria-label":c?"Pause simulation":"Resume simulation",children:c?"Pause":"Resume"}),e.jsx("button",{type:"button",onClick:()=>a({type:"reset"}),children:"Reset & Seed"})]})]}),e.jsx("div",{className:"cf-toolbar__row",children:e.jsxs("div",{className:"cf-toolbar__actions",children:[e.jsx("button",{type:"button",onClick:()=>a({type:"insertCustomers",count:1}),children:"Insert customers"}),e.jsx("button",{type:"button",onClick:()=>a({type:"placeOrder",items:2}),children:"Place order"}),e.jsx("button",{type:"button",onClick:()=>a({type:"updateCustomer"}),children:"Update customer"}),e.jsx("button",{type:"button",onClick:()=>a({type:"deleteCustomer"}),children:"Delete customer"}),e.jsx("button",{type:"button",onClick:()=>a({type:"injectBacklog",count:8}),children:"Inject backlog"}),e.jsx("button",{type:"button",onClick:()=>a({type:"setMaxApply",maxApplyPerTick:1}),children:"Throttle"}),e.jsx("button",{type:"button",onClick:()=>a({type:"setMaxApply",maxApplyPerTick:12}),children:"Catch up"})]})})]}),e.jsx(Y,{onRunScenario:O}),e.jsxs("div",{className:"cf-lanes",role:"group","aria-label":"Change feed lanes",children:[e.jsxs("div",{className:"cf-lane",children:[e.jsxs("header",{className:"cf-lane__header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cf-lane__eyebrow",children:"Source"}),e.jsx("h4",{className:"cf-lane__title",children:"Rows & captured events"})]}),e.jsxs("div",{className:"cf-lane__meta",children:[e.jsxs("span",{children:[r.source.rows.length," rows"]}),e.jsxs("span",{children:[r.source.log.length," events"]})]})]}),e.jsxs("div",{className:"cf-lane__body",children:[e.jsx("div",{className:"cf-grid cf-grid--rows",children:de.map(n=>e.jsx("span",{className:"cf-chip",children:n},n))}),e.jsxs("div",{className:"cf-table",children:[e.jsx("div",{className:"cf-table__header",children:"Latest rows"}),e.jsx("div",{className:"cf-table__body",children:r.source.rows.slice(-5).map(n=>e.jsxs("div",{className:"cf-table__row",children:[e.jsx("span",{className:"cf-table__cell",children:n.table}),e.jsx("span",{className:"cf-table__cell",children:n.id}),e.jsx("span",{className:"cf-table__cell",children:JSON.stringify(n.data)})]},`${n.table}-${n.id}`))})]}),e.jsx(T,{events:K,renderEvent:n=>e.jsx(S,{event:n,showSchemaVersion:r.options.schemaDrift,isHighlighted:p===n.lsn,onHighlight:y},`source-${n.lsn}`),threshold:30,maxHeight:500})]})]}),e.jsxs("div",{className:"cf-lane",children:[e.jsxs("header",{className:"cf-lane__header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cf-lane__eyebrow",children:"Change feed"}),e.jsx("h4",{className:"cf-lane__title",children:"Broker partitions"})]}),e.jsxs("div",{className:"cf-lane__meta",children:[e.jsxs("span",{children:[r.broker.partitions.length," partitions"]}),r.metrics.backlog>0&&e.jsxs("span",{className:"cf-badge-backlog",role:"status","aria-live":"polite",children:["ðŸ”¥ ",r.metrics.backlog," backlog"]})]})]}),e.jsx("div",{className:"cf-lane__body",children:e.jsx("div",{className:"cf-partitions",children:r.broker.partitions.map((n,x)=>{const h=N(n);return e.jsxs("div",{className:"cf-partition",children:[e.jsxs("div",{className:"cf-partition__header",children:["Partition ",x]}),e.jsxs("div",{className:"cf-partition__queue",children:[h.length===0?e.jsx("p",{className:"cf-empty",children:o?"no matches":"idle"}):null,h.length>0&&e.jsx(T,{events:h,renderEvent:g=>e.jsx(S,{event:g,showPartition:!0,showAvailability:!0,showSchemaVersion:r.options.schemaDrift,tone:"muted",isHighlighted:p===g.lsn,onHighlight:y},`broker-${g.lsn}`),threshold:20,maxHeight:400})]})]},`partition-${x}`)})})})]}),e.jsxs("div",{className:"cf-lane",children:[e.jsxs("header",{className:"cf-lane__header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cf-lane__eyebrow",children:"Consumer"}),e.jsx("h4",{className:"cf-lane__title",children:"Buffered vs applied"})]}),e.jsxs("div",{className:"cf-lane__meta",children:[e.jsxs("span",{children:[r.consumer.appliedLog.length," applied"]}),e.jsxs("span",{children:[Object.keys(r.consumer.tables).length," tables"]}),r.metrics.lagMs>0&&e.jsxs("span",{className:`cf-badge-lag ${r.metrics.lagMs<200?"cf-badge-lag--low":r.metrics.lagMs<500?"cf-badge-lag--medium":""}`,role:"status","aria-live":"polite",title:"Time delay between source commit and consumer application",children:["â±ï¸ ",e.jsx(v,{"data-tooltip":"Time delay between source commit and consumer application",children:_(r.metrics.lagMs)})," lag"]})]})]}),e.jsxs("div",{className:"cf-lane__body",children:[e.jsxs("div",{className:"cf-buffered",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cf-subtitle",children:"Buffered"}),(()=>{const n=Object.values(r.consumer.buffered).flatMap(g=>N(g.events)),x=r.consumer.ready.flatMap(g=>g.events).length===0&&Object.values(r.consumer.buffered).flatMap(g=>g.events).length===0,h=o&&n.length===0;return e.jsx("div",{className:"cf-event-stack",children:x?e.jsx("p",{className:"cf-empty",children:"No buffered events"}):h?e.jsx("p",{className:"cf-empty",children:"No matching buffered events"}):n.length>0?e.jsx(T,{events:n,renderEvent:g=>e.jsx(S,{event:g,showSchemaVersion:r.options.schemaDrift,tone:"muted",isHighlighted:p===g.lsn,onHighlight:y},`buffered-${g.lsn}`),threshold:20,maxHeight:400}):null})})()]}),e.jsxs("div",{children:[e.jsx("p",{className:"cf-subtitle",children:"Applied"}),(()=>{const n=N(r.consumer.appliedLog.slice(-12)),x=o&&n.length===0;return e.jsx("div",{className:"cf-event-stack",children:x?e.jsx("p",{className:"cf-empty",children:"No matching applied events"}):n.length>0?e.jsx(T,{events:n,renderEvent:h=>e.jsx(S,{event:h,showSchemaVersion:r.options.schemaDrift,tone:"active",isHighlighted:p===h.lsn,onHighlight:y},`applied-${h.lsn}`),threshold:20,maxHeight:400}):null})})()]})]}),e.jsxs("div",{className:"cf-table",children:[e.jsx("div",{className:"cf-table__header",children:"Consumer tables"}),e.jsx("div",{className:"cf-table__body",children:Object.entries(r.consumer.tables).map(([n,x])=>e.jsxs("div",{className:"cf-table__row cf-table__row--nested",children:[e.jsx("span",{className:"cf-table__cell",children:n}),e.jsxs("span",{className:"cf-table__cell cf-table__cell--muted",children:[Object.keys(x).length," rows"]}),e.jsx("div",{className:"cf-table__nested",children:Object.values(x).slice(-4).map((h,g)=>e.jsxs("div",{className:"cf-table__nested-row",children:[e.jsx("span",{children:h.id??"row"}),e.jsx("span",{className:"cf-table__cell--muted",children:JSON.stringify(h)})]},h.id??`${n}-${g}`))})]},n))})]})]})]})]}),e.jsxs("section",{className:"cf-transactions","aria-label":"Transaction atomicity",children:[e.jsxs("header",{className:"cf-transactions__header",children:[e.jsxs("div",{children:[e.jsx("p",{className:"cf-lane__eyebrow",children:"Transactions"}),e.jsx("h4",{className:"cf-lane__title",children:"Atomicity across lanes"}),e.jsx("p",{className:"cf-transactions__hint",children:"Each bracket shows how many events from a transaction are visible in the source log, broker partitions, buffered pool, and applied tables."})]}),e.jsxs("span",{className:"cf-clock",children:["Clock ",_(r.clockMs)]})]}),e.jsxs("div",{className:"cf-transaction-list",children:[m.length===0?e.jsx("p",{className:"cf-empty",children:"Run an operation to see transactions"}):null,m.map(n=>{const x=Math.min(1,n.stages.applied/n.total),h=n.stages.buffered+n.stages.ready,g=n.stages.applied===n.total,Q=n.stages.applied>0&&n.stages.applied<n.total,W=`cf-transaction${g?" cf-transaction--complete":""}${Q?" cf-transaction--partial":""}`;return e.jsxs("div",{className:W,children:[e.jsxs("div",{className:"cf-transaction__meta",children:[e.jsxs("span",{className:"cf-transaction__tx",children:["tx ",n.txId]}),e.jsxs("span",{className:"cf-transaction__commit",children:["commit ",_(n.commitTs)]}),e.jsxs("span",{className:"cf-transaction__total",children:[n.total," events"]})]}),e.jsxs("div",{className:"cf-transaction__stages",role:"list",children:[e.jsxs("div",{className:"cf-transaction__stage",role:"listitem",children:[e.jsx("span",{className:"cf-stage__label",children:"source"}),e.jsx("span",{className:"cf-stage__value",children:n.stages.source})]}),e.jsxs("div",{className:"cf-transaction__stage",role:"listitem",children:[e.jsx("span",{className:"cf-stage__label",children:"broker"}),e.jsx("span",{className:"cf-stage__value",children:n.stages.broker})]}),e.jsxs("div",{className:"cf-transaction__stage",role:"listitem",children:[e.jsx("span",{className:"cf-stage__label",children:"buffered"}),e.jsx("span",{className:"cf-stage__value",children:h})]}),e.jsxs("div",{className:"cf-transaction__stage",role:"listitem",children:[e.jsx("span",{className:"cf-stage__label",children:"applied"}),e.jsx("span",{className:"cf-stage__value",children:n.stages.applied})]})]}),e.jsxs("div",{className:"cf-transaction__progress",children:[e.jsx("span",{className:"cf-progress",role:"progressbar","aria-label":"Applied progress","aria-valuenow":n.stages.applied,"aria-valuemin":0,"aria-valuemax":n.total,style:{width:`${x*100}%`}}),e.jsx("span",{className:"cf-progress cf-progress--buffered",role:"progressbar","aria-label":"Buffered progress","aria-valuenow":h,"aria-valuemin":0,"aria-valuemax":n.total,style:{width:`${Math.min(1,h/n.total)*100}%`}})]})]},n.txId)})]})]})]})}function U(){const s=document.getElementById("changefeedPlaygroundRoot");if(!s){console.warn("Change feed playground mount point with id 'changefeedPlaygroundRoot' not found in the DOM. Ensure the HTML contains this element before loading the script.");return}z.createRoot(s).render(e.jsx(he,{}))}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",U,{once:!0}):U();
